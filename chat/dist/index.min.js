var A=(l,e,t)=>{if(!e.has(l))throw TypeError("Cannot "+t)};var o=(l,e,t)=>(A(l,e,"read from private field"),t?t.call(l):e.get(l)),u=(l,e,t)=>{if(e.has(l))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(l):e.set(l,t)},f=(l,e,t,r)=>(A(l,e,"write to private field"),r?r.call(l,t):e.set(l,t),t);var E=(l,e,t)=>(A(l,e,"access private method"),t);var g=class{constructor(){this.callbacks={}}on(e,t){this.callbacks[e]=t}dispatch(e,t){let r=this.callbacks[e];r&&r(t)}off(e){this.callbacks[e]&&delete this.callbacks[e]}clearAllEvents(){this.callbacks={}}cleaEvents(e){e.forEach(t=>{this.off(t)})}};var w=(l=21)=>{let e="1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",t=e.length,r=[];for(let n=0;n<l;n++)r.push(e[Math.round(Math.random()*100)%t]);return r.join("")},U=(l,e)=>{let t=l.reduce((r,n)=>r.set(n[e],[...r.get(n[e])||[],n]),new Map);return Object.fromEntries(t)},D=l=>{try{return JSON.parse(l)}catch{return null}},x=l=>({date:new Date(Number(BigInt(l)>>22n))}),R=l=>(BigInt(l.getTime())<<22n).toString();var h,T,S,j,J=class{constructor(e){u(this,S);u(this,h,void 0);u(this,T,void 0);f(this,h,e),this.eventEmmiter=new g,f(this,T,[]),E(this,S,j).call(this)}onOpen(){for(this.eventEmmiter.dispatch("transportReady",{});o(this,T).length>0;){let e=o(this,T).pop();e&&o(this,h).send(e)}}waitOpen(){return new Promise((t,r)=>{let n="transportReady",i=setTimeout(()=>{this.eventEmmiter.off(n),r(new Error("ConnectionTimeout"))},1e4);this.eventEmmiter.on(n,()=>{this.eventEmmiter.off(n),clearTimeout(i),t(!0)})})}onClose(){}onError(e){console.error("transport disconected")}onMessage(e){let t;try{t=new b(e.data).parse()}catch(r){console.log("message parser error",r);return}if(t?.type==="message")this.eventEmmiter.dispatch("message",t.data);else if(t?.type==="reply"){if(t.reply){let{channel_trail:r,data_back:n}=t.reply;this.eventEmmiter.dispatch(`reply:${r}`,n)}}else if(t?.type==="error"){let{command:r,data:n}=t.data;this.eventEmmiter.dispatch(r,n)}else{let{command:r,data:n}=t.data;this.eventEmmiter.dispatch(r,n)}}__encMsg(e){let t=new TextEncoder().encode(e);return{len:t.byteLength,view:t}}send(e){let t=new TextEncoder().encode(e);o(this,h).send(t)}cend(e,t,r=!0){let n=JSON.stringify(t),i=w(12),{len:a,view:s}=this.__encMsg(n),c=`#${e}\r
@${i}\r
$${a}\r
`,d=new Uint8Array(c.length+a+2);return d.set(new TextEncoder().encode(c)),d.set(s,c.length),d.set(`\r
`.split("").map(k=>k.charCodeAt(0)),d.length-2),o(this,h).send(d),r?this.sendPromise(`${e}:${i}`,1e4):new Promise((k,F)=>{k(!0)})}cendBin(e,t){let r=w(12),n=t.byteLength,i=`#${e}\r
@${r}\r
%${n}\r
`,a=new Uint8Array(i.length+n+2);return a.set(new TextEncoder().encode(i)),a.set(t,i.length),a.set(`\r
`.split("").map(s=>s.charCodeAt(0)),a.length-2),o(this,h).send(a),this.sendPromise(`${e}:${r}`,1e4)}sendm(e,t){let r=w(12),n=JSON.stringify(t),{len:i,view:a}=this.__encMsg(n),s=`>${e}\r
@${r}\r
$${i}\r
`,c=new Uint8Array(s.length+i+2);return c.set(new TextEncoder().encode(s)),c.set(a,s.length),c.set(`\r
`.split("").map(d=>d.charCodeAt(0)),c.length-2),o(this,h).send(c),this.sendPromise(`reply:${e}:${r}`,1e4)}sendPromise(e,t=0){return new Promise((n,i)=>{let a=setTimeout(()=>{},0);t>0&&(a=setTimeout(()=>{this.eventEmmiter.off(e),i(new Error("Timeout"))},t)),this.eventEmmiter.on(e,s=>{if(this.eventEmmiter.off(e),clearTimeout(a),typeof s=="string"){let c=JSON.parse(s);c.error&&i(new Error(c.error)),n(c)}else typeof s=="object"&&s?.byteLength!==void 0&&n(s)})})}on(e,t){this.eventEmmiter.on(e,t)}disconnect(){return o(this,h).close(),!0}};h=new WeakMap,T=new WeakMap,S=new WeakSet,j=function(){o(this,h).binaryType="arraybuffer",o(this,h).onmessage=e=>this.onMessage(e),o(this,h).onerror=e=>this.onError(e),o(this,h).onclose=()=>this.onClose(),o(this,h).onopen=()=>this.onOpen()};var y,M,q,B=class{constructor(e){u(this,M);u(this,y,void 0);this.eventEmmiter=new g,f(this,y,e),E(this,M,q).call(this)}waitOpen(){return o(this,y).ready.then(()=>!0).catch(e=>!1)}send(e){console.log("send -> ",e),o(this,y).createUnidirectionalStream().then(t=>{this.writeTo(e,t,!0)}).catch(t=>{console.error("error creating a new stream")})}cend(e,t,r=!0){let n=JSON.stringify(t),i=w(12),a=`#${e}\r
@${i}\r
$${n.length}\r
${n}\r
`;return this.send(a),this.sendPromise(`${e}:${i}`,1e4)}cendBin(e,t){let r=w(12),n=t.byteLength,i=`#${e}\r
@${r}\r
$${n}\r
$`,s=new TextEncoder().encode(i),c=s.byteLength+n,d=new Uint8Array(c);return d.set(s,0),d.set(t,s.byteLength),console.log(d),this.sendPromise(`${e}:${r}`,1e4)}sendm(e,t){let r=w(12),n=JSON.stringify(t);return n=`>${e}\r
@${r}\r
$${n.length}\r
${n}\r
`,this.send(n),this.sendPromise(`reply:${e}:${r}`,1e4)}disconnect(){return o(this,y).close(),!0}on(e,t){this.eventEmmiter.on(e,t)}sendPromise(e,t=0){return new Promise((n,i)=>{let a=setTimeout(()=>{},0);t>0&&(a=setTimeout(()=>{this.eventEmmiter.off(e),i(new Error("Timeout"))},t)),this.eventEmmiter.on(e,s=>{this.eventEmmiter.off(e),clearTimeout(a);let c=JSON.parse(s);c.error&&i(new Error(c.error)),n(c)})})}writeTo(e,t,r=!1){console.log(t);let n=t.getWriter(),a=new TextEncoder().encode(e,{stream:!0});n.write(a).then(()=>{console.log("written")}).catch(s=>{console.error("error writing",s)}),r&&n.ready.then(()=>{n.close().then(()=>{console.log("writer closed")}).catch(s=>{console.error("error closing writer",s)})})}async readFrom(e){let t=e.getReader();try{for(;;){let{value:r,done:n}=await t.read();if(n){console.log("[readFrom] stream was closed");return}this.onMessage(r.buffer)}}catch(r){console.error("[readFrom] error while reading from stream",r)}}async acceptUnidirectionalstreams(){let e=o(this,y).incomingUnidirectionalStreams.getReader();try{for(;;){let{value:t,done:r}=await e.read();if(r){console.log("done accepting unidirectional streams");return}this.readFrom(t)}}catch{console.error("error in uni accept loop")}}onMessage(e){let t=new b(e).parse();if(console.log("got a message fr",t),t?.type==="message")this.eventEmmiter.dispatch("message",t.data);else if(t?.type==="reply"){if(t.reply){let{channel_trail:r,data_back:n}=t.reply;this.eventEmmiter.dispatch(`reply:${r}`,n)}}else if(t?.type==="error"){let{command:r,data:n}=t.data;this.eventEmmiter.dispatch(r,n)}else{let{command:r,data:n}=t.data;this.eventEmmiter.dispatch(r,n)}}};y=new WeakMap,M=new WeakSet,q=function(){o(this,y).closed.then(()=>{}).catch(t=>{});let e=o(this,y).createUnidirectionalStream().then(t=>{}).catch(t=>{});this.acceptUnidirectionalstreams()};var _=class{static enqueue(e){return new Promise((t,r)=>{this.queue.push({promise:e,resolve:t,reject:r}),this.dequeue()})}static dequeue(){if(this.workingOnPromise)return!1;if(this.stop){this.queue=[],this.stop=!1;return}let e=this.queue.shift();if(!e)return!1;try{this.workingOnPromise=!0,e.promise().then(t=>{this.workingOnPromise=!1,e.resolve(t),this.dequeue()}).catch(t=>{this.workingOnPromise=!1,e.reject(t),this.dequeue()})}catch(t){this.workingOnPromise=!1,e.reject(t),this.dequeue()}return!0}};_.queue=[],_.pendingPromise=!1,_.stop=!1;var b=class{constructor(e){this.raw=e,this.data=new DataView(e),this.position=0,this.len=this.data.byteLength,this.remaining=this.data.byteLength}parse(){switch(this.getByte()){case"-":this.getBlock();let t=this.bulkText();if(!t)throw"parseFail";return{type:"error",data:{info:JSON.parse(new TextDecoder().decode(t.res))}};case">":let n=this.strBlock().split(":");if(n.length!=2)throw"parseFail";let[i,a]=n;if(this.getByte()!=="@")throw"parseFail";let c=this.strBlock(),d=this.bulkText();if(!d)throw"parseFail";return{type:"message",data:{channel:i,sender:a,message_id:c,text:new TextDecoder().decode(d.res)}};case"<":let k=this.strBlock(),F=this.bulkText();if(!F)throw"parseFail";return{type:"reply",reply:{channel_trail:k,data_back:new TextDecoder().decode(F.res)}};case"#":let L=this.strBlock(),$=this.bulkText();if(!$)throw"parseFail";return $.isBin?{type:"command",data:{command:L,data:$.res}}:{type:"command",data:{command:L,data:new TextDecoder().decode($.res)}};default:throw"parseFail"}}getByte(){if(!this.len)return 0;let e=this.data.getUint8(this.position);return this.position+=1,String.fromCodePoint(e)}getBlock(){let e=this.position,t=this.len-1;for(let r=e;r<=t;r++){let n=i=>this.data.getUint8(i);if(n(r)===13&&n(r+1)===10){let i=this.raw.slice(e,r);return this.position=r+2,i}}return new ArrayBuffer(0)}bulkText(){let e=this.getByte();if(e!="$"&&e!="%")return null;let t=parseInt(this.strBlock());if(isNaN(t))return null;let r=t+2;return this.remaining<r?null:{isBin:e==="%",res:this.getBlock()}}strBlock(){let e=this.getBlock();return new TextDecoder().decode(e)}},P=class{parseContent(e){let t={},r=e.split("\r	");if(t.text=r[0],r[1]){let n=D(r[1]);n&&(t.media=n)}return r[2]&&(t.meta=r[2]),t}messageParser(e){return e.messages.map(t=>{let r=this.parseContent(t.content),{date:n}=x(t.id),i={userId:t.sender_id,channelId:t.channel_id,messageId:t.id,content:r,timestamp:n,type:"message"};return i.userId==="_"&&(i.type="activity",i.activity=JSON.parse(t.content),i.content={}),i})}};var m,C=class{constructor(e){u(this,m,void 0);f(this,m,e)}async create(e){return o(this,m).cend("channel:create",e)}async get(e){return o(this,m).cend("channel:info",e)}async delete(e){return o(this,m).cend("channel:delete",e)}async update(e){return o(this,m).cend("channel:update",e)}async join(e){return o(this,m).cend("channel:join",e)}async leave(e){return o(this,m).cend("channel:leave",e)}async getMembers(e){return o(this,m).cend("channel:users",{channel:e})}async addMembers(e,t){let r=[];return typeof t=="string"&&(t=[t]),r=[...t],o(this,m).cend("channel:add",{channel_id:e,user_ids:r})}async removeMembers(e,t){let r=[];return typeof t=="string"&&(t=[t]),r=[...t],o(this,m).cend("channel:remove",{channel_id:e,user_ids:r})}async moderate(e,t){let r=[];return typeof t.users=="string"?r=[t.users]:r=t.users,o(this,m).cend("channel:moderate",{channel_id:e,mode:t.mode,users:r})}async getMessages(e,t=50,r=void 0,n="forward"){return r||(r=[]),typeof e!="string"&&(e=R(e)),new Promise((i,a)=>{o(this,m)?.cend("channel:state",{channels:r,start:e,limit:t,direction:n}).then(s=>{s.error&&a(s.error);let c=new P().messageParser(s);i(U(c,"channelId"))}).catch(s=>{a(s)})})}async list(e,t=!1){return e||(e={}),t?o(this,m).cend("channel:list",e):o(this,m).cend("channel:get",e)}};m=new WeakMap;var p,v,O,z,I,W,N=class{constructor(e){u(this,O);u(this,I);u(this,p,void 0);u(this,v,void 0);f(this,p,e),f(this,v,new g),this.channels=new C(e),E(this,O,z).call(this)}on(e,t){o(this,v).on(e,t)}async send(e,t,r){return new Promise(async(n,i)=>{let a;if(typeof t=="string")a={text:t,type:"Text"};else{let c=[];t.text?a={inner:{text:t.text,type:"Text"},res_to:t.replyTo}:a={inner:{data:t.data,type:"Data"},res_to:t.replyTo},c.length>0&&(a=a.files=c)}let s=await o(this,p).sendm(e,a).then(c=>c).catch(c=>({error:c}));return s.error?i(s):n(s)})}async react(e,t,r){return new Promise(async(n,i)=>{let a={inner:{reaction:r,type:"Reaction"},res_to:t},s=await o(this,p).sendm(e,a).then(c=>c).catch(c=>({error:c}));return s.error?i(s):n(s)})}async editMessage(e,t,r){return o(this,p).cend("message:edit",{channel_id:e,id:t,content:r})}async deleteMessage(e,t,r=!0){let n="";return r&&(n="soft"),o(this,p).cend("message:delete",{channel_id:e,id:t,content:n})}static pluginId(){return"chats"}};p=new WeakMap,v=new WeakMap,O=new WeakSet,z=function(){o(this,p).on("message",e=>{let{date:t}=x(e.message_id),r=new P().parseContent(e.text),n={userId:e.sender,channelId:e.channel,messageId:e.message_id,content:r,timestamp:t,type:"message"};o(this,v).dispatch("message",n)}),o(this,p).on("notify",e=>{e=JSON.parse(e);let{date:t}=x(e.message_id);o(this,v).dispatch("activity",{channelId:e.channel_id,activityId:e.message_id,timestamp:t,info:e.info})})},I=new WeakSet,W=async function(e,t){let r={};for(let s of e)r[s.name]=s;let n=Object.values(r).map(s=>({name:s.name,ftype:s.type,size:s.size})),i=await o(this,p)?.cend("files:urls",n).then(s=>s).catch(s=>({error:s})),a=[];for(let s of i.urls){if((await V(e[s.original_name],s.upload_url,t).then(d=>d).catch(d=>({error:d}))).error)return{error:"failed upload"};a.push(`${i.root}${s.new_name}`)}return{files:a}};var V=(l,e,t)=>{let r=new XMLHttpRequest;if(t){let i=new g;i.on("progress",t),r.upload.addEventListener("progress",a=>{i.dispatch("progress",{filename:"",progress:Math.round(a.loaded/a.total*100)})})}return new Promise((i,a)=>{r.open("PUT",e);let s=new FormData;s.append("file",l),r.send(s),r.addEventListener("abort",()=>{a({error:"upload arborted"})}),r.addEventListener("error",()=>{a({error:"upload error"})}),r.addEventListener("load",()=>{i(r.response)})})};export{N as default};
