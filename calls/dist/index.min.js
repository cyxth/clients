var si=Object.create;var qr=Object.defineProperty;var ii=Object.getOwnPropertyDescriptor;var ni=Object.getOwnPropertyNames;var ai=Object.getPrototypeOf,oi=Object.prototype.hasOwnProperty;var b=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var ci=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ni(e))!oi.call(r,i)&&i!==t&&qr(r,i,{get:()=>e[i],enumerable:!(s=ii(e,i))||s.enumerable});return r};var di=(r,e,t)=>(t=r!=null?si(ai(r)):{},ci(e||!r||!r.__esModule?qr(t,"default",{value:r,enumerable:!0}):t,r));var Qt=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var c=(r,e,t)=>(Qt(r,e,"read from private field"),t?t.call(r):e.get(r)),w=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},T=(r,e,t,s)=>(Qt(r,e,"write to private field"),s?s.call(r,t):e.set(r,t),t);var S=(r,e,t)=>(Qt(r,e,"access private method"),t);var Hr=b((Ga,Vr)=>{var Ie=1e3,Fe=Ie*60,Ae=Fe*60,Se=Ae*24,pi=Se*7,hi=Se*365.25;Vr.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return fi(r);if(t==="number"&&isFinite(r))return e.long?gi(r):mi(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function fi(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(!!e){var t=parseFloat(e[1]),s=(e[2]||"ms").toLowerCase();switch(s){case"years":case"year":case"yrs":case"yr":case"y":return t*hi;case"weeks":case"week":case"w":return t*pi;case"days":case"day":case"d":return t*Se;case"hours":case"hour":case"hrs":case"hr":case"h":return t*Ae;case"minutes":case"minute":case"mins":case"min":case"m":return t*Fe;case"seconds":case"second":case"secs":case"sec":case"s":return t*Ie;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function mi(r){var e=Math.abs(r);return e>=Se?Math.round(r/Se)+"d":e>=Ae?Math.round(r/Ae)+"h":e>=Fe?Math.round(r/Fe)+"m":e>=Ie?Math.round(r/Ie)+"s":r+"ms"}function gi(r){var e=Math.abs(r);return e>=Se?wt(r,e,Se,"day"):e>=Ae?wt(r,e,Ae,"hour"):e>=Fe?wt(r,e,Fe,"minute"):e>=Ie?wt(r,e,Ie,"second"):r+" ms"}function wt(r,e,t,s){var i=e>=t*1.5;return Math.round(r/t)+" "+s+(i?"s":"")}});var Gr=b((Ja,Qr)=>{function _i(r){t.debug=t,t.default=t,t.coerce=d,t.disable=n,t.enable=i,t.enabled=a,t.humanize=Hr(),t.destroy=u,Object.keys(r).forEach(l=>{t[l]=r[l]}),t.names=[],t.skips=[],t.formatters={};function e(l){let p=0;for(let h=0;h<l.length;h++)p=(p<<5)-p+l.charCodeAt(h),p|=0;return t.colors[Math.abs(p)%t.colors.length]}t.selectColor=e;function t(l){let p,h=null,f,_;function E(...m){if(!E.enabled)return;let x=E,L=Number(new Date),W=L-(p||L);x.diff=W,x.prev=p,x.curr=L,p=L,m[0]=t.coerce(m[0]),typeof m[0]!="string"&&m.unshift("%O");let Ce=0;m[0]=m[0].replace(/%([a-zA-Z%])/g,(Le,gt)=>{if(Le==="%%")return"%";Ce++;let et=t.formatters[gt];if(typeof et=="function"){let Me=m[Ce];Le=et.call(x,Me),m.splice(Ce,1),Ce--}return Le}),t.formatArgs.call(x,m),(x.log||t.log).apply(x,m)}return E.namespace=l,E.useColors=t.useColors(),E.color=t.selectColor(l),E.extend=s,E.destroy=t.destroy,Object.defineProperty(E,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(f!==t.namespaces&&(f=t.namespaces,_=t.enabled(l)),_),set:m=>{h=m}}),typeof t.init=="function"&&t.init(E),E}function s(l,p){let h=t(this.namespace+(typeof p>"u"?":":p)+l);return h.log=this.log,h}function i(l){t.save(l),t.namespaces=l,t.names=[],t.skips=[];let p,h=(typeof l=="string"?l:"").split(/[\s,]+/),f=h.length;for(p=0;p<f;p++)!h[p]||(l=h[p].replace(/\*/g,".*?"),l[0]==="-"?t.skips.push(new RegExp("^"+l.slice(1)+"$")):t.names.push(new RegExp("^"+l+"$")))}function n(){let l=[...t.names.map(o),...t.skips.map(o).map(p=>"-"+p)].join(",");return t.enable(""),l}function a(l){if(l[l.length-1]==="*")return!0;let p,h;for(p=0,h=t.skips.length;p<h;p++)if(t.skips[p].test(l))return!1;for(p=0,h=t.names.length;p<h;p++)if(t.names[p].test(l))return!0;return!1}function o(l){return l.toString().substring(2,l.toString().length-2).replace(/\.\*\?$/,"*")}function d(l){return l instanceof Error?l.stack||l.message:l}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}Qr.exports=_i});var tt=b(($,bt)=>{$.formatArgs=vi;$.save=wi;$.load=bi;$.useColors=yi;$.storage=Ci();$.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();$.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function yi(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function vi(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+bt.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,s=0;r[0].replace(/%[a-zA-Z%]/g,i=>{i!=="%%"&&(t++,i==="%c"&&(s=t))}),r.splice(s,0,e)}$.log=console.debug||console.log||(()=>{});function wi(r){try{r?$.storage.setItem("debug",r):$.storage.removeItem("debug")}catch{}}function bi(){let r;try{r=$.storage.getItem("debug")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function Ci(){try{return localStorage}catch{}}bt.exports=Gr()($);var{formatters:Ei}=bt.exports;Ei.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var Z=b(qe=>{"use strict";var Si=qe&&qe.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(qe,"__esModule",{value:!0});qe.Logger=void 0;var $e=Si(tt()),Be="mediasoup-client",Gt=class{constructor(e){e?(this._debug=(0,$e.default)(`${Be}:${e}`),this._warn=(0,$e.default)(`${Be}:WARN:${e}`),this._error=(0,$e.default)(`${Be}:ERROR:${e}`)):(this._debug=(0,$e.default)(Be),this._warn=(0,$e.default)(`${Be}:WARN`),this._error=(0,$e.default)(`${Be}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};qe.Logger=Gt});var is=b((Ka,Jt)=>{"use strict";var Ne=typeof Reflect=="object"?Reflect:null,Jr=Ne&&typeof Ne.apply=="function"?Ne.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)},Ct;Ne&&typeof Ne.ownKeys=="function"?Ct=Ne.ownKeys:Object.getOwnPropertySymbols?Ct=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Ct=function(e){return Object.getOwnPropertyNames(e)};function Ti(r){console&&console.warn&&console.warn(r)}var Kr=Number.isNaN||function(e){return e!==e};function P(){P.init.call(this)}Jt.exports=P;Jt.exports.once=Oi;P.EventEmitter=P;P.prototype._events=void 0;P.prototype._eventsCount=0;P.prototype._maxListeners=void 0;var Wr=10;function Et(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(P,"defaultMaxListeners",{enumerable:!0,get:function(){return Wr},set:function(r){if(typeof r!="number"||r<0||Kr(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");Wr=r}});P.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};P.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||Kr(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Zr(r){return r._maxListeners===void 0?P.defaultMaxListeners:r._maxListeners}P.prototype.getMaxListeners=function(){return Zr(this)};P.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var i=e==="error",n=this._events;if(n!==void 0)i=i&&n.error===void 0;else if(!i)return!1;if(i){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var d=n[e];if(d===void 0)return!1;if(typeof d=="function")Jr(d,this,t);else for(var u=d.length,l=rs(d,u),s=0;s<u;++s)Jr(l[s],this,t);return!0};function Yr(r,e,t,s){var i,n,a;if(Et(t),n=r._events,n===void 0?(n=r._events=Object.create(null),r._eventsCount=0):(n.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),n=r._events),a=n[e]),a===void 0)a=n[e]=t,++r._eventsCount;else if(typeof a=="function"?a=n[e]=s?[t,a]:[a,t]:s?a.unshift(t):a.push(t),i=Zr(r),i>0&&a.length>i&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=r,o.type=e,o.count=a.length,Ti(o)}return r}P.prototype.addListener=function(e,t){return Yr(this,e,t,!1)};P.prototype.on=P.prototype.addListener;P.prototype.prependListener=function(e,t){return Yr(this,e,t,!0)};function Pi(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Xr(r,e,t){var s={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},i=Pi.bind(s);return i.listener=t,s.wrapFn=i,i}P.prototype.once=function(e,t){return Et(t),this.on(e,Xr(this,e,t)),this};P.prototype.prependOnceListener=function(e,t){return Et(t),this.prependListener(e,Xr(this,e,t)),this};P.prototype.removeListener=function(e,t){var s,i,n,a,o;if(Et(t),i=this._events,i===void 0)return this;if(s=i[e],s===void 0)return this;if(s===t||s.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,s.listener||t));else if(typeof s!="function"){for(n=-1,a=s.length-1;a>=0;a--)if(s[a]===t||s[a].listener===t){o=s[a].listener,n=a;break}if(n<0)return this;n===0?s.shift():xi(s,n),s.length===1&&(i[e]=s[0]),i.removeListener!==void 0&&this.emit("removeListener",e,o||t)}return this};P.prototype.off=P.prototype.removeListener;P.prototype.removeAllListeners=function(e){var t,s,i;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[e]),this;if(arguments.length===0){var n=Object.keys(s),a;for(i=0;i<n.length;++i)a=n[i],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=s[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function es(r,e,t){var s=r._events;if(s===void 0)return[];var i=s[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?Ri(i):rs(i,i.length)}P.prototype.listeners=function(e){return es(this,e,!0)};P.prototype.rawListeners=function(e){return es(this,e,!1)};P.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):ts.call(r,e)};P.prototype.listenerCount=ts;function ts(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}P.prototype.eventNames=function(){return this._eventsCount>0?Ct(this._events):[]};function rs(r,e){for(var t=new Array(e),s=0;s<e;++s)t[s]=r[s];return t}function xi(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function Ri(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function Oi(r,e){return new Promise(function(t,s){function i(a){r.removeListener(e,n),s(a)}function n(){typeof r.removeListener=="function"&&r.removeListener("error",i),t([].slice.call(arguments))}ss(r,e,n,{once:!0}),e!=="error"&&ki(r,i,{once:!0})})}function ki(r,e,t){typeof r.on=="function"&&ss(r,"error",e,t)}function ss(r,e,t,s){if(typeof r.on=="function")s.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function i(n){s.once&&r.removeEventListener(e,i),t(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}});var fe=b(St=>{"use strict";Object.defineProperty(St,"__esModule",{value:!0});St.EnhancedEventEmitter=void 0;var Li=is(),Mi=Z(),ji=new Mi.Logger("EnhancedEventEmitter"),Wt=class extends Li.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}emit(e,...t){return super.emit(e,...t)}safeEmit(e,...t){let s=super.listenerCount(e);try{return super.emit(e,...t)}catch(i){return ji.error("safeEmit() | event listener threw an error [eventName:%s]:%o",e,i),Boolean(s)}}on(e,t){return super.on(e,t),this}off(e,t){return super.off(e,t),this}addListener(e,t){return super.on(e,t),this}prependListener(e,t){return super.prependListener(e,t),this}once(e,t){return super.once(e,t),this}prependOnceListener(e,t){return super.prependOnceListener(e,t),this}removeListener(e,t){return super.off(e,t),this}removeAllListeners(e){return super.removeAllListeners(e),this}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}rawListeners(e){return super.rawListeners(e)}};St.EnhancedEventEmitter=Wt});var Te=b(ze=>{"use strict";Object.defineProperty(ze,"__esModule",{value:!0});ze.InvalidStateError=ze.UnsupportedError=void 0;var rt=class extends Error{constructor(e){super(e),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,rt):this.stack=new Error(e).stack}};ze.UnsupportedError=rt;var st=class extends Error{constructor(e){super(e),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,st):this.stack=new Error(e).stack}};ze.InvalidStateError=st});var Ve=b(Ue=>{"use strict";Object.defineProperty(Ue,"__esModule",{value:!0});Ue.generateRandomNumber=Ue.clone=void 0;function Di(r,e){return typeof r>"u"?e:JSON.parse(JSON.stringify(r))}Ue.clone=Di;function Ii(){return Math.round(Math.random()*1e7)}Ue.generateRandomNumber=Ii});var cs=b(v=>{var os=tt()("h264-profile-level-id"),ge=tt()("h264-profile-level-id:WARN");os.log=console.info.bind(console);ge.log=console.warn.bind(console);var me=1,He=2,it=3,Pt=4,xt=5,Rt=6;v.ProfileConstrainedBaseline=me;v.ProfileBaseline=He;v.ProfileMain=it;v.ProfileConstrainedHigh=Pt;v.ProfileHigh=xt;v.ProfilePredictiveHigh444=Rt;var Pe=0,nt=10,Tt=11,Kt=12,Zt=13,Yt=20,Xt=21,er=22,tr=30,Ot=31,rr=32,sr=40,ir=41,nr=42,ar=50,or=51,cr=52;v.Level1_b=Pe;v.Level1=nt;v.Level1_1=Tt;v.Level1_2=Kt;v.Level1_3=Zt;v.Level2=Yt;v.Level2_1=Xt;v.Level2_2=er;v.Level3=tr;v.Level3_1=Ot;v.Level3_2=rr;v.Level4=sr;v.Level4_1=ir;v.Level4_2=nr;v.Level5=ar;v.Level5_1=or;v.Level5_2=cr;var Qe=class{constructor(e,t){this.profile=e,this.level=t}};v.ProfileLevelId=Qe;var V=class{constructor(e){this._mask=~ns("x",e),this._maskedValue=ns("1",e)}isMatch(e){return this._maskedValue===(e&this._mask)}},H=class{constructor(e,t,s){this.profile_idc=e,this.profile_iop=t,this.profile=s}},Fi=[new H(66,new V("x1xx0000"),me),new H(77,new V("1xxx0000"),me),new H(88,new V("11xx0000"),me),new H(66,new V("x0xx0000"),He),new H(88,new V("10xx0000"),He),new H(77,new V("0x0x0000"),it),new H(100,new V("00000000"),xt),new H(100,new V("00001100"),Pt),new H(244,new V("00000000"),Rt)];v.parseProfileLevelId=function(r){if(typeof r!="string"||r.length!==6)return null;let t=parseInt(r,16);if(t===0)return null;let s=t&255,i=t>>8&255,n=t>>16&255,a;switch(s){case Tt:{a=(i&16)!==0?Pe:Tt;break}case nt:case Kt:case Zt:case Yt:case Xt:case er:case tr:case Ot:case rr:case sr:case ir:case nr:case ar:case or:case cr:{a=s;break}default:return ge(`parseProfileLevelId() | unrecognized level_idc [str:${r}, level_idc:${s}]`),null}for(let o of Fi)if(n===o.profile_idc&&o.profile_iop.isMatch(i))return new Qe(o.profile,a);return ge(`parseProfileLevelId() | unrecognized profile_idc/profile_iop combination [str:${r}, profile_idc:${n}, profile_iop:${i}]`),null};v.profileLevelIdToString=function(r){if(r.level==Pe)switch(r.profile){case me:return"42f00b";case He:return"42100b";case it:return"4d100b";default:return ge(`profileLevelIdToString() | Level 1_b not is allowed for profile ${r.profile}`),null}let e;switch(r.profile){case me:{e="42e0";break}case He:{e="4200";break}case it:{e="4d00";break}case Pt:{e="640c";break}case xt:{e="6400";break}case Rt:{e="f400";break}default:return ge(`profileLevelIdToString() | unrecognized profile ${r.profile}`),null}let t=r.level.toString(16);return t.length===1&&(t=`0${t}`),`${e}${t}`};v.profileToString=function(r){switch(r){case me:return"ConstrainedBaseline";case He:return"Baseline";case it:return"Main";case Pt:return"ConstrainedHigh";case xt:return"High";case Rt:return"PredictiveHigh444";default:return ge(`profileToString() | unrecognized profile ${r}`),null}};v.levelToString=function(r){switch(r){case Pe:return"1b";case nt:return"1";case Tt:return"1.1";case Kt:return"1.2";case Zt:return"1.3";case Yt:return"2";case Xt:return"2.1";case er:return"2.2";case tr:return"3";case Ot:return"3.1";case rr:return"3.2";case sr:return"4";case ir:return"4.1";case nr:return"4.2";case ar:return"5";case or:return"5.1";case cr:return"5.2";default:return ge(`levelToString() | unrecognized level ${r}`),null}};v.parseSdpProfileLevelId=function(r={}){let e=new Qe(me,Ot),t=r["profile-level-id"];return t?v.parseProfileLevelId(t):e};v.isSameProfile=function(r={},e={}){let t=v.parseSdpProfileLevelId(r),s=v.parseSdpProfileLevelId(e);return Boolean(t&&s&&t.profile===s.profile)};v.generateProfileLevelIdForAnswer=function(r={},e={}){if(!r["profile-level-id"]&&!e["profile-level-id"])return ge("generateProfileLevelIdForAnswer() | profile-level-id missing in local and remote params"),null;let t=v.parseSdpProfileLevelId(r),s=v.parseSdpProfileLevelId(e);if(!t)throw new TypeError("invalid local_profile_level_id");if(!s)throw new TypeError("invalid remote_profile_level_id");if(t.profile!==s.profile)throw new TypeError("H264 Profile mismatch");let i=as(r)&&as(e),n=t.level,a=s.level,o=$i(n,a),d=i?n:o;return os(`generateProfileLevelIdForAnswer() | result [profile:${t.profile}, level:${d}]`),v.profileLevelIdToString(new Qe(t.profile,d))};function ns(r,e){return(e[0]===r)<<7|(e[1]===r)<<6|(e[2]===r)<<5|(e[3]===r)<<4|(e[4]===r)<<3|(e[5]===r)<<2|(e[6]===r)<<1|(e[7]===r)<<0}function Ai(r,e){return r===Pe?e!==nt&&e!==Pe:e===Pe?r!==nt:r<e}function $i(r,e){return Ai(r,e)?r:e}function as(r={}){let e=r["level-asymmetry-allowed"];return e===1||e==="1"}});var kt=b(g=>{"use strict";var Bi=g&&g.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,i)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),qi=g&&g.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),ls=g&&g.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&Bi(e,r,t);return qi(e,r),e};Object.defineProperty(g,"__esModule",{value:!0});g.canReceive=g.canSend=g.generateProbatorRtpParameters=g.reduceCodecs=g.getSendingRemoteRtpParameters=g.getSendingRtpParameters=g.getRecvRtpCapabilities=g.getExtendedRtpCapabilities=g.validateSctpStreamParameters=g.validateSctpParameters=g.validateNumSctpStreams=g.validateSctpCapabilities=g.validateRtcpParameters=g.validateRtpEncodingParameters=g.validateRtpHeaderExtensionParameters=g.validateRtpCodecParameters=g.validateRtpParameters=g.validateRtpHeaderExtension=g.validateRtcpFeedback=g.validateRtpCodecCapability=g.validateRtpCapabilities=void 0;var ds=ls(cs()),Ni=ls(Ve()),zi="probator",Ui=1234,Vi=127;function Hi(r){if(typeof r!="object")throw new TypeError("caps is not an object");if(r.codecs&&!Array.isArray(r.codecs))throw new TypeError("caps.codecs is not an array");r.codecs||(r.codecs=[]);for(let e of r.codecs)us(e);if(r.headerExtensions&&!Array.isArray(r.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");r.headerExtensions||(r.headerExtensions=[]);for(let e of r.headerExtensions)ps(e)}g.validateRtpCapabilities=Hi;function us(r){let e=new RegExp("^(audio|video)/(.+)","i");if(typeof r!="object")throw new TypeError("codec is not an object");if(!r.mimeType||typeof r.mimeType!="string")throw new TypeError("missing codec.mimeType");let t=e.exec(r.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");if(r.kind=t[1].toLowerCase(),r.preferredPayloadType&&typeof r.preferredPayloadType!="number")throw new TypeError("invalid codec.preferredPayloadType");if(typeof r.clockRate!="number")throw new TypeError("missing codec.clockRate");r.kind==="audio"?typeof r.channels!="number"&&(r.channels=1):delete r.channels,(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(let s of Object.keys(r.parameters)){let i=r.parameters[s];if(i===void 0&&(r.parameters[s]="",i=""),typeof i!="string"&&typeof i!="number")throw new TypeError(`invalid codec parameter [key:${s}s, value:${i}]`);if(s==="apt"&&typeof i!="number")throw new TypeError("invalid codec apt parameter")}(!r.rtcpFeedback||!Array.isArray(r.rtcpFeedback))&&(r.rtcpFeedback=[]);for(let s of r.rtcpFeedback)dr(s)}g.validateRtpCodecCapability=us;function dr(r){if(typeof r!="object")throw new TypeError("fb is not an object");if(!r.type||typeof r.type!="string")throw new TypeError("missing fb.type");(!r.parameter||typeof r.parameter!="string")&&(r.parameter="")}g.validateRtcpFeedback=dr;function ps(r){if(typeof r!="object")throw new TypeError("ext is not an object");if(r.kind!=="audio"&&r.kind!=="video")throw new TypeError("invalid ext.kind");if(!r.uri||typeof r.uri!="string")throw new TypeError("missing ext.uri");if(typeof r.preferredId!="number")throw new TypeError("missing ext.preferredId");if(r.preferredEncrypt&&typeof r.preferredEncrypt!="boolean")throw new TypeError("invalid ext.preferredEncrypt");if(r.preferredEncrypt||(r.preferredEncrypt=!1),r.direction&&typeof r.direction!="string")throw new TypeError("invalid ext.direction");r.direction||(r.direction="sendrecv")}g.validateRtpHeaderExtension=ps;function lr(r){if(typeof r!="object")throw new TypeError("params is not an object");if(r.mid&&typeof r.mid!="string")throw new TypeError("params.mid is not a string");if(!Array.isArray(r.codecs))throw new TypeError("missing params.codecs");for(let e of r.codecs)hs(e);if(r.headerExtensions&&!Array.isArray(r.headerExtensions))throw new TypeError("params.headerExtensions is not an array");r.headerExtensions||(r.headerExtensions=[]);for(let e of r.headerExtensions)fs(e);if(r.encodings&&!Array.isArray(r.encodings))throw new TypeError("params.encodings is not an array");r.encodings||(r.encodings=[]);for(let e of r.encodings)ms(e);if(r.rtcp&&typeof r.rtcp!="object")throw new TypeError("params.rtcp is not an object");r.rtcp||(r.rtcp={}),gs(r.rtcp)}g.validateRtpParameters=lr;function hs(r){let e=new RegExp("^(audio|video)/(.+)","i");if(typeof r!="object")throw new TypeError("codec is not an object");if(!r.mimeType||typeof r.mimeType!="string")throw new TypeError("missing codec.mimeType");let t=e.exec(r.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");if(typeof r.payloadType!="number")throw new TypeError("missing codec.payloadType");if(typeof r.clockRate!="number")throw new TypeError("missing codec.clockRate");t[1].toLowerCase()==="audio"?typeof r.channels!="number"&&(r.channels=1):delete r.channels,(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(let i of Object.keys(r.parameters)){let n=r.parameters[i];if(n===void 0&&(r.parameters[i]="",n=""),typeof n!="string"&&typeof n!="number")throw new TypeError(`invalid codec parameter [key:${i}s, value:${n}]`);if(i==="apt"&&typeof n!="number")throw new TypeError("invalid codec apt parameter")}(!r.rtcpFeedback||!Array.isArray(r.rtcpFeedback))&&(r.rtcpFeedback=[]);for(let i of r.rtcpFeedback)dr(i)}g.validateRtpCodecParameters=hs;function fs(r){if(typeof r!="object")throw new TypeError("ext is not an object");if(!r.uri||typeof r.uri!="string")throw new TypeError("missing ext.uri");if(typeof r.id!="number")throw new TypeError("missing ext.id");if(r.encrypt&&typeof r.encrypt!="boolean")throw new TypeError("invalid ext.encrypt");r.encrypt||(r.encrypt=!1),(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(let e of Object.keys(r.parameters)){let t=r.parameters[e];if(t===void 0&&(r.parameters[e]="",t=""),typeof t!="string"&&typeof t!="number")throw new TypeError("invalid header extension parameter")}}g.validateRtpHeaderExtensionParameters=fs;function ms(r){if(typeof r!="object")throw new TypeError("encoding is not an object");if(r.ssrc&&typeof r.ssrc!="number")throw new TypeError("invalid encoding.ssrc");if(r.rid&&typeof r.rid!="string")throw new TypeError("invalid encoding.rid");if(r.rtx&&typeof r.rtx!="object")throw new TypeError("invalid encoding.rtx");if(r.rtx&&typeof r.rtx.ssrc!="number")throw new TypeError("missing encoding.rtx.ssrc");if((!r.dtx||typeof r.dtx!="boolean")&&(r.dtx=!1),r.scalabilityMode&&typeof r.scalabilityMode!="string")throw new TypeError("invalid encoding.scalabilityMode")}g.validateRtpEncodingParameters=ms;function gs(r){if(typeof r!="object")throw new TypeError("rtcp is not an object");if(r.cname&&typeof r.cname!="string")throw new TypeError("invalid rtcp.cname");(!r.reducedSize||typeof r.reducedSize!="boolean")&&(r.reducedSize=!0)}g.validateRtcpParameters=gs;function Qi(r){if(typeof r!="object")throw new TypeError("caps is not an object");if(!r.numStreams||typeof r.numStreams!="object")throw new TypeError("missing caps.numStreams");_s(r.numStreams)}g.validateSctpCapabilities=Qi;function _s(r){if(typeof r!="object")throw new TypeError("numStreams is not an object");if(typeof r.OS!="number")throw new TypeError("missing numStreams.OS");if(typeof r.MIS!="number")throw new TypeError("missing numStreams.MIS")}g.validateNumSctpStreams=_s;function Gi(r){if(typeof r!="object")throw new TypeError("params is not an object");if(typeof r.port!="number")throw new TypeError("missing params.port");if(typeof r.OS!="number")throw new TypeError("missing params.OS");if(typeof r.MIS!="number")throw new TypeError("missing params.MIS");if(typeof r.maxMessageSize!="number")throw new TypeError("missing params.maxMessageSize")}g.validateSctpParameters=Gi;function Ji(r){if(typeof r!="object")throw new TypeError("params is not an object");if(typeof r.streamId!="number")throw new TypeError("missing params.streamId");let e=!1;if(typeof r.ordered=="boolean"?e=!0:r.ordered=!0,r.maxPacketLifeTime&&typeof r.maxPacketLifeTime!="number")throw new TypeError("invalid params.maxPacketLifeTime");if(r.maxRetransmits&&typeof r.maxRetransmits!="number")throw new TypeError("invalid params.maxRetransmits");if(r.maxPacketLifeTime&&r.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(e&&r.ordered&&(r.maxPacketLifeTime||r.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(!e&&(r.maxPacketLifeTime||r.maxRetransmits)&&(r.ordered=!1),r.label&&typeof r.label!="string")throw new TypeError("invalid params.label");if(r.protocol&&typeof r.protocol!="string")throw new TypeError("invalid params.protocol")}g.validateSctpStreamParameters=Ji;function Wi(r,e){let t={codecs:[],headerExtensions:[]};for(let s of e.codecs||[]){if(at(s))continue;let i=(r.codecs||[]).find(a=>ys(a,s,{strict:!0,modify:!0}));if(!i)continue;let n={mimeType:i.mimeType,kind:i.kind,clockRate:i.clockRate,channels:i.channels,localPayloadType:i.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:s.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:i.parameters,remoteParameters:s.parameters,rtcpFeedback:nn(i,s)};t.codecs.push(n)}for(let s of t.codecs){let i=r.codecs.find(a=>at(a)&&a.parameters.apt===s.localPayloadType),n=e.codecs.find(a=>at(a)&&a.parameters.apt===s.remotePayloadType);i&&n&&(s.localRtxPayloadType=i.preferredPayloadType,s.remoteRtxPayloadType=n.preferredPayloadType)}for(let s of e.headerExtensions){let i=r.headerExtensions.find(a=>sn(a,s));if(!i)continue;let n={kind:s.kind,uri:s.uri,sendId:i.preferredId,recvId:s.preferredId,encrypt:i.preferredEncrypt,direction:"sendrecv"};switch(s.direction){case"sendrecv":n.direction="sendrecv";break;case"recvonly":n.direction="sendonly";break;case"sendonly":n.direction="recvonly";break;case"inactive":n.direction="inactive";break}t.headerExtensions.push(n)}return t}g.getExtendedRtpCapabilities=Wi;function Ki(r){let e={codecs:[],headerExtensions:[]};for(let t of r.codecs){let s={mimeType:t.mimeType,kind:t.kind,preferredPayloadType:t.remotePayloadType,clockRate:t.clockRate,channels:t.channels,parameters:t.localParameters,rtcpFeedback:t.rtcpFeedback};if(e.codecs.push(s),!t.remoteRtxPayloadType)continue;let i={mimeType:`${t.kind}/rtx`,kind:t.kind,preferredPayloadType:t.remoteRtxPayloadType,clockRate:t.clockRate,parameters:{apt:t.remotePayloadType},rtcpFeedback:[]};e.codecs.push(i)}for(let t of r.headerExtensions){if(t.direction!=="sendrecv"&&t.direction!=="recvonly")continue;let s={kind:t.kind,uri:t.uri,preferredId:t.recvId,preferredEncrypt:t.encrypt,direction:t.direction};e.headerExtensions.push(s)}return e}g.getRecvRtpCapabilities=Ki;function Zi(r,e){let t={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(let s of e.codecs){if(s.kind!==r)continue;let i={mimeType:s.mimeType,payloadType:s.localPayloadType,clockRate:s.clockRate,channels:s.channels,parameters:s.localParameters,rtcpFeedback:s.rtcpFeedback};if(t.codecs.push(i),s.localRtxPayloadType){let n={mimeType:`${s.kind}/rtx`,payloadType:s.localRtxPayloadType,clockRate:s.clockRate,parameters:{apt:s.localPayloadType},rtcpFeedback:[]};t.codecs.push(n)}}for(let s of e.headerExtensions){if(s.kind&&s.kind!==r||s.direction!=="sendrecv"&&s.direction!=="sendonly")continue;let i={uri:s.uri,id:s.sendId,encrypt:s.encrypt,parameters:{}};t.headerExtensions.push(i)}return t}g.getSendingRtpParameters=Zi;function Yi(r,e){let t={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(let s of e.codecs){if(s.kind!==r)continue;let i={mimeType:s.mimeType,payloadType:s.localPayloadType,clockRate:s.clockRate,channels:s.channels,parameters:s.remoteParameters,rtcpFeedback:s.rtcpFeedback};if(t.codecs.push(i),s.localRtxPayloadType){let n={mimeType:`${s.kind}/rtx`,payloadType:s.localRtxPayloadType,clockRate:s.clockRate,parameters:{apt:s.localPayloadType},rtcpFeedback:[]};t.codecs.push(n)}}for(let s of e.headerExtensions){if(s.kind&&s.kind!==r||s.direction!=="sendrecv"&&s.direction!=="sendonly")continue;let i={uri:s.uri,id:s.sendId,encrypt:s.encrypt,parameters:{}};t.headerExtensions.push(i)}if(t.headerExtensions.some(s=>s.uri==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"))for(let s of t.codecs)s.rtcpFeedback=(s.rtcpFeedback||[]).filter(i=>i.type!=="goog-remb");else if(t.headerExtensions.some(s=>s.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"))for(let s of t.codecs)s.rtcpFeedback=(s.rtcpFeedback||[]).filter(i=>i.type!=="transport-cc");else for(let s of t.codecs)s.rtcpFeedback=(s.rtcpFeedback||[]).filter(i=>i.type!=="transport-cc"&&i.type!=="goog-remb");return t}g.getSendingRemoteRtpParameters=Yi;function Xi(r,e){let t=[];if(!e)t.push(r[0]),at(r[1])&&t.push(r[1]);else{for(let s=0;s<r.length;++s)if(ys(r[s],e)){t.push(r[s]),at(r[s+1])&&t.push(r[s+1]);break}if(t.length===0)throw new TypeError("no matching codec found")}return t}g.reduceCodecs=Xi;function en(r){r=Ni.clone(r,{}),lr(r);let e={mid:zi,codecs:[],headerExtensions:[],encodings:[{ssrc:Ui}],rtcp:{cname:"probator"}};return e.codecs.push(r.codecs[0]),e.codecs[0].payloadType=Vi,e.headerExtensions=r.headerExtensions,e}g.generateProbatorRtpParameters=en;function tn(r,e){return e.codecs.some(t=>t.kind===r)}g.canSend=tn;function rn(r,e){if(lr(r),r.codecs.length===0)return!1;let t=r.codecs[0];return e.codecs.some(s=>s.remotePayloadType===t.payloadType)}g.canReceive=rn;function at(r){return r?/.+\/rtx$/i.test(r.mimeType):!1}function ys(r,e,{strict:t=!1,modify:s=!1}={}){let i=r.mimeType.toLowerCase(),n=e.mimeType.toLowerCase();if(i!==n||r.clockRate!==e.clockRate||r.channels!==e.channels)return!1;switch(i){case"video/h264":{if(t){let a=r.parameters["packetization-mode"]||0,o=e.parameters["packetization-mode"]||0;if(a!==o||!ds.isSameProfile(r.parameters,e.parameters))return!1;let d;try{d=ds.generateProfileLevelIdForAnswer(r.parameters,e.parameters)}catch{return!1}s&&(d?(r.parameters["profile-level-id"]=d,e.parameters["profile-level-id"]=d):(delete r.parameters["profile-level-id"],delete e.parameters["profile-level-id"]))}break}case"video/vp9":{if(t){let a=r.parameters["profile-id"]||0,o=e.parameters["profile-id"]||0;if(a!==o)return!1}break}}return!0}function sn(r,e){return!(r.kind&&e.kind&&r.kind!==e.kind||r.uri!==e.uri)}function nn(r,e){let t=[];for(let s of r.rtcpFeedback||[]){let i=(e.rtcpFeedback||[]).find(n=>n.type===s.type&&(n.parameter===s.parameter||!n.parameter&&!s.parameter));i&&t.push(i)}return t}});var vs=b(ot=>{"use strict";var ur=ot&&ot.__awaiter||function(r,e,t,s){function i(n){return n instanceof t?n:new t(function(a){a(n)})}return new(t||(t=Promise))(function(n,a){function o(l){try{u(s.next(l))}catch(p){a(p)}}function d(l){try{u(s.throw(l))}catch(p){a(p)}}function u(l){l.done?n(l.value):i(l.value).then(o,d)}u((s=s.apply(r,e||[])).next())})};Object.defineProperty(ot,"__esModule",{value:!0});var pr=class{constructor({ClosedErrorClass:e=Error,StoppedErrorClass:t=Error,RemovedTaskErrorClass:s=Error}={ClosedErrorClass:Error,StoppedErrorClass:Error,RemovedTaskErrorClass:Error}){this.closed=!1,this.pendingTasks=[],this.ClosedErrorClass=Error,this.StoppedErrorClass=Error,this.RemovedTaskErrorClass=Error,this.ClosedErrorClass=e,this.StoppedErrorClass=t,this.RemovedTaskErrorClass=s}get size(){return this.pendingTasks.length}close(){if(!this.closed){this.closed=!0;for(let e of this.pendingTasks)e.stopped=!0,e.reject(new this.ClosedErrorClass("AwaitQueue closed"));this.pendingTasks.length=0}}push(e,t){return ur(this,void 0,void 0,function*(){if(this.closed)throw new this.ClosedErrorClass("AwaitQueue closed");if(typeof e!="function")throw new TypeError("given task is not a function");if(!e.name&&t)try{Object.defineProperty(e,"name",{value:t})}catch{}return new Promise((s,i)=>{let n={task:e,name:t,resolve:s,reject:i,stopped:!1,enqueuedAt:new Date,executedAt:void 0};this.pendingTasks.push(n),this.pendingTasks.length===1&&this.next()})})}removeTask(e){if(e===0)throw new TypeError("cannot remove task with index 0");let t=this.pendingTasks[e];!t||(this.pendingTasks.splice(e,1),t.reject(new this.RemovedTaskErrorClass("task removed from the queue")))}stop(){if(!this.closed){for(let e of this.pendingTasks)e.stopped=!0,e.reject(new this.StoppedErrorClass("AwaitQueue stopped"));this.pendingTasks.length=0}}dump(){let e=new Date,t=0;return this.pendingTasks.map(s=>({idx:t++,task:s.task,name:s.name,enqueuedTime:s.executedAt?s.executedAt.getTime()-s.enqueuedAt.getTime():e.getTime()-s.enqueuedAt.getTime(),executingTime:s.executedAt?e.getTime()-s.executedAt.getTime():0}))}next(){return ur(this,void 0,void 0,function*(){let e=this.pendingTasks[0];!e||(yield this.executeTask(e),this.pendingTasks.shift(),this.next())})}executeTask(e){return ur(this,void 0,void 0,function*(){if(!e.stopped){e.executedAt=new Date;try{let t=yield e.task();if(e.stopped)return;e.resolve(t)}catch(t){if(e.stopped)return;e.reject(t)}}})}};ot.AwaitQueue=pr});var fr=b(Lt=>{"use strict";Object.defineProperty(Lt,"__esModule",{value:!0});Lt.Producer=void 0;var an=Z(),ws=fe(),Ge=Te(),Y=new an.Logger("Producer"),hr=class extends ws.EnhancedEventEmitter{constructor({id:e,localId:t,rtpSender:s,track:i,rtpParameters:n,stopTracks:a,disableTrackOnPause:o,zeroRtpOnPause:d,appData:u}){super(),this._closed=!1,this._observer=new ws.EnhancedEventEmitter,Y.debug("constructor()"),this._id=e,this._localId=t,this._rtpSender=s,this._track=i,this._kind=i.kind,this._rtpParameters=n,this._paused=o?!i.enabled:!1,this._maxSpatialLayer=void 0,this._stopTracks=a,this._disableTrackOnPause=o,this._zeroRtpOnPause=d,this._appData=u||{},this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(Y.debug("close()"),this._closed=!0,this._destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(Y.debug("transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new Ge.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(Y.debug("pause()"),this._closed){Y.error("pause() | Producer closed");return}this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@pause",e,t)}).catch(()=>{}),this._observer.safeEmit("pause")}resume(){if(Y.debug("resume()"),this._closed){Y.error("resume() | Producer closed");return}this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@resume",e,t)}).catch(()=>{}),this._observer.safeEmit("resume")}async replaceTrack({track:e}){if(Y.debug("replaceTrack() [track:%o]",e),this._closed){if(e&&this._stopTracks)try{e.stop()}catch{}throw new Ge.InvalidStateError("closed")}else if(e&&e.readyState==="ended")throw new Ge.InvalidStateError("track ended");if(e===this._track){Y.debug("replaceTrack() | same track, ignored");return}await new Promise((t,s)=>{this.safeEmit("@replacetrack",e,t,s)}),this._destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this._handleTrack()}async setMaxSpatialLayer(e){if(this._closed)throw new Ge.InvalidStateError("closed");if(this._kind!=="video")throw new Ge.UnsupportedError("not a video Producer");if(typeof e!="number")throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(await new Promise((t,s)=>{this.safeEmit("@setmaxspatiallayer",e,t,s)}).catch(()=>{}),this._maxSpatialLayer=e)}async setRtpEncodingParameters(e){if(this._closed)throw new Ge.InvalidStateError("closed");if(typeof e!="object")throw new TypeError("invalid params");await new Promise((t,s)=>{this.safeEmit("@setrtpencodingparameters",e,t,s)})}_onTrackEnded(){Y.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){!this._track||this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){if(!!this._track)try{this._track.removeEventListener("ended",this._onTrackEnded),this._stopTracks&&this._track.stop()}catch{}}};Lt.Producer=hr});var gr=b(Mt=>{"use strict";Object.defineProperty(Mt,"__esModule",{value:!0});Mt.Consumer=void 0;var on=Z(),bs=fe(),cn=Te(),X=new on.Logger("Consumer"),mr=class extends bs.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:s,rtpReceiver:i,track:n,rtpParameters:a,appData:o}){super(),this._closed=!1,this._observer=new bs.EnhancedEventEmitter,X.debug("constructor()"),this._id=e,this._localId=t,this._producerId=s,this._rtpReceiver=i,this._track=n,this._rtpParameters=a,this._paused=!n.enabled,this._appData=o||{},this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(X.debug("close()"),this._closed=!0,this._destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(X.debug("transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new cn.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(X.debug("pause()"),this._closed){X.error("pause() | Consumer closed");return}if(this._paused){X.debug("pause() | Consumer is already paused");return}this._paused=!0,this._track.enabled=!1,this.emit("@pause"),this._observer.safeEmit("pause")}resume(){if(X.debug("resume()"),this._closed){X.error("resume() | Consumer closed");return}if(!this._paused){X.debug("resume() | Consumer is already resumed");return}this._paused=!1,this._track.enabled=!0,this.emit("@resume"),this._observer.safeEmit("resume")}_onTrackEnded(){X.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){try{this._track.removeEventListener("ended",this._onTrackEnded),this._track.stop()}catch{}}};Mt.Consumer=mr});var yr=b(jt=>{"use strict";Object.defineProperty(jt,"__esModule",{value:!0});jt.DataProducer=void 0;var dn=Z(),Cs=fe(),ln=Te(),ce=new dn.Logger("DataProducer"),_r=class extends Cs.EnhancedEventEmitter{constructor({id:e,dataChannel:t,sctpStreamParameters:s,appData:i}){super(),this._closed=!1,this._observer=new Cs.EnhancedEventEmitter,ce.debug("constructor()"),this._id=e,this._dataChannel=t,this._sctpStreamParameters=s,this._appData=i||{},this._handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(e){this._dataChannel.bufferedAmountLowThreshold=e}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(ce.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(ce.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}send(e){if(ce.debug("send()"),this._closed)throw new ln.InvalidStateError("closed");this._dataChannel.send(e)}_handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(ce.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?ce.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):ce.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(ce.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"))}),this._dataChannel.addEventListener("message",()=>{this._closed||ce.warn('DataChannel "message" event in a DataProducer, message discarded')}),this._dataChannel.addEventListener("bufferedamountlow",()=>{this._closed||this.safeEmit("bufferedamountlow")})}};jt.DataProducer=_r});var wr=b(Dt=>{"use strict";Object.defineProperty(Dt,"__esModule",{value:!0});Dt.DataConsumer=void 0;var un=Z(),Es=fe(),xe=new un.Logger("DataConsumer"),vr=class extends Es.EnhancedEventEmitter{constructor({id:e,dataProducerId:t,dataChannel:s,sctpStreamParameters:i,appData:n}){super(),this._closed=!1,this._observer=new Es.EnhancedEventEmitter,xe.debug("constructor()"),this._id=e,this._dataProducerId=t,this._dataChannel=s,this._sctpStreamParameters=i,this._appData=n||{},this._handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(e){this._dataChannel.binaryType=e}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(xe.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(xe.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}_handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(xe.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?xe.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):xe.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(xe.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"))}),this._dataChannel.addEventListener("message",e=>{this._closed||this.safeEmit("message",e.data)})}};Dt.DataConsumer=vr});var Sr=b(ee=>{"use strict";var pn=ee&&ee.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,i)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),hn=ee&&ee.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),Ts=ee&&ee.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&pn(e,r,t);return hn(e,r),e};Object.defineProperty(ee,"__esModule",{value:!0});ee.Transport=void 0;var fn=vs(),mn=Z(),Ss=fe(),k=Te(),br=Ts(Ve()),ct=Ts(kt()),gn=fr(),_n=gr(),yn=yr(),vn=wr(),O=new mn.Logger("Transport"),Cr=class{constructor(e){this.consumerOptions=e,this.promise=new Promise((t,s)=>{this.resolve=t,this.reject=s})}},Er=class extends Ss.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:s,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:l,appData:p,handlerFactory:h,extendedRtpCapabilities:f,canProduceByKind:_}){super(),this._closed=!1,this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._dataProducers=new Map,this._dataConsumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new fn.AwaitQueue({ClosedErrorClass:k.InvalidStateError}),this._pendingConsumerTasks=[],this._consumerCreationInProgress=!1,this._pendingPauseConsumers=new Map,this._consumerPauseInProgress=!1,this._pendingResumeConsumers=new Map,this._consumerResumeInProgress=!1,this._pendingCloseConsumers=new Map,this._consumerCloseInProgress=!1,this._observer=new Ss.EnhancedEventEmitter,O.debug("constructor() [id:%s, direction:%s]",t,e),this._id=t,this._direction=e,this._extendedRtpCapabilities=f,this._canProduceByKind=_,this._maxSctpMessageSize=a?a.maxMessageSize:null,u=br.clone(u,{}),delete u.iceServers,delete u.iceTransportPolicy,delete u.bundlePolicy,delete u.rtcpMuxPolicy,delete u.sdpSemantics,this._handler=h(),this._handler.run({direction:e,iceParameters:s,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:l,extendedRtpCapabilities:f}),this._appData=p||{},this._handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){if(!this._closed){O.debug("close()"),this._closed=!0,this._awaitQueue.close(),this._handler.close();for(let e of this._producers.values())e.transportClosed();this._producers.clear();for(let e of this._consumers.values())e.transportClosed();this._consumers.clear();for(let e of this._dataProducers.values())e.transportClosed();this._dataProducers.clear();for(let e of this._dataConsumers.values())e.transportClosed();this._dataConsumers.clear(),this._observer.safeEmit("close")}}async getStats(){if(this._closed)throw new k.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:e}){if(O.debug("restartIce()"),this._closed)throw new k.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>this._handler.restartIce(e),"transport.restartIce()")}async updateIceServers({iceServers:e}={}){if(O.debug("updateIceServers()"),this._closed)throw new k.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._awaitQueue.push(async()=>this._handler.updateIceServers(e),"transport.updateIceServers()")}async produce({track:e,encodings:t,codecOptions:s,codec:i,stopTracks:n=!0,disableTrackOnPause:a=!0,zeroRtpOnPause:o=!1,appData:d={}}={}){if(O.debug("produce() [track:%o]",e),e){if(this._direction!=="send")throw new k.UnsupportedError("not a sending Transport");if(this._canProduceByKind[e.kind]){if(e.readyState==="ended")throw new k.InvalidStateError("track ended");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(d&&typeof d!="object")throw new TypeError("if given, appData must be an object")}else throw new k.UnsupportedError(`cannot produce ${e.kind}`)}else throw new TypeError("missing track");return this._awaitQueue.push(async()=>{let u;if(t&&!Array.isArray(t))throw TypeError("encodings must be an array");t&&t.length===0?u=void 0:t&&(u=t.map(f=>{let _={active:!0};return f.active===!1&&(_.active=!1),typeof f.dtx=="boolean"&&(_.dtx=f.dtx),typeof f.scalabilityMode=="string"&&(_.scalabilityMode=f.scalabilityMode),typeof f.scaleResolutionDownBy=="number"&&(_.scaleResolutionDownBy=f.scaleResolutionDownBy),typeof f.maxBitrate=="number"&&(_.maxBitrate=f.maxBitrate),typeof f.maxFramerate=="number"&&(_.maxFramerate=f.maxFramerate),typeof f.adaptivePtime=="boolean"&&(_.adaptivePtime=f.adaptivePtime),typeof f.priority=="string"&&(_.priority=f.priority),typeof f.networkPriority=="string"&&(_.networkPriority=f.networkPriority),_}));let{localId:l,rtpParameters:p,rtpSender:h}=await this._handler.send({track:e,encodings:u,codecOptions:s,codec:i});try{ct.validateRtpParameters(p);let{id:f}=await new Promise((E,m)=>{this.safeEmit("produce",{kind:e.kind,rtpParameters:p,appData:d},E,m)}),_=new gn.Producer({id:f,localId:l,rtpSender:h,track:e,rtpParameters:p,stopTracks:n,disableTrackOnPause:a,zeroRtpOnPause:o,appData:d});return this._producers.set(_.id,_),this._handleProducer(_),this._observer.safeEmit("newproducer",_),_}catch(f){throw this._handler.stopSending(l).catch(()=>{}),f}},"transport.produce()").catch(u=>{if(n)try{e.stop()}catch{}throw u})}async consume({id:e,producerId:t,kind:s,rtpParameters:i,appData:n={}}){if(O.debug("consume()"),i=br.clone(i,void 0),this._closed)throw new k.InvalidStateError("closed");if(this._direction!=="recv")throw new k.UnsupportedError("not a receiving Transport");if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing producerId");if(s!=="audio"&&s!=="video")throw new TypeError(`invalid kind '${s}'`);if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(n&&typeof n!="object")throw new TypeError("if given, appData must be an object");if(!ct.canReceive(i,this._extendedRtpCapabilities))throw new k.UnsupportedError("cannot consume this Producer");let o=new Cr({id:e,producerId:t,kind:s,rtpParameters:i,appData:n});return this._pendingConsumerTasks.push(o),this._consumerCreationInProgress===!1&&this._createPendingConsumers(),o.promise}async produceData({ordered:e=!0,maxPacketLifeTime:t,maxRetransmits:s,label:i="",protocol:n="",appData:a={}}={}){if(O.debug("produceData()"),this._direction!=="send")throw new k.UnsupportedError("not a sending Transport");if(this._maxSctpMessageSize){if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("producedata")===0)throw new TypeError('no "producedata" listener set into this transport');if(a&&typeof a!="object")throw new TypeError("if given, appData must be an object")}else throw new k.UnsupportedError("SCTP not enabled by remote Transport");return(t||s)&&(e=!1),this._awaitQueue.push(async()=>{let{dataChannel:o,sctpStreamParameters:d}=await this._handler.sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:i,protocol:n});ct.validateSctpStreamParameters(d);let{id:u}=await new Promise((p,h)=>{this.safeEmit("producedata",{sctpStreamParameters:d,label:i,protocol:n,appData:a},p,h)}),l=new yn.DataProducer({id:u,dataChannel:o,sctpStreamParameters:d,appData:a});return this._dataProducers.set(l.id,l),this._handleDataProducer(l),this._observer.safeEmit("newdataproducer",l),l},"transport.produceData()")}async consumeData({id:e,dataProducerId:t,sctpStreamParameters:s,label:i="",protocol:n="",appData:a={}}){if(O.debug("consumeData()"),s=br.clone(s,void 0),this._closed)throw new k.InvalidStateError("closed");if(this._direction!=="recv")throw new k.UnsupportedError("not a receiving Transport");if(this._maxSctpMessageSize){if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing dataProducerId");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(a&&typeof a!="object")throw new TypeError("if given, appData must be an object")}else throw new k.UnsupportedError("SCTP not enabled by remote Transport");return ct.validateSctpStreamParameters(s),this._awaitQueue.push(async()=>{let{dataChannel:o}=await this._handler.receiveDataChannel({sctpStreamParameters:s,label:i,protocol:n}),d=new vn.DataConsumer({id:e,dataProducerId:t,dataChannel:o,sctpStreamParameters:s,appData:a});return this._dataConsumers.set(d.id,d),this._handleDataConsumer(d),this._observer.safeEmit("newdataconsumer",d),d},"transport.consumeData()")}async _createPendingConsumers(){this._consumerCreationInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingConsumerTasks.length===0){O.debug("_createPendingConsumers() | there is no Consumer to be created");return}let e=[...this._pendingConsumerTasks];this._pendingConsumerTasks=[];let t,s=[];for(let i of e){let{id:n,kind:a,rtpParameters:o}=i.consumerOptions;s.push({trackId:n,kind:a,rtpParameters:o})}try{let i=await this._handler.receive(s);for(let n=0;n<i.length;n++){let a=e[n],o=i[n],{id:d,producerId:u,kind:l,rtpParameters:p,appData:h}=a.consumerOptions,{localId:f,rtpReceiver:_,track:E}=o,m=new _n.Consumer({id:d,localId:f,producerId:u,rtpReceiver:_,track:E,rtpParameters:p,appData:h});this._consumers.set(m.id,m),this._handleConsumer(m),!this._probatorConsumerCreated&&!t&&l==="video"&&(t=m),this._observer.safeEmit("newconsumer",m),a.resolve(m)}}catch(i){for(let n of e)n.reject(i)}if(t)try{let i=ct.generateProbatorRtpParameters(t.rtpParameters);await this._handler.receive([{trackId:"probator",kind:"video",rtpParameters:i}]),O.debug("_createPendingConsumers() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(i){O.error("_createPendingConsumers() | failed to create Consumer for RTP probation:%o",i)}},"transport._createPendingConsumers()").then(()=>{this._consumerCreationInProgress=!1,this._pendingConsumerTasks.length>0&&this._createPendingConsumers()}).catch(()=>{})}_pausePendingConsumers(){this._consumerPauseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingPauseConsumers.size===0){O.debug("_pausePendingConsumers() | there is no Consumer to be paused");return}let e=Array.from(this._pendingPauseConsumers.values());this._pendingPauseConsumers.clear();try{let t=e.map(s=>s.localId);await this._handler.pauseReceiving(t)}catch(t){O.error("_pausePendingConsumers() | failed to pause Consumers:",t)}},"transport._pausePendingConsumers").then(()=>{this._consumerPauseInProgress=!1,this._pendingPauseConsumers.size>0&&this._pausePendingConsumers()}).catch(()=>{})}_resumePendingConsumers(){this._consumerResumeInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingResumeConsumers.size===0){O.debug("_resumePendingConsumers() | there is no Consumer to be resumed");return}let e=Array.from(this._pendingResumeConsumers.values());this._pendingResumeConsumers.clear();try{let t=e.map(s=>s.localId);await this._handler.resumeReceiving(t)}catch(t){O.error("_resumePendingConsumers() | failed to resume Consumers:",t)}},"transport._resumePendingConsumers").then(()=>{this._consumerResumeInProgress=!1,this._pendingResumeConsumers.size>0&&this._resumePendingConsumers()}).catch(()=>{})}_closePendingConsumers(){this._consumerCloseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingCloseConsumers.size===0){O.debug("_closePendingConsumers() | there is no Consumer to be closed");return}let e=Array.from(this._pendingCloseConsumers.values());this._pendingCloseConsumers.clear();try{await this._handler.stopReceiving(e.map(t=>t.localId))}catch(t){O.error("_closePendingConsumers() | failed to close Consumers:",t)}},"transport._closePendingConsumers").then(()=>{this._consumerCloseInProgress=!1,this._pendingCloseConsumers.size>0&&this._closePendingConsumers()}).catch(()=>{})}_handleHandler(){let e=this._handler;e.on("@connect",({dtlsParameters:t},s,i)=>{if(this._closed){i(new k.InvalidStateError("closed"));return}this.safeEmit("connect",{dtlsParameters:t},s,i)}),e.on("@connectionstatechange",t=>{t!==this._connectionState&&(O.debug("connection state changed to %s",t),this._connectionState=t,this._closed||this.safeEmit("connectionstatechange",t))})}_handleProducer(e){e.on("@close",()=>{this._producers.delete(e.id),!this._closed&&this._awaitQueue.push(async()=>this._handler.stopSending(e.localId),"producer @close event").catch(t=>O.warn("producer.close() failed:%o",t))}),e.on("@pause",(t,s)=>{this._awaitQueue.push(async()=>this._handler.pauseSending(e.localId),"producer @pause event").then(t).catch(s)}),e.on("@resume",(t,s)=>{this._awaitQueue.push(async()=>this._handler.resumeSending(e.localId),"producer @resume event").then(t).catch(s)}),e.on("@replacetrack",(t,s,i)=>{this._awaitQueue.push(async()=>this._handler.replaceTrack(e.localId,t),"producer @replacetrack event").then(s).catch(i)}),e.on("@setmaxspatiallayer",(t,s,i)=>{this._awaitQueue.push(async()=>this._handler.setMaxSpatialLayer(e.localId,t),"producer @setmaxspatiallayer event").then(s).catch(i)}),e.on("@setrtpencodingparameters",(t,s,i)=>{this._awaitQueue.push(async()=>this._handler.setRtpEncodingParameters(e.localId,t),"producer @setrtpencodingparameters event").then(s).catch(i)}),e.on("@getstats",(t,s)=>{if(this._closed)return s(new k.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(s)})}_handleConsumer(e){e.on("@close",()=>{this._consumers.delete(e.id),this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.delete(e.id),!this._closed&&(this._pendingCloseConsumers.set(e.id,e),this._consumerCloseInProgress===!1&&this._closePendingConsumers())}),e.on("@pause",()=>{this._pendingResumeConsumers.has(e.id)&&this._pendingResumeConsumers.delete(e.id),this._pendingPauseConsumers.set(e.id,e),this._consumerPauseInProgress===!1&&this._pausePendingConsumers()}),e.on("@resume",()=>{this._pendingPauseConsumers.has(e.id)&&this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.set(e.id,e),this._consumerResumeInProgress===!1&&this._resumePendingConsumers()}),e.on("@getstats",(t,s)=>{if(this._closed)return s(new k.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(s)})}_handleDataProducer(e){e.on("@close",()=>{this._dataProducers.delete(e.id)})}_handleDataConsumer(e){e.on("@close",()=>{this._dataConsumers.delete(e.id)})}};ee.Transport=Er});var Tr=b((co,xs)=>{var Ps=xs.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(r){return r.encoding?"rtpmap:%d %s/%s/%s":r.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(r){return r.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(r){return r.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(r){return"extmap:%d"+(r.direction?"/%s":"%v")+(r["encrypt-uri"]?" %s":"%v")+" %s"+(r.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(r){return r.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(r){var e="candidate:%s %d %s %d %s %d typ %s";return e+=r.raddr!=null?" raddr %s rport %d":"%v%v",e+=r.tcptype!=null?" tcptype %s":"%v",r.generation!=null&&(e+=" generation %d"),e+=r["network-id"]!=null?" network-id %d":"%v",e+=r["network-cost"]!=null?" network-cost %d":"%v",e}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(r){var e="ssrc:%d";return r.attribute!=null&&(e+=" %s",r.value!=null&&(e+=":%s")),e}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(r){return r.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(r){return r.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(r){return"imageattr:%s %s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(r){return"simulcast:%s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(r){return"ts-refclk:%s"+(r.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(r){var e="mediaclk:";return e+=r.id!=null?"id=%s %s":"%v%s",e+=r.mediaClockValue!=null?"=%s":"",e+=r.rateNumerator!=null?" rate=%s":"",e+=r.rateDenominator!=null?"/%s":"",e}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(Ps).forEach(function(r){var e=Ps[r];e.forEach(function(t){t.reg||(t.reg=/(.*)/),t.format||(t.format="%s")})})});var ks=b(de=>{var Je=function(r){return String(Number(r))===r?Number(r):r},wn=function(r,e,t,s){if(s&&!t)e[s]=Je(r[1]);else for(var i=0;i<t.length;i+=1)r[i+1]!=null&&(e[t[i]]=Je(r[i+1]))},bn=function(r,e,t){var s=r.name&&r.names;r.push&&!e[r.push]?e[r.push]=[]:s&&!e[r.name]&&(e[r.name]={});var i=r.push?{}:s?e[r.name]:e;wn(t.match(r.reg),i,r.names,r.name),r.push&&e[r.push].push(i)},Rs=Tr(),Cn=RegExp.prototype.test.bind(/^([a-z])=(.*)/);de.parse=function(r){var e={},t=[],s=e;return r.split(/(\r\n|\r|\n)/).filter(Cn).forEach(function(i){var n=i[0],a=i.slice(2);n==="m"&&(t.push({rtp:[],fmtp:[]}),s=t[t.length-1]);for(var o=0;o<(Rs[n]||[]).length;o+=1){var d=Rs[n][o];if(d.reg.test(a))return bn(d,s,a)}}),e.media=t,e};var Os=function(r,e){var t=e.split(/=(.+)/,2);return t.length===2?r[t[0]]=Je(t[1]):t.length===1&&e.length>1&&(r[t[0]]=void 0),r};de.parseParams=function(r){return r.split(/;\s?/).reduce(Os,{})};de.parseFmtpConfig=de.parseParams;de.parsePayloads=function(r){return r.toString().split(" ").map(Number)};de.parseRemoteCandidates=function(r){for(var e=[],t=r.split(" ").map(Je),s=0;s<t.length;s+=3)e.push({component:t[s],ip:t[s+1],port:t[s+2]});return e};de.parseImageAttributes=function(r){return r.split(" ").map(function(e){return e.substring(1,e.length-1).split(",").reduce(Os,{})})};de.parseSimulcastStreamList=function(r){return r.split(";").map(function(e){return e.split(",").map(function(t){var s,i=!1;return t[0]!=="~"?s=Je(t):(s=Je(t.substring(1,t.length)),i=!0),{scid:s,paused:i}})})}});var Ms=b((uo,Ls)=>{var Pr=Tr(),En=/%[sdv%]/g,Sn=function(r){var e=1,t=arguments,s=t.length;return r.replace(En,function(i){if(e>=s)return i;var n=t[e];switch(e+=1,i){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}})},dt=function(r,e,t){var s=e.format instanceof Function?e.format(e.push?t:t[e.name]):e.format,i=[r+"="+s];if(e.names)for(var n=0;n<e.names.length;n+=1){var a=e.names[n];e.name?i.push(t[e.name][a]):i.push(t[e.names[n]])}else i.push(t[e.name]);return Sn.apply(null,i)},Tn=["v","o","s","i","u","e","p","c","b","t","r","z","a"],Pn=["i","c","b","a"];Ls.exports=function(r,e){e=e||{},r.version==null&&(r.version=0),r.name==null&&(r.name=" "),r.media.forEach(function(n){n.payloads==null&&(n.payloads="")});var t=e.outerOrder||Tn,s=e.innerOrder||Pn,i=[];return t.forEach(function(n){Pr[n].forEach(function(a){a.name in r&&r[a.name]!=null?i.push(dt(n,a,r)):a.push in r&&r[a.push]!=null&&r[a.push].forEach(function(o){i.push(dt(n,a,o))})})}),r.media.forEach(function(n){i.push(dt("m",Pr.m[0],n)),s.forEach(function(a){Pr[a].forEach(function(o){o.name in n&&n[o.name]!=null?i.push(dt(a,o,n)):o.push in n&&n[o.push]!=null&&n[o.push].forEach(function(d){i.push(dt(a,o,d))})})})}),i.join(`\r
`)+`\r
`}});var It=b(le=>{var Re=ks(),xn=Ms();le.write=xn;le.parse=Re.parse;le.parseParams=Re.parseParams;le.parseFmtpConfig=Re.parseFmtpConfig;le.parsePayloads=Re.parsePayloads;le.parseRemoteCandidates=Re.parseRemoteCandidates;le.parseImageAttributes=Re.parseImageAttributes;le.parseSimulcastStreamList=Re.parseSimulcastStreamList});var Ds=b(M=>{"use strict";var Rn=M&&M.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,i)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),On=M&&M.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),kn=M&&M.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&Rn(e,r,t);return On(e,r),e};Object.defineProperty(M,"__esModule",{value:!0});M.applyCodecParameters=M.getCname=M.extractDtlsParameters=M.extractRtpCapabilities=void 0;var js=kn(It());function Ln({sdpObject:r}){let e=new Map,t=[],s=!1,i=!1;for(let a of r.media){let o=a.type;switch(o){case"audio":{if(s)continue;s=!0;break}case"video":{if(i)continue;i=!0;break}default:continue}for(let d of a.rtp){let u={kind:o,mimeType:`${o}/${d.codec}`,preferredPayloadType:d.payload,clockRate:d.rate,channels:d.encoding,parameters:{},rtcpFeedback:[]};e.set(u.preferredPayloadType,u)}for(let d of a.fmtp||[]){let u=js.parseParams(d.config),l=e.get(d.payload);!l||(u&&u.hasOwnProperty("profile-level-id")&&(u["profile-level-id"]=String(u["profile-level-id"])),l.parameters=u)}for(let d of a.rtcpFb||[]){let u=e.get(d.payload);if(!u)continue;let l={type:d.type,parameter:d.subtype};l.parameter||delete l.parameter,u.rtcpFeedback.push(l)}for(let d of a.ext||[]){if(d["encrypt-uri"])continue;let u={kind:o,uri:d.uri,preferredId:d.value};t.push(u)}}return{codecs:Array.from(e.values()),headerExtensions:t}}M.extractRtpCapabilities=Ln;function Mn({sdpObject:r}){let e=(r.media||[]).find(n=>n.iceUfrag&&n.port!==0);if(!e)throw new Error("no active media section found");let t=e.fingerprint||r.fingerprint,s;switch(e.setup){case"active":s="client";break;case"passive":s="server";break;case"actpass":s="auto";break}return{role:s,fingerprints:[{algorithm:t.type,value:t.hash}]}}M.extractDtlsParameters=Mn;function jn({offerMediaObject:r}){let e=(r.ssrcs||[]).find(t=>t.attribute==="cname");return e?e.value:""}M.getCname=jn;function Dn({offerRtpParameters:r,answerMediaObject:e}){for(let t of r.codecs){let s=t.mimeType.toLowerCase();if(s!=="audio/opus"||!(e.rtp||[]).find(o=>o.payload===t.payloadType))continue;e.fmtp=e.fmtp||[];let n=e.fmtp.find(o=>o.payload===t.payloadType);n||(n={payload:t.payloadType,config:""},e.fmtp.push(n));let a=js.parseParams(n.config);switch(s){case"audio/opus":{let o=t.parameters["sprop-stereo"];o!==void 0&&(a.stereo=o?1:0);break}}n.config="";for(let o of Object.keys(a))n.config&&(n.config+=";"),n.config+=`${o}=${a[o]}`}}M.applyCodecParameters=Dn});var Is=b(We=>{"use strict";Object.defineProperty(We,"__esModule",{value:!0});We.addLegacySimulcast=We.getRtpEncodings=void 0;function In({offerMediaObject:r}){let e=new Set;for(let i of r.ssrcs||[]){let n=i.id;e.add(n)}if(e.size===0)throw new Error("no a=ssrc lines found");let t=new Map;for(let i of r.ssrcGroups||[]){if(i.semantics!=="FID")continue;let[n,a]=i.ssrcs.split(/\s+/);n=Number(n),a=Number(a),e.has(n)&&(e.delete(n),e.delete(a),t.set(n,a))}for(let i of e)t.set(i,null);let s=[];for(let[i,n]of t){let a={ssrc:i};n&&(a.rtx={ssrc:n}),s.push(a)}return s}We.getRtpEncodings=In;function Fn({offerMediaObject:r,numStreams:e}){if(e<=1)throw new TypeError("numStreams must be greater than 1");let t=(r.ssrcs||[]).find(p=>p.attribute==="msid");if(!t)throw new Error("a=ssrc line with msid information not found");let[s,i]=t.value.split(" "),n=t.id,a;(r.ssrcGroups||[]).some(p=>{if(p.semantics!=="FID")return!1;let h=p.ssrcs.split(/\s+/);return Number(h[0])===n?(a=Number(h[1]),!0):!1});let o=r.ssrcs.find(p=>p.attribute==="cname");if(!o)throw new Error("a=ssrc line with cname information not found");let d=o.value,u=[],l=[];for(let p=0;p<e;++p)u.push(n+p),a&&l.push(a+p);r.ssrcGroups=[],r.ssrcs=[],r.ssrcGroups.push({semantics:"SIM",ssrcs:u.join(" ")});for(let p=0;p<u.length;++p){let h=u[p];r.ssrcs.push({id:h,attribute:"cname",value:d}),r.ssrcs.push({id:h,attribute:"msid",value:`${s} ${i}`})}for(let p=0;p<l.length;++p){let h=u[p],f=l[p];r.ssrcs.push({id:f,attribute:"cname",value:d}),r.ssrcs.push({id:f,attribute:"msid",value:`${s} ${i}`}),r.ssrcGroups.push({semantics:"FID",ssrcs:`${h} ${f}`})}}We.addLegacySimulcast=Fn});var Rr=b(Ft=>{"use strict";Object.defineProperty(Ft,"__esModule",{value:!0});Ft.HandlerInterface=void 0;var An=fe(),xr=class extends An.EnhancedEventEmitter{constructor(){super()}};Ft.HandlerInterface=xr});var Fs=b(A=>{"use strict";var $n=A&&A.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,i)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),Bn=A&&A.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),qn=A&&A.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&$n(e,r,t);return Bn(e,r),e};Object.defineProperty(A,"__esModule",{value:!0});A.OfferMediaSection=A.AnswerMediaSection=A.MediaSection=void 0;var Nn=qn(Ve()),lt=class{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,planB:i=!1}){if(this._mediaObject={},this._planB=i,e&&this.setIceParameters(e),t){this._mediaObject.candidates=[];for(let n of t){let a={};a.component=1,a.foundation=n.foundation,a.ip=n.ip,a.port=n.port,a.priority=n.priority,a.transport=n.protocol,a.type=n.type,n.tcpType&&(a.tcptype=n.tcpType),this._mediaObject.candidates.push(a)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}s&&this.setDtlsRole(s.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return this._mediaObject.port===0}getObject(){return this._mediaObject}setIceParameters(e){this._mediaObject.iceUfrag=e.usernameFragment,this._mediaObject.icePwd=e.password}pause(){this._mediaObject.direction="inactive"}disable(){this.pause(),delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}close(){this.disable(),this._mediaObject.port=0}};A.MediaSection=lt;var Or=class extends lt{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,sctpParameters:i,plainRtpParameters:n,planB:a=!1,offerMediaObject:o,offerRtpParameters:d,answerRtpParameters:u,codecOptions:l,extmapAllowMixed:p=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:s,planB:a}),this._mediaObject.mid=String(o.mid),this._mediaObject.type=o.type,this._mediaObject.protocol=o.protocol,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),o.type){case"audio":case"video":{this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(let h of u.codecs){let f={payload:h.payloadType,codec:Lr(h),rate:h.clockRate};h.channels>1&&(f.encoding=h.channels),this._mediaObject.rtp.push(f);let _=Nn.clone(h.parameters,{});if(l){let{opusStereo:m,opusFec:x,opusDtx:L,opusMaxPlaybackRate:W,opusMaxAverageBitrate:Ce,opusPtime:mt,videoGoogleStartBitrate:Le,videoGoogleMaxBitrate:gt,videoGoogleMinBitrate:et}=l,Me=d.codecs.find(ri=>ri.payloadType===h.payloadType);switch(h.mimeType.toLowerCase()){case"audio/opus":{m!==void 0&&(Me.parameters["sprop-stereo"]=m?1:0,_.stereo=m?1:0),x!==void 0&&(Me.parameters.useinbandfec=x?1:0,_.useinbandfec=x?1:0),L!==void 0&&(Me.parameters.usedtx=L?1:0,_.usedtx=L?1:0),W!==void 0&&(_.maxplaybackrate=W),Ce!==void 0&&(_.maxaveragebitrate=Ce),mt!==void 0&&(Me.parameters.ptime=mt,_.ptime=mt);break}case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":{Le!==void 0&&(_["x-google-start-bitrate"]=Le),gt!==void 0&&(_["x-google-max-bitrate"]=gt),et!==void 0&&(_["x-google-min-bitrate"]=et);break}}}let E={payload:h.payloadType,config:""};for(let m of Object.keys(_))E.config&&(E.config+=";"),E.config+=`${m}=${_[m]}`;E.config&&this._mediaObject.fmtp.push(E);for(let m of h.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:h.payloadType,type:m.type,subtype:m.parameter})}this._mediaObject.payloads=u.codecs.map(h=>h.payloadType).join(" "),this._mediaObject.ext=[];for(let h of u.headerExtensions)!(o.ext||[]).some(_=>_.uri===h.uri)||this._mediaObject.ext.push({uri:h.uri,value:h.id});if(p&&o.extmapAllowMixed==="extmap-allow-mixed"&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),o.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:o.simulcast.list1},this._mediaObject.rids=[];for(let h of o.rids||[])h.direction==="send"&&this._mediaObject.rids.push({id:h.id,direction:"recv"})}else if(o.simulcast_03){this._mediaObject.simulcast_03={value:o.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(let h of o.rids||[])h.direction==="send"&&this._mediaObject.rids.push({id:h.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&this._mediaObject.type==="video"&&(this._mediaObject.xGoogleFlag="conference");break}case"application":{typeof o.sctpPort=="number"?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize):o.sctpmap&&(this._mediaObject.payloads=i.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:i.port,maxMessageSize:i.maxMessageSize});break}}}setDtlsRole(e){switch(e){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass";break}}resume(){this._mediaObject.direction="recvonly"}};A.AnswerMediaSection=Or;var kr=class extends lt{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,sctpParameters:i,plainRtpParameters:n,planB:a=!1,mid:o,kind:d,offerRtpParameters:u,streamId:l,trackId:p,oldDataChannelSpec:h=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:s,planB:a}),this._mediaObject.mid=String(o),this._mediaObject.type=d,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},i?this._mediaObject.protocol="UDP/DTLS/SCTP":this._mediaObject.protocol="UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),d){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${l||"-"} ${p}`);for(let m of u.codecs){let x={payload:m.payloadType,codec:Lr(m),rate:m.clockRate};m.channels>1&&(x.encoding=m.channels),this._mediaObject.rtp.push(x);let L={payload:m.payloadType,config:""};for(let W of Object.keys(m.parameters))L.config&&(L.config+=";"),L.config+=`${W}=${m.parameters[W]}`;L.config&&this._mediaObject.fmtp.push(L);for(let W of m.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:m.payloadType,type:W.type,subtype:W.parameter})}this._mediaObject.payloads=u.codecs.map(m=>m.payloadType).join(" "),this._mediaObject.ext=[];for(let m of u.headerExtensions)this._mediaObject.ext.push({uri:m.uri,value:m.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";let f=u.encodings[0],_=f.ssrc,E=f.rtx&&f.rtx.ssrc?f.rtx.ssrc:void 0;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],u.rtcp.cname&&this._mediaObject.ssrcs.push({id:_,attribute:"cname",value:u.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:_,attribute:"msid",value:`${l||"-"} ${p}`}),E&&(u.rtcp.cname&&this._mediaObject.ssrcs.push({id:E,attribute:"cname",value:u.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:E,attribute:"msid",value:`${l||"-"} ${p}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${_} ${E}`}));break}case"application":{h?(this._mediaObject.payloads=i.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:i.port,maxMessageSize:i.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize);break}}}setDtlsRole(e){this._mediaObject.setup="actpass"}resume(){this._mediaObject.direction="sendonly"}planBReceive({offerRtpParameters:e,streamId:t,trackId:s}){let i=e.encodings[0],n=i.ssrc,a=i.rtx&&i.rtx.ssrc?i.rtx.ssrc:void 0,o=this._mediaObject.payloads.split(" ");for(let d of e.codecs){if(o.includes(String(d.payloadType)))continue;let u={payload:d.payloadType,codec:Lr(d),rate:d.clockRate};d.channels>1&&(u.encoding=d.channels),this._mediaObject.rtp.push(u);let l={payload:d.payloadType,config:""};for(let p of Object.keys(d.parameters))l.config&&(l.config+=";"),l.config+=`${p}=${d.parameters[p]}`;l.config&&this._mediaObject.fmtp.push(l);for(let p of d.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:d.payloadType,type:p.type,subtype:p.parameter})}this._mediaObject.payloads+=` ${e.codecs.filter(d=>!this._mediaObject.payloads.includes(d.payloadType)).map(d=>d.payloadType).join(" ")}`,this._mediaObject.payloads=this._mediaObject.payloads.trim(),e.rtcp.cname&&this._mediaObject.ssrcs.push({id:n,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:n,attribute:"msid",value:`${t||"-"} ${s}`}),a&&(e.rtcp.cname&&this._mediaObject.ssrcs.push({id:a,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:a,attribute:"msid",value:`${t||"-"} ${s}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${n} ${a}`}))}planBStopReceiving({offerRtpParameters:e}){let t=e.encodings[0],s=t.ssrc,i=t.rtx&&t.rtx.ssrc?t.rtx.ssrc:void 0;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter(n=>n.id!==s&&n.id!==i),i&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter(n=>n.ssrcs!==`${s} ${i}`))}};A.OfferMediaSection=kr;function Lr(r){let t=new RegExp("^(audio|video)/(.+)","i").exec(r.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");return t[2]}});var As=b(te=>{"use strict";var zn=te&&te.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,i)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),Un=te&&te.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),Vn=te&&te.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&zn(e,r,t);return Un(e,r),e};Object.defineProperty(te,"__esModule",{value:!0});te.RemoteSdp=void 0;var Hn=Vn(It()),Qn=Z(),At=Fs(),Mr=new Qn.Logger("RemoteSdp"),jr=class{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,sctpParameters:i,plainRtpParameters:n,planB:a=!1}){if(this._mediaSections=[],this._midToIndex=new Map,this._iceParameters=e,this._iceCandidates=t,this._dtlsParameters=s,this._sctpParameters=i,this._plainRtpParameters=n,this._planB=a,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},e&&e.iceLite&&(this._sdpObject.icelite="ice-lite"),s){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};let o=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:s.fingerprints[o-1].algorithm,hash:s.fingerprints[o-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}n&&(this._sdpObject.origin.address=n.ip,this._sdpObject.origin.ipVer=n.ipVersion)}updateIceParameters(e){Mr.debug("updateIceParameters() [iceParameters:%o]",e),this._iceParameters=e,this._sdpObject.icelite=e.iceLite?"ice-lite":void 0;for(let t of this._mediaSections)t.setIceParameters(e)}updateDtlsRole(e){Mr.debug("updateDtlsRole() [role:%s]",e),this._dtlsParameters.role=e;for(let t of this._mediaSections)t.setDtlsRole(e)}getNextMediaSectionIdx(){for(let e=0;e<this._mediaSections.length;++e){let t=this._mediaSections[e];if(t.closed)return{idx:e,reuseMid:t.mid}}return{idx:this._mediaSections.length}}send({offerMediaObject:e,reuseMid:t,offerRtpParameters:s,answerRtpParameters:i,codecOptions:n,extmapAllowMixed:a=!1}){let o=new At.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:e,offerRtpParameters:s,answerRtpParameters:i,codecOptions:n,extmapAllowMixed:a});t?this._replaceMediaSection(o,t):this._midToIndex.has(o.mid)?this._replaceMediaSection(o):this._addMediaSection(o)}receive({mid:e,kind:t,offerRtpParameters:s,streamId:i,trackId:n}){let a=this._midToIndex.get(e),o;if(a!==void 0&&(o=this._mediaSections[a]),o)o.planBReceive({offerRtpParameters:s,streamId:i,trackId:n}),this._replaceMediaSection(o);else{o=new At.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:s,streamId:i,trackId:n});let d=this._mediaSections.find(u=>u.closed);d?this._replaceMediaSection(o,d.mid):this._addMediaSection(o)}}pauseMediaSection(e){this._findMediaSection(e).pause()}resumeSendingMediaSection(e){this._findMediaSection(e).resume()}resumeReceivingMediaSection(e){this._findMediaSection(e).resume()}disableMediaSection(e){this._findMediaSection(e).disable()}closeMediaSection(e){let t=this._findMediaSection(e);if(e===this._firstMid){Mr.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",e),this.disableMediaSection(e);return}t.close(),this._regenerateBundleMids()}planBStopReceiving({mid:e,offerRtpParameters:t}){let s=this._midToIndex.get(e);if(s===void 0)throw new Error(`no media section found with mid '${e}'`);let i=this._mediaSections[s];i.planBStopReceiving({offerRtpParameters:t}),this._replaceMediaSection(i)}sendSctpAssociation({offerMediaObject:e}){let t=new At.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:e});this._addMediaSection(t)}receiveSctpAssociation({oldDataChannelSpec:e=!1}={}){let t=new At.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:e});this._addMediaSection(t)}getSdp(){return this._sdpObject.origin.sessionVersion++,Hn.write(this._sdpObject)}_addMediaSection(e){this._firstMid||(this._firstMid=e.mid),this._mediaSections.push(e),this._midToIndex.set(e.mid,this._mediaSections.length-1),this._sdpObject.media.push(e.getObject()),this._regenerateBundleMids()}_replaceMediaSection(e,t){if(typeof t=="string"){let s=this._midToIndex.get(t);if(s===void 0)throw new Error(`no media section found for reuseMid '${t}'`);let i=this._mediaSections[s];this._mediaSections[s]=e,this._midToIndex.delete(i.mid),this._midToIndex.set(e.mid,s),this._sdpObject.media[s]=e.getObject(),this._regenerateBundleMids()}else{let s=this._midToIndex.get(e.mid);if(s===void 0)throw new Error(`no media section found with mid '${e.mid}'`);this._mediaSections[s]=e,this._sdpObject.media[s]=e.getObject()}}_findMediaSection(e){let t=this._midToIndex.get(e);if(t===void 0)throw new Error(`no media section found with mid '${e}'`);return this._mediaSections[t]}_regenerateBundleMids(){!this._dtlsParameters||(this._sdpObject.groups[0].mids=this._mediaSections.filter(e=>!e.closed).map(e=>e.mid).join(" "))}};te.RemoteSdp=jr});var Dr=b($t=>{"use strict";Object.defineProperty($t,"__esModule",{value:!0});$t.parse=void 0;var Gn=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");function Jn(r){let e=Gn.exec(r||"");return e?{spatialLayers:Number(e[1]),temporalLayers:Number(e[2])}:{spatialLayers:1,temporalLayers:1}}$t.parse=Jn});var qs=b(se=>{"use strict";var Wn=se&&se.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,i)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),Kn=se&&se.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),pt=se&&se.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&Wn(e,r,t);return Kn(e,r),e};Object.defineProperty(se,"__esModule",{value:!0});se.Cyxth0=void 0;var re=pt(It()),Zn=Z(),$s=pt(Ve()),Ke=pt(kt()),Bt=pt(Ds()),Ir=pt(Is()),Yn=Rr(),Xn=As(),ea=Dr(),y=new Zn.Logger("Cyxth0"),Bs={OS:1024,MIS:1024},ut=class extends Yn.HandlerInterface{static createFactory(){return()=>new ut}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Cyxth0"}close(){if(y.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){y.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");let t=await e.createOffer();try{e.close()}catch{}let s=re.parse(t.sdp);return Bt.extractRtpCapabilities({sdpObject:s})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return y.debug("getNativeSctpCapabilities()"),{numStreams:Bs}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:u,extendedRtpCapabilities:l}){y.debug("run()"),this._direction=e,this._remoteSdp=new Xn.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:Ke.getSendingRtpParameters("audio",l),video:Ke.getSendingRtpParameters("video",l)},this._sendingRemoteRtpParametersByKind={audio:Ke.getSendingRemoteRtpParameters("audio",l),video:Ke.getSendingRemoteRtpParameters("video",l)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...d},u),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})}async updateIceServers(e){y.debug("updateIceServers()");let t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(y.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){let t=await this._pc.createOffer({iceRestart:!0});y.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);let s={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{let t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let s=await this._pc.createAnswer();y.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:i}){var n;this._assertSendDirection(),y.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((x,L)=>{x.rid=`r${L}`});let a=$s.clone(this._sendingRtpParametersByKind[e.kind],{});a.codecs=Ke.reduceCodecs(a.codecs,i);let o=$s.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});o.codecs=Ke.reduceCodecs(o.codecs,i);let d=this._remoteSdp.getNextMediaSectionIdx(),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t}),l=await this._pc.createOffer(),p=re.parse(l.sdp),h;this._transportReady||await this._setupTransport({localDtlsRole:(n=this._forcedLocalDtlsRole)!==null&&n!==void 0?n:"client",localSdpObject:p});let f=!1,_=(0,ea.parse)((t||[{}])[0].scalabilityMode);t&&t.length===1&&_.spatialLayers>1&&a.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(y.debug("send() | enabling legacy simulcast for VP9 SVC"),f=!0,p=re.parse(l.sdp),h=p.media[d.idx],Ir.addLegacySimulcast({offerMediaObject:h,numStreams:_.spatialLayers}),l={type:"offer",sdp:re.write(p)}),y.debug("send() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l);let E=u.mid;if(a.mid=E,p=re.parse(this._pc.localDescription.sdp),h=p.media[d.idx],a.rtcp.cname=Bt.getCname({offerMediaObject:h}),!t)a.encodings=Ir.getRtpEncodings({offerMediaObject:h});else if(t.length===1){let x=Ir.getRtpEncodings({offerMediaObject:h});Object.assign(x[0],t[0]),f&&(x=[x[0]]),a.encodings=x}else a.encodings=t;if(a.encodings.length>1&&(a.codecs[0].mimeType.toLowerCase()==="video/vp8"||a.codecs[0].mimeType.toLowerCase()==="video/h264"))for(let x of a.encodings)x.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:h,reuseMid:d.reuseMid,offerRtpParameters:a,answerRtpParameters:o,codecOptions:s,extmapAllowMixed:!0});let m={type:"answer",sdp:this._remoteSdp.getSdp()};return y.debug("send() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._mapMidTransceiver.set(E,u),{localId:E,rtpParameters:a,rtpSender:u.sender}}async stopSending(e){this._assertSendDirection(),y.debug("stopSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null);try{t.stop()}catch{}this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid);let s=await this._pc.createOffer();y.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);let i={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i),this._mapMidTransceiver.delete(e)}async pauseSending(e){this._assertSendDirection(),y.debug("pauseSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);let s=await this._pc.createOffer();y.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);let i={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this._assertSendDirection(),y.debug("resumeSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";let s=await this._pc.createOffer();y.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);let i={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this._assertSendDirection(),t?y.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):y.debug("replaceTrack() [localId:%s, no track]",e);let s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),y.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);let s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");let i=s.sender.getParameters();i.encodings.forEach((n,a)=>{a<=t?n.active=!0:n.active=!1}),await s.sender.setParameters(i)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),y.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);let s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");let i=s.sender.getParameters();i.encodings.forEach((n,a)=>{i.encodings[a]={...n,...t}}),await s.sender.setParameters(i)}async getSenderStats(e){this._assertSendDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:i,protocol:n}){var a;this._assertSendDirection();let o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:n};y.debug("sendDataChannel() [options:%o]",o);let d=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Bs.MIS,!this._hasDataChannelMediaSection){let l=await this._pc.createOffer(),p=re.parse(l.sdp),h=p.media.find(_=>_.type==="application");this._transportReady||await this._setupTransport({localDtlsRole:(a=this._forcedLocalDtlsRole)!==null&&a!==void 0?a:"client",localSdpObject:p}),y.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",l),await this._pc.setLocalDescription(l),this._remoteSdp.sendSctpAssociation({offerMediaObject:h});let f={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",f),await this._pc.setRemoteDescription(f),this._hasDataChannelMediaSection=!0}let u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:u}}async receive(e){var t;this._assertRecvDirection();let s=[],i=new Map;for(let d of e){let{trackId:u,kind:l,rtpParameters:p}=d;y.debug("receive() [trackId:%s, kind:%s]",u,l);let h=p.mid||String(this._mapMidTransceiver.size);i.set(u,h),this._remoteSdp.receive({mid:h,kind:l,offerRtpParameters:p,streamId:p.rtcp.cname,trackId:u})}let n={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",n),await this._pc.setRemoteDescription(n);let a=await this._pc.createAnswer(),o=re.parse(a.sdp);for(let d of e){let{trackId:u,rtpParameters:l}=d,p=i.get(u),h=o.media.find(f=>String(f.mid)===p);Bt.applyCodecParameters({offerRtpParameters:l,answerMediaObject:h})}a={type:"answer",sdp:re.write(o)},this._transportReady||await this._setupTransport({localDtlsRole:(t=this._forcedLocalDtlsRole)!==null&&t!==void 0?t:"client",localSdpObject:o}),y.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(let d of e){let{trackId:u}=d,l=i.get(u),p=this._pc.getTransceivers().find(h=>h.mid===l);if(p)this._mapMidTransceiver.set(l,p),s.push({localId:l,track:p.receiver.track,rtpReceiver:p.receiver});else throw new Error("new RTCRtpTransceiver not found")}return s}async stopReceiving(e){this._assertRecvDirection();for(let i of e){y.debug("stopReceiving() [localId:%s]",i);let n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let s=await this._pc.createAnswer();y.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(let i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this._assertRecvDirection();for(let i of e){y.debug("pauseReceiving() [localId:%s]",i);let n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let s=await this._pc.createAnswer();y.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this._assertRecvDirection();for(let i of e){y.debug("resumeReceiving() [localId:%s]",i);let n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let s=await this._pc.createAnswer();y.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this._assertRecvDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){var i;this._assertRecvDirection();let{streamId:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d}=e,u={negotiated:!0,id:n,ordered:a,maxPacketLifeTime:o,maxRetransmits:d,protocol:s};y.debug("receiveDataChannel() [options:%o]",u);let l=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();let p={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",p),await this._pc.setRemoteDescription(p);let h=await this._pc.createAnswer();if(!this._transportReady){let f=re.parse(h.sdp);await this._setupTransport({localDtlsRole:(i=this._forcedLocalDtlsRole)!==null&&i!==void 0?i:"client",localSdpObject:f})}y.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setLocalDescription(h),this._hasDataChannelMediaSection=!0}return{dataChannel:l}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=re.parse(this._pc.localDescription.sdp));let s=Bt.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:s},i,n)}),this._transportReady=!0}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};se.Cyxth0=ut});var Ar=b(z=>{"use strict";var ta=z&&z.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,i)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),ra=z&&z.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),Ns=z&&z.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&ta(e,r,t);return ra(e,r),e};Object.defineProperty(z,"__esModule",{value:!0});z.Device=z.detectDevice=void 0;var sa=Z(),ia=fe(),Ze=Te(),na=Ns(Ve()),_e=Ns(kt()),aa=Sr(),oa=qs(),B=new sa.Logger("Device");function zs(){if(typeof navigator=="object"&&typeof navigator.userAgent=="string")return"Cyxth0";B.warn("this._detectDevice() | browser not supported")}z.detectDevice=zs;var Fr=class{constructor({handlerName:e,handlerFactory:t,Handler:s}={}){if(this._loaded=!1,this._observer=new ia.EnhancedEventEmitter,B.debug("constructor()"),s)if(B.warn("constructor() | Handler option is DEPRECATED, use handlerName or handlerFactory instead"),typeof s=="string")e=s;else throw new TypeError("non string Handler option no longer supported, use handlerFactory instead");if(e&&t)throw new TypeError("just one of handlerName or handlerInterface can be given");if(t)this._handlerFactory=t;else{if(e)B.debug("constructor() | handler given: %s",e);else if(e=zs(),e)B.debug("constructor() | detected handler: %s",e);else throw new Ze.UnsupportedError("device not supported");this._handlerFactory=oa.Cyxth0.createFactory()}let i=this._handlerFactory();this._handlerName=i.name,i.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new Ze.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new Ze.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:e}){B.debug("load() [routerRtpCapabilities:%o]",e),e=na.clone(e,void 0);let t;try{if(this._loaded)throw new Ze.InvalidStateError("already loaded");_e.validateRtpCapabilities(e),t=this._handlerFactory();let s=await t.getNativeRtpCapabilities();B.debug("load() | got native RTP capabilities:%o",s),_e.validateRtpCapabilities(s),this._extendedRtpCapabilities=_e.getExtendedRtpCapabilities(s,e),B.debug("load() | got extended RTP capabilities:%o",this._extendedRtpCapabilities),this._canProduceByKind.audio=_e.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=_e.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=_e.getRecvRtpCapabilities(this._extendedRtpCapabilities),_e.validateRtpCapabilities(this._recvRtpCapabilities),B.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._sctpCapabilities=await t.getNativeSctpCapabilities(),B.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),_e.validateSctpCapabilities(this._sctpCapabilities),B.debug("load() succeeded"),this._loaded=!0,t.close()}catch(s){throw t&&t.close(),s}}canProduce(e){if(this._loaded){if(e!=="audio"&&e!=="video")throw new TypeError(`invalid kind "${e}"`)}else throw new Ze.InvalidStateError("not loaded");return this._canProduceByKind[e]}createSendTransport({id:e,iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:u,appData:l}){return B.debug("createSendTransport()"),this._createTransport({direction:"send",id:e,iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:u,appData:l})}createRecvTransport({id:e,iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:u,appData:l}){return B.debug("createRecvTransport()"),this._createTransport({direction:"recv",id:e,iceParameters:t,iceCandidates:s,dtlsParameters:i,sctpParameters:n,iceServers:a,iceTransportPolicy:o,additionalSettings:d,proprietaryConstraints:u,appData:l})}_createTransport({direction:e,id:t,iceParameters:s,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:l,appData:p}){if(this._loaded){if(typeof t!="string")throw new TypeError("missing id");if(typeof s!="object")throw new TypeError("missing iceParameters");if(Array.isArray(i)){if(typeof n!="object")throw new TypeError("missing dtlsParameters");if(a&&typeof a!="object")throw new TypeError("wrong sctpParameters");if(p&&typeof p!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing iceCandidates")}else throw new Ze.InvalidStateError("not loaded");let h=new aa.Transport({direction:e,id:t,iceParameters:s,iceCandidates:i,dtlsParameters:n,sctpParameters:a,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:l,appData:p,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",h),h}};z.Device=Fr});var Vs=b(Us=>{"use strict";Object.defineProperty(Us,"__esModule",{value:!0})});var Qs=b(Hs=>{"use strict";Object.defineProperty(Hs,"__esModule",{value:!0})});var Gs=b(j=>{"use strict";var ca=j&&j.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,i)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),ie=j&&j.__exportStar||function(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&ca(e,r,t)};Object.defineProperty(j,"__esModule",{value:!0});ie(Ar(),j);ie(Sr(),j);ie(fr(),j);ie(gr(),j);ie(yr(),j);ie(wr(),j);ie(Vs(),j);ie(Qs(),j);ie(Rr(),j);ie(Te(),j)});var Ws=b(R=>{"use strict";var da=R&&R.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,i)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),la=R&&R.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),ua=R&&R.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&da(e,r,t);return la(e,r),e},pa=R&&R.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(R,"__esModule",{value:!0});R.debug=R.parseScalabilityMode=R.detectDevice=R.Device=R.version=R.types=void 0;var ha=pa(tt());R.debug=ha.default;var Js=Ar();Object.defineProperty(R,"Device",{enumerable:!0,get:function(){return Js.Device}});Object.defineProperty(R,"detectDevice",{enumerable:!0,get:function(){return Js.detectDevice}});var fa=ua(Gs());R.types=fa;R.version="__MEDIASOUP_CLIENT_VERSION__";var ma=Dr();Object.defineProperty(R,"parseScalabilityMode",{enumerable:!0,get:function(){return ma.parse}})});var N=class{constructor(){this.callbacks={}}on(e,t){this.callbacks[e]=t}dispatch(e,t){let s=this.callbacks[e];s&&s(t)}off(e){this.callbacks[e]&&delete this.callbacks[e]}clearAllEvents(){this.callbacks={}}cleaEvents(e){e.forEach(t=>{this.off(t)})}};var pe=(r=21)=>{let e="1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",t=e.length,s=[];for(let i=0;i<r;i++)s.push(e[Math.round(Math.random()*100)%t]);return s.join("")};var I,je,_t,zr,Nr=class{constructor(e){w(this,_t);w(this,I,void 0);w(this,je,void 0);T(this,I,e),this.eventEmmiter=new N,T(this,je,[]),S(this,_t,zr).call(this)}onOpen(){for(this.eventEmmiter.dispatch("transportReady",{});c(this,je).length>0;){let e=c(this,je).pop();e&&c(this,I).send(e)}}waitOpen(){return new Promise((t,s)=>{let i="transportReady",n=setTimeout(()=>{this.eventEmmiter.off(i),s(new Error("ConnectionTimeout"))},1e4);this.eventEmmiter.on(i,()=>{this.eventEmmiter.off(i),clearTimeout(n),t(!0)})})}onClose(){}onError(e){console.error("transport disconected")}onMessage(e){let t;try{t=new Ee(e.data).parse()}catch(s){console.log("message parser error",s);return}if(t?.type==="message")this.eventEmmiter.dispatch("message",t.data);else if(t?.type==="reply"){if(t.reply){let{channel_trail:s,data_back:i}=t.reply;this.eventEmmiter.dispatch(`reply:${s}`,i)}}else if(t?.type==="error"){let{command:s,data:i}=t.data;this.eventEmmiter.dispatch(s,i)}else{let{command:s,data:i}=t.data;this.eventEmmiter.dispatch(s,i)}}__encMsg(e){let t=new TextEncoder().encode(e);return{len:t.byteLength,view:t}}send(e){let t=new TextEncoder().encode(e);c(this,I).send(t)}cend(e,t,s=!0){let i=JSON.stringify(t),n=pe(12),{len:a,view:o}=this.__encMsg(i),d=`#${e}\r
@${n}\r
$${a}\r
`,u=new Uint8Array(d.length+a+2);return u.set(new TextEncoder().encode(d)),u.set(o,d.length),u.set(`\r
`.split("").map(l=>l.charCodeAt(0)),u.length-2),c(this,I).send(u),s?this.sendPromise(`${e}:${n}`,1e4):new Promise((l,p)=>{l(!0)})}cendBin(e,t){let s=pe(12),i=t.byteLength,n=`#${e}\r
@${s}\r
%${i}\r
`,a=new Uint8Array(n.length+i+2);return a.set(new TextEncoder().encode(n)),a.set(t,n.length),a.set(`\r
`.split("").map(o=>o.charCodeAt(0)),a.length-2),c(this,I).send(a),this.sendPromise(`${e}:${s}`,1e4)}sendm(e,t){let s=pe(12),i=JSON.stringify(t),{len:n,view:a}=this.__encMsg(i),o=`>${e}\r
@${s}\r
$${n}\r
`,d=new Uint8Array(o.length+n+2);return d.set(new TextEncoder().encode(o)),d.set(a,o.length),d.set(`\r
`.split("").map(u=>u.charCodeAt(0)),d.length-2),c(this,I).send(d),this.sendPromise(`reply:${e}:${s}`,1e4)}sendPromise(e,t=0){return new Promise((i,n)=>{let a=setTimeout(()=>{},0);t>0&&(a=setTimeout(()=>{this.eventEmmiter.off(e),n(new Error("Timeout"))},t)),this.eventEmmiter.on(e,o=>{if(this.eventEmmiter.off(e),clearTimeout(a),typeof o=="string"){let d=JSON.parse(o);d.error&&n(new Error(d.error)),i(d)}else typeof o=="object"&&o?.byteLength!==void 0&&i(o)})})}on(e,t){this.eventEmmiter.on(e,t)}disconnect(){return c(this,I).close(),!0}};I=new WeakMap,je=new WeakMap,_t=new WeakSet,zr=function(){c(this,I).binaryType="arraybuffer",c(this,I).onmessage=e=>this.onMessage(e),c(this,I).onerror=e=>this.onError(e),c(this,I).onclose=()=>this.onClose(),c(this,I).onopen=()=>this.onOpen()};var K,vt,Ur,yt=class{constructor(e){w(this,vt);w(this,K,void 0);this.eventEmmiter=new N,T(this,K,e),S(this,vt,Ur).call(this)}waitOpen(){return c(this,K).ready.then(()=>!0).catch(e=>!1)}send(e){console.log("send -> ",e),c(this,K).createUnidirectionalStream().then(t=>{this.writeTo(e,t,!0)}).catch(t=>{console.error("error creating a new stream")})}cend(e,t,s=!0){let i=JSON.stringify(t),n=pe(12),a=`#${e}\r
@${n}\r
$${i.length}\r
${i}\r
`;return this.send(a),this.sendPromise(`${e}:${n}`,1e4)}cendBin(e,t){let s=pe(12),i=t.byteLength,n=`#${e}\r
@${s}\r
$${i}\r
$`,o=new TextEncoder().encode(n),d=o.byteLength+i,u=new Uint8Array(d);return u.set(o,0),u.set(t,o.byteLength),console.log(u),this.sendPromise(`${e}:${s}`,1e4)}sendm(e,t){let s=pe(12),i=JSON.stringify(t);return i=`>${e}\r
@${s}\r
$${i.length}\r
${i}\r
`,this.send(i),this.sendPromise(`reply:${e}:${s}`,1e4)}disconnect(){return c(this,K).close(),!0}on(e,t){this.eventEmmiter.on(e,t)}sendPromise(e,t=0){return new Promise((i,n)=>{let a=setTimeout(()=>{},0);t>0&&(a=setTimeout(()=>{this.eventEmmiter.off(e),n(new Error("Timeout"))},t)),this.eventEmmiter.on(e,o=>{this.eventEmmiter.off(e),clearTimeout(a);let d=JSON.parse(o);d.error&&n(new Error(d.error)),i(d)})})}writeTo(e,t,s=!1){console.log(t);let i=t.getWriter(),a=new TextEncoder().encode(e,{stream:!0});i.write(a).then(()=>{console.log("written")}).catch(o=>{console.error("error writing",o)}),s&&i.ready.then(()=>{i.close().then(()=>{console.log("writer closed")}).catch(o=>{console.error("error closing writer",o)})})}async readFrom(e){let t=e.getReader();try{for(;;){let{value:s,done:i}=await t.read();if(i){console.log("[readFrom] stream was closed");return}this.onMessage(s.buffer)}}catch(s){console.error("[readFrom] error while reading from stream",s)}}async acceptUnidirectionalstreams(){let e=c(this,K).incomingUnidirectionalStreams.getReader();try{for(;;){let{value:t,done:s}=await e.read();if(s){console.log("done accepting unidirectional streams");return}this.readFrom(t)}}catch{console.error("error in uni accept loop")}}onMessage(e){let t=new Ee(e).parse();if(console.log("got a message fr",t),t?.type==="message")this.eventEmmiter.dispatch("message",t.data);else if(t?.type==="reply"){if(t.reply){let{channel_trail:s,data_back:i}=t.reply;this.eventEmmiter.dispatch(`reply:${s}`,i)}}else if(t?.type==="error"){let{command:s,data:i}=t.data;this.eventEmmiter.dispatch(s,i)}else{let{command:s,data:i}=t.data;this.eventEmmiter.dispatch(s,i)}}};K=new WeakMap,vt=new WeakSet,Ur=function(){c(this,K).closed.then(()=>{}).catch(t=>{});let e=c(this,K).createUnidirectionalStream().then(t=>{}).catch(t=>{});this.acceptUnidirectionalstreams()};var he=class{constructor(e,t=!0){this.enabled=t,this.module=e}d(e,...t){this.enabled&&(t.length?console.log(`%cDEBUG:%c[${this.module}]%c  ${e}`,"color:yellow;font-size:12px","color:greenyellow;font-size:12px","color:",...t):console.log(`%cDEBUG:%c[${this.module}]%c  ${e}`,"color:yellow;font-size:12px","color:greenyellow;font-size:12px","color:"))}};var De=class{static enqueue(e){return new Promise((t,s)=>{this.queue.push({promise:e,resolve:t,reject:s}),this.dequeue()})}static dequeue(){if(this.workingOnPromise)return!1;if(this.stop){this.queue=[],this.stop=!1;return}let e=this.queue.shift();if(!e)return!1;try{this.workingOnPromise=!0,e.promise().then(t=>{this.workingOnPromise=!1,e.resolve(t),this.dequeue()}).catch(t=>{this.workingOnPromise=!1,e.reject(t),this.dequeue()})}catch(t){this.workingOnPromise=!1,e.reject(t),this.dequeue()}return!0}};De.queue=[],De.pendingPromise=!1,De.stop=!1;var Ee=class{constructor(e){this.raw=e,this.data=new DataView(e),this.position=0,this.len=this.data.byteLength,this.remaining=this.data.byteLength}parse(){switch(this.getByte()){case"-":this.getBlock();let t=this.bulkText();if(!t)throw"parseFail";return{type:"error",data:{info:JSON.parse(new TextDecoder().decode(t.res))}};case">":let i=this.strBlock().split(":");if(i.length!=2)throw"parseFail";let[n,a]=i;if(this.getByte()!=="@")throw"parseFail";let d=this.strBlock(),u=this.bulkText();if(!u)throw"parseFail";return{type:"message",data:{channel:n,sender:a,message_id:d,text:new TextDecoder().decode(u.res)}};case"<":let l=this.strBlock(),p=this.bulkText();if(!p)throw"parseFail";return{type:"reply",reply:{channel_trail:l,data_back:new TextDecoder().decode(p.res)}};case"#":let h=this.strBlock(),f=this.bulkText();if(!f)throw"parseFail";return f.isBin?{type:"command",data:{command:h,data:f.res}}:{type:"command",data:{command:h,data:new TextDecoder().decode(f.res)}};default:throw"parseFail"}}getByte(){if(!this.len)return 0;let e=this.data.getUint8(this.position);return this.position+=1,String.fromCodePoint(e)}getBlock(){let e=this.position,t=this.len-1;for(let s=e;s<=t;s++){let i=n=>this.data.getUint8(n);if(i(s)===13&&i(s+1)===10){let n=this.raw.slice(e,s);return this.position=s+2,n}}return new ArrayBuffer(0)}bulkText(){let e=this.getByte();if(e!="$"&&e!="%")return null;let t=parseInt(this.strBlock());if(isNaN(t))return null;let s=t+2;return this.remaining<s?null:{isBin:e==="%",res:this.getBlock()}}strBlock(){let e=this.getBlock();return new TextDecoder().decode(e)}};var Ks=di(Ws(),1);var Q,ne,G,qt=class{constructor(){w(this,Q,void 0);w(this,ne,void 0);w(this,G,void 0);T(this,Q,new Map),T(this,ne,new Map),T(this,G,new N)}addProducer(e,t,s){let i=!1,n=c(this,ne).get(s);n?n.add(e):(c(this,ne).set(s,new Set([e])),i=!0),c(this,Q).set(e,{userId:s,consumer:t}),i?c(this,G).dispatch("join",{userId:s,...this.createMediaStream(s)}):c(this,G).dispatch("update",{kind:t.kind,action:"on",userId:s,...this.createMediaStream(s)})}removeProducer(e){let t=c(this,Q).get(e);if(t){let s=t.userId;c(this,ne).get(s)?.delete(e);let i=t.consumer.kind;c(this,Q).delete(e),c(this,G).dispatch("update",{kind:i,action:"off",userId:s,...this.createMediaStream(s)})}}pause(e){let t=c(this,Q).get(e);t&&(t.consumer.pause(),c(this,G).dispatch("update",{kind:t.consumer.kind,action:"mute",userId:t.userId}))}resume(e){let t=c(this,Q).get(e);t&&(t.consumer.resume(),c(this,G).dispatch("update",{kind:t.consumer.kind,action:"unmute",userId:t.userId}))}removeUser(e){c(this,ne).get(e)?.forEach(s=>{c(this,Q).delete(s)}),c(this,ne).delete(e),c(this,G).dispatch("leave",{userId:e})}getTracks(e){let t=c(this,ne).get(e);if(!t)return[];let s=[];return t.forEach(i=>{let n=c(this,Q).get(i);n&&s.push(n.consumer.track)}),s}createMediaStream(e){let t=new MediaStream;return this.getTracks(e).forEach(i=>{t.addTrack(i)}),console.log("trackies a/v",t.getAudioTracks().length,t.getVideoTracks().length),{stream:t,audio:t.getAudioTracks().length>0,video:t.getVideoTracks().length>0}}on(e,t){c(this,G).on(e,t)}};Q=new WeakMap,ne=new WeakMap,G=new WeakMap;var ue,ve,C,we,Oe,be,D,ae,U,Nt,Zs,zt,Ys,Ut,Xs,Vt,ei,Ht,ti,ft,$r,q,J,oe,ye,ht=class{constructor(e,t,s,i,n,a){w(this,Nt);w(this,zt);w(this,Ut);w(this,Vt);w(this,Ht);w(this,ft);w(this,q);w(this,oe);w(this,ue,void 0);w(this,ve,void 0);w(this,C,void 0);w(this,we,void 0);w(this,Oe,void 0);w(this,be,void 0);w(this,D,void 0);w(this,ae,void 0);w(this,U,void 0);T(this,ue,e),T(this,C,new he("calls|v2",!0)),T(this,ve,a),this.channel=t,this.options=s,this.state=i,this.stream=n,T(this,we,new Ks.Device),T(this,U,new qt),S(this,Nt,Zs).call(this)}async initiate(e){this.options=e;try{let t=await navigator.mediaDevices.getUserMedia(e);this.stream=t;let s={src:this.stream,mic:t.getAudioTracks().length>0,video:t.getVideoTracks().length>0};c(this,ve).dispatch("connected",s),S(this,oe,ye).call(this,{mic:s.mic,camera:s.video})}catch(t){c(this,C).d("gum error",t);return}}async start(e){if(e.error)throw e;try{await c(this,we).load({routerRtpCapabilities:e.rtpc}),await S(this,zt,Ys).call(this)}catch(t){c(this,C).d("error loading device and transports",t)}}async micOn(){S(this,oe,ye).call(this,{mic:!0});let e=this.stream.getAudioTracks()[0];if(!e)try{e=(await navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0],this.stream.addTrack(e)}catch{}try{let t=await c(this,Oe)?.produce({track:e});t?.on("transportclose",()=>{c(this,C).d("mic producer transport close dosth")}),t?.on("trackended",()=>{c(this,C).d("mic producer track ended")}),T(this,D,t)}catch(t){c(this,C).d("error producing => ",t)}}async micOff(){if(S(this,oe,ye).call(this,{mic:!1}),!c(this,D))return;let e=c(this,D).track?.id;c(this,D).close(),this.stream.getAudioTracks().forEach(t=>{t.id==e&&this.stream.removeTrack(t)}),S(this,q,J).call(this,"producer-close","handle",{id:c(this,D).id,action:"close"}).then(t=>{c(this,C).d("mic off status",t)}).catch(t=>{c(this,C).d("failed to close server side mic",t)}),T(this,D,void 0)}async toggleMute(e=!0){if(!c(this,D))return;if(e){if(c(this,D).paused)return;c(this,D).pause(),S(this,oe,ye).call(this,{mic:"muted"})}else{if(!c(this,D).paused)return;c(this,D).resume(),S(this,oe,ye).call(this,{mic:!0})}let t=e?"pause":"resume";S(this,q,J).call(this,`producer-${t}`,"handle",{id:c(this,D).id,action:t}).then(s=>{c(this,C).d("toggle mute status",s)}).catch(s=>{c(this,C).d("failed to mute/unmute server side mic",s)})}async camOn(){let e=this.stream.getVideoTracks()[0];if(!e)try{e=(await navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0],this.stream.addTrack(e)}catch{c(this,C).d("error creating a video track")}S(this,oe,ye).call(this,{camera:!0});try{let t=await c(this,Oe)?.produce({track:e});t?.on("transportclose",()=>{c(this,C).d("cam producer transport close dosth")}),t?.on("trackended",()=>{c(this,C).d("cam producer track ended")}),T(this,ae,t)}catch(t){c(this,C).d("error producing camera => ",t)}}async camOff(){if(!c(this,ae))return;let e=c(this,ae).track?.id;c(this,ae).close(),this.stream.getVideoTracks().forEach(t=>{t.id==e&&this.stream.removeTrack(t)}),S(this,oe,ye).call(this,{camera:!1}),S(this,q,J).call(this,"producer-close","handle",{id:c(this,ae).id,action:"close"}).then(t=>{c(this,C).d("cam off status",t)}).catch(t=>{c(this,C).d("failed to close server side cam")}),T(this,ae,void 0)}async end(){c(this,Oe)?.close(),c(this,be)?.close(),T(this,D,void 0),T(this,ae,void 0),this.stream.getTracks().forEach(e=>e.stop()),this.stream=new MediaStream,c(this,ue).cend("call:leave",{channel:this.channel}).catch(e=>{})}};ue=new WeakMap,ve=new WeakMap,C=new WeakMap,we=new WeakMap,Oe=new WeakMap,be=new WeakMap,D=new WeakMap,ae=new WeakMap,U=new WeakMap,Nt=new WeakSet,Zs=function(){c(this,ue).on("cl-leave",e=>{let t=JSON.parse(e);c(this,U).removeUser(t.userId)}),c(this,ue).on("cs-sync",e=>{let t=JSON.parse(e);switch(c(this,C).d("got a cs-sync",e),t.action){case"close":c(this,U).removeProducer(t.id);break;case"pause":c(this,U).pause(t.id);break;case"resume":c(this,U).resume(t.id);break}}),c(this,ue).on("cl-producer-add",e=>{let t=JSON.parse(e);S(this,ft,$r).call(this,t)}),c(this,U).on("join",e=>{c(this,ve).dispatch("join",e)}),c(this,U).on("leave",e=>c(this,ve).dispatch("leave",e)),c(this,U).on("update",e=>c(this,ve).dispatch("update",e))},zt=new WeakSet,Ys=async function(){try{let e=await S(this,q,J).call(this,"transports","transports",{send:!0,recv:!0});if(e.error)throw e;e.send&&S(this,Ut,Xs).call(this,e.send),e.recv&&S(this,Vt,ei).call(this,e.recv)}catch(e){c(this,C).d("error setting up transports",e)}},Ut=new WeakSet,Xs=async function(e){let t=c(this,we).createSendTransport(e);t.on("connect",({dtlsParameters:s},i,n)=>{c(this,C).d("send transport connect"),S(this,q,J).call(this,"connect-send","connect",{dtlsParameters:s,transport:"send"}).then(()=>i()).catch(n)}),t.on("produce",(s,i,n)=>{c(this,C).d("send transport produce"),S(this,q,J).call(this,"produce","produce",{kind:s.kind,rtpParameters:s.rtpParameters}).then(a=>i(a)).catch(n)}),T(this,Oe,t),S(this,Ht,ti).call(this)},Vt=new WeakSet,ei=async function(e){let t=c(this,we).createRecvTransport(e);t.on("connect",({dtlsParameters:s},i,n)=>{S(this,q,J).call(this,"connect-recv","connect",{dtlsParameters:s,transport:"recv"}).then(()=>i()).catch(n)}),S(this,q,J).call(this,"producers","producers",{}).then(s=>{c(this,C).d("producers already in room are -> ",s);for(let[i,n]of Object.entries(s))n.forEach(a=>{S(this,ft,$r).call(this,{id:a.id,user_id:i})})}).catch(s=>{c(this,C).d("error fetching producers in room")}),T(this,be,t)},Ht=new WeakSet,ti=async function(){this.options.audio&&await this.micOn(),this.options.video&&await this.camOn()},ft=new WeakSet,$r=async function(e){if(!c(this,be)){c(this,C).d("can't consume new producer, no recv transport");return}S(this,q,J).call(this,"consume","consume",{id:e.id,rtpCapabilities:c(this,we).rtpCapabilities}).then(async t=>{if(t.error){c(this,C).d("error in consume parameters");return}if(!c(this,be)){c(this,C).d("can't consume new producer, no recv transport");return}let s=await c(this,be).consume(t);c(this,U).addProducer(e.id,s,e.user_id),S(this,q,J).call(this,"resume","resume",{id:s.id}).then(()=>{c(this,C).d("resumed consumer")}).catch(i=>{c(this,C).d("failed to resume consumer")})}).catch(t=>{c(this,C).d("error consuming",t,e)})},q=new WeakSet,J=function(e,t,s){return c(this,ue).cend(`call:${e}`,{channel:this.channel,data:{tag:t,...s}})},oe=new WeakSet,ye=function(e){this.state={...this.state,...e}};var Ye,Xe,ke,F,Br=class{constructor(e,t){w(this,Ye,void 0);w(this,Xe,void 0);w(this,ke,void 0);w(this,F,void 0);T(this,Ye,e),T(this,Xe,new N),T(this,ke,new he("calls|v2",!0)),this.options={video:!0,audio:!0},this.state={camera:!1,mic:!1},this.stream=new MediaStream,this.channel=t,T(this,F,new ht(e,t,this.options,this.state,this.stream,c(this,Xe)))}async start(e){await c(this,F).initiate(e),c(this,Ye).cend("call:init",{channel:this.channel,options:e}).then(t=>c(this,F).start(t)).catch(t=>{c(this,ke).d("failed to init call",t)})}join(e){c(this,F).initiate(e).then(()=>{c(this,Ye).cend("call:start",{channel:this.channel,options:e}).then(t=>c(this,F).start(t)).catch(t=>{c(this,ke).d("failed to join the call",t)})}).catch(t=>{c(this,ke).d("error joining call")})}micOn(){c(this,F).micOn()}micOff(){c(this,F).micOff()}cameraOn(){c(this,F).camOn()}cameraOff(){c(this,F).camOff()}mute(){c(this,F).toggleMute()}unmute(){c(this,F).toggleMute(!1)}endCall(){c(this,F).end()}leave(){console.log("leaving the call")}moderate(){}on(e,t){c(this,Xe).on(e,t)}static pluginId(){return"calls"}};Ye=new WeakMap,Xe=new WeakMap,ke=new WeakMap,F=new WeakMap;export{Br as default};
