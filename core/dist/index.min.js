var A=(l,e,t)=>{if(!e.has(l))throw TypeError("Cannot "+t)};var o=(l,e,t)=>(A(l,e,"read from private field"),t?t.call(l):e.get(l)),u=(l,e,t)=>{if(e.has(l))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(l):e.set(l,t)},p=(l,e,t,r)=>(A(l,e,"write to private field"),r?r.call(l,t):e.set(l,t),t);var B=(l,e,t)=>(A(l,e,"access private method"),t);var g=class{constructor(){this.callbacks={}}on(e,t){this.callbacks[e]=t}dispatch(e,t){let r=this.callbacks[e];r&&r(t)}off(e){this.callbacks[e]&&delete this.callbacks[e]}clearAllEvents(){this.callbacks={}}cleaEvents(e){e.forEach(t=>{this.off(t)})}};var y=(l=21)=>{let e="1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",t=e.length,r=[];for(let n=0;n<l;n++)r.push(e[Math.round(Math.random()*100)%t]);return r.join("")};function W(l){return l.toString(16).padStart(2,"0")}function U(l){var e=new Uint8Array((l||40)/2);return window.crypto.getRandomValues(e),Array.from(e,W).join("")}var m,v,C,D,F=class{constructor(e){u(this,C);u(this,m,void 0);u(this,v,void 0);p(this,m,e),this.eventEmmiter=new g,p(this,v,[]),B(this,C,D).call(this)}onOpen(){for(this.eventEmmiter.dispatch("transportReady",{});o(this,v).length>0;){let e=o(this,v).pop();e&&o(this,m).send(e)}}waitOpen(){return new Promise((t,r)=>{let n="transportReady",s=setTimeout(()=>{this.eventEmmiter.off(n),r(new Error("ConnectionTimeout"))},1e4);this.eventEmmiter.on(n,()=>{this.eventEmmiter.off(n),clearTimeout(s),t(!0)})})}onClose(){}onError(e){console.error("transport disconected")}onMessage(e){let t;try{t=new E(e.data).parse()}catch(r){console.log("message parser error",r);return}if(t?.type==="message")this.eventEmmiter.dispatch("message",t.data);else if(t?.type==="reply"){if(t.reply){let{channel_trail:r,data_back:n}=t.reply;this.eventEmmiter.dispatch(`reply:${r}`,n)}}else if(t?.type==="error"){let{command:r,data:n}=t.data;this.eventEmmiter.dispatch(r,n)}else{let{command:r,data:n}=t.data;this.eventEmmiter.dispatch(r,n)}}__encMsg(e){let t=new TextEncoder().encode(e);return{len:t.byteLength,view:t}}send(e){let t=new TextEncoder().encode(e);o(this,m).send(t)}cend(e,t,r=!0){let n=JSON.stringify(t),s=y(12),{len:a,view:i}=this.__encMsg(n),c=`#${e}\r
@${s}\r
$${a}\r
`,h=new Uint8Array(c.length+a+2);return h.set(new TextEncoder().encode(c)),h.set(i,c.length),h.set(`\r
`.split("").map(b=>b.charCodeAt(0)),h.length-2),o(this,m).send(h),r?this.sendPromise(`${e}:${s}`,1e4):new Promise((b,k)=>{b(!0)})}cendBin(e,t){let r=y(12),n=t.byteLength,s=`#${e}\r
@${r}\r
%${n}\r
`,a=new Uint8Array(s.length+n+2);return a.set(new TextEncoder().encode(s)),a.set(t,s.length),a.set(`\r
`.split("").map(i=>i.charCodeAt(0)),a.length-2),o(this,m).send(a),this.sendPromise(`${e}:${r}`,1e4)}sendm(e,t){let r=y(12),n=JSON.stringify(t),{len:s,view:a}=this.__encMsg(n),i=`>${e}\r
@${r}\r
$${s}\r
`,c=new Uint8Array(i.length+s+2);return c.set(new TextEncoder().encode(i)),c.set(a,i.length),c.set(`\r
`.split("").map(h=>h.charCodeAt(0)),c.length-2),o(this,m).send(c),this.sendPromise(`reply:${e}:${r}`,1e4)}sendPromise(e,t=0){return new Promise((n,s)=>{let a=setTimeout(()=>{},0);t>0&&(a=setTimeout(()=>{this.eventEmmiter.off(e),s(new Error("Timeout"))},t)),this.eventEmmiter.on(e,i=>{if(this.eventEmmiter.off(e),clearTimeout(a),typeof i=="string"){let c=JSON.parse(i);c.error&&s(new Error(c.error)),n(c)}else typeof i=="object"&&i?.byteLength!==void 0&&n(i)})})}on(e,t){this.eventEmmiter.on(e,t)}disconnect(){return o(this,m).close(),!0}};m=new WeakMap,v=new WeakMap,C=new WeakSet,D=function(){o(this,m).binaryType="arraybuffer",o(this,m).onmessage=e=>this.onMessage(e),o(this,m).onerror=e=>this.onError(e),o(this,m).onclose=()=>this.onClose(),o(this,m).onopen=()=>this.onOpen()};var S=F;var f,O,I,T=class{constructor(e){u(this,O);u(this,f,void 0);this.eventEmmiter=new g,p(this,f,e),B(this,O,I).call(this)}waitOpen(){return o(this,f).ready.then(()=>!0).catch(e=>!1)}send(e){console.log("send -> ",e),o(this,f).createUnidirectionalStream().then(t=>{this.writeTo(e,t,!0)}).catch(t=>{console.error("error creating a new stream")})}cend(e,t,r=!0){let n=JSON.stringify(t),s=y(12),a=`#${e}\r
@${s}\r
$${n.length}\r
${n}\r
`;return this.send(a),this.sendPromise(`${e}:${s}`,1e4)}cendBin(e,t){let r=y(12),n=t.byteLength,s=`#${e}\r
@${r}\r
$${n}\r
$`,i=new TextEncoder().encode(s),c=i.byteLength+n,h=new Uint8Array(c);return h.set(i,0),h.set(t,i.byteLength),console.log(h),this.sendPromise(`${e}:${r}`,1e4)}sendm(e,t){let r=y(12),n=JSON.stringify(t);return n=`>${e}\r
@${r}\r
$${n.length}\r
${n}\r
`,this.send(n),this.sendPromise(`reply:${e}:${r}`,1e4)}disconnect(){return o(this,f).close(),!0}on(e,t){this.eventEmmiter.on(e,t)}sendPromise(e,t=0){return new Promise((n,s)=>{let a=setTimeout(()=>{},0);t>0&&(a=setTimeout(()=>{this.eventEmmiter.off(e),s(new Error("Timeout"))},t)),this.eventEmmiter.on(e,i=>{this.eventEmmiter.off(e),clearTimeout(a);let c=JSON.parse(i);c.error&&s(new Error(c.error)),n(c)})})}writeTo(e,t,r=!1){console.log(t);let n=t.getWriter(),a=new TextEncoder().encode(e,{stream:!0});n.write(a).then(()=>{console.log("written")}).catch(i=>{console.error("error writing",i)}),r&&n.ready.then(()=>{n.close().then(()=>{console.log("writer closed")}).catch(i=>{console.error("error closing writer",i)})})}async readFrom(e){let t=e.getReader();try{for(;;){let{value:r,done:n}=await t.read();if(n){console.log("[readFrom] stream was closed");return}this.onMessage(r.buffer)}}catch(r){console.error("[readFrom] error while reading from stream",r)}}async acceptUnidirectionalstreams(){let e=o(this,f).incomingUnidirectionalStreams.getReader();try{for(;;){let{value:t,done:r}=await e.read();if(r){console.log("done accepting unidirectional streams");return}this.readFrom(t)}}catch{console.error("error in uni accept loop")}}onMessage(e){let t=new E(e).parse();if(console.log("got a message fr",t),t?.type==="message")this.eventEmmiter.dispatch("message",t.data);else if(t?.type==="reply"){if(t.reply){let{channel_trail:r,data_back:n}=t.reply;this.eventEmmiter.dispatch(`reply:${r}`,n)}}else if(t?.type==="error"){let{command:r,data:n}=t.data;this.eventEmmiter.dispatch(r,n)}else{let{command:r,data:n}=t.data;this.eventEmmiter.dispatch(r,n)}}};f=new WeakMap,O=new WeakSet,I=function(){o(this,f).closed.then(()=>{}).catch(t=>{});let e=o(this,f).createUnidirectionalStream().then(t=>{}).catch(t=>{});this.acceptUnidirectionalstreams()};var $=class{static enqueue(e){return new Promise((t,r)=>{this.queue.push({promise:e,resolve:t,reject:r}),this.dequeue()})}static dequeue(){if(this.workingOnPromise)return!1;if(this.stop){this.queue=[],this.stop=!1;return}let e=this.queue.shift();if(!e)return!1;try{this.workingOnPromise=!0,e.promise().then(t=>{this.workingOnPromise=!1,e.resolve(t),this.dequeue()}).catch(t=>{this.workingOnPromise=!1,e.reject(t),this.dequeue()})}catch(t){this.workingOnPromise=!1,e.reject(t),this.dequeue()}return!0}};$.queue=[],$.pendingPromise=!1,$.stop=!1;var E=class{constructor(e){this.raw=e,this.data=new DataView(e),this.position=0,this.len=this.data.byteLength,this.remaining=this.data.byteLength}parse(){switch(this.getByte()){case"-":this.getBlock();let t=this.bulkText();if(!t)throw"parseFail";return{type:"error",data:{info:JSON.parse(new TextDecoder().decode(t.res))}};case">":let n=this.strBlock().split(":");if(n.length!=2)throw"parseFail";let[s,a]=n;if(this.getByte()!=="@")throw"parseFail";let c=this.strBlock(),h=this.bulkText();if(!h)throw"parseFail";return{type:"message",data:{channel:s,sender:a,message_id:c,text:new TextDecoder().decode(h.res)}};case"<":let b=this.strBlock(),k=this.bulkText();if(!k)throw"parseFail";return{type:"reply",reply:{channel_trail:b,data_back:new TextDecoder().decode(k.res)}};case"#":let P=this.strBlock(),_=this.bulkText();if(!_)throw"parseFail";return _.isBin?{type:"command",data:{command:P,data:_.res}}:{type:"command",data:{command:P,data:new TextDecoder().decode(_.res)}};default:throw"parseFail"}}getByte(){if(!this.len)return 0;let e=this.data.getUint8(this.position);return this.position+=1,String.fromCodePoint(e)}getBlock(){let e=this.position,t=this.len-1;for(let r=e;r<=t;r++){let n=s=>this.data.getUint8(s);if(n(r)===13&&n(r+1)===10){let s=this.raw.slice(e,r);return this.position=r+2,s}}return new ArrayBuffer(0)}bulkText(){let e=this.getByte();if(e!="$"&&e!="%")return null;let t=parseInt(this.strBlock());if(isNaN(t))return null;let r=t+2;return this.remaining<r?null:{isBin:e==="%",res:this.getBlock()}}strBlock(){let e=this.getBlock();return new TextDecoder().decode(e)}};var J=async(l,e,t)=>{let r=`https://${l}/authorize`;return new Promise((s,a)=>{fetch(r,{method:"POST",headers:{"Content-Type":"application/json",accept:"application/json"},body:JSON.stringify({token:e,code_challenge:t})}).then(i=>i.json()).then(i=>i.error?a(i):s(i)).catch(i=>a({error:"FetchError",code:"ERR_FETCH",message:i}))})},M=async(l,e,t)=>{let r=`wss://${l}/rt/?token=${e}&code_verifier=${t}`;return new Promise((n,s)=>{try{let a=new WebSocket(r);n(a)}catch{s({error:"ConnectError",code:"ERR_WS_CONNECT",message:"error initiating a connection with cyxth"})}})};var x,d,w,N=class{constructor(e){u(this,x,void 0);u(this,d,void 0);u(this,w,void 0);this.appUrl=e,this.connected=!1,p(this,x,new g),p(this,d,null),p(this,w,{})}async generatePkce(){let e=U(32),t=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(e)),r=new Uint8Array(t),n=window.btoa(String.fromCharCode.apply(null,r)).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");return{codeVerifier:e,codeChallenge:n}}async connect(e){return new Promise(async(r,n)=>{try{let s,a;if(typeof e=="string"){let c=await this.generatePkce();s=c.codeChallenge,a=c.codeVerifier}else s=e.code_challenge,a=e.code_verifier,e=e.token;let i=await J(this.appUrl,e,s);if("WebTransport"in window&&i.wt_url!==null){let c=this.appUrl.split("/"),h=c[c.length-1],b=`${i.wt_url}/${h}`;try{let k=new WebTransport(`https://${b}?t=${i.token_string}&v=${a}`);p(this,d,new T(k))}catch{console.error("webtransport error, fallback to websockets");let P=await M(this.appUrl,i.token_string,a);p(this,d,new S(P))}}else{let c=await M(this.appUrl,i.token_string,a);p(this,d,new S(c))}o(this,d).on("newcall",c=>{let h=JSON.parse(c);o(this,x).dispatch("new-call",{channel:h.channel,host:h.host})})}catch(s){return n(s)}return this.connected=!0,r(o(this,d).waitOpen())})}disconnect(){return o(this,d)?.disconnect(),this.connected=!1,o(this,x).clearAllEvents(),!0}register(e){for(let t of e){let r=t.pluginId();o(this,w)[r]=t}}async colab(e){let t=o(this,w).collab;if(t==null)throw"register Colab from  @cyxth/colab";if(!o(this,d)||!this.connected)throw"connect to cyxth first";return new t(o(this,d),e).__loadWasm()}chat(){let e=o(this,w).chats;if(e==null)throw"register Chat plugin from  @cyxth/chat";if(!o(this,d)||!this.connected)throw"connect to cyxth first";return new e(o(this,d))}calls(e){let t=o(this,w).calls;if(t==null)throw"register Calls plugin from  @cyxth/calls";if(!o(this,d)||!this.connected)throw"connect to cyxth first";return new t(o(this,d),e)}on(e,t){o(this,x).on(e,t)}};x=new WeakMap,d=new WeakMap,w=new WeakMap;export{N as default};
