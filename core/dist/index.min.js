var c=class{constructor(){this.callbacks={}}on(e,t){this.callbacks[e]=t}dispatch(e,t){let r=this.callbacks[e];r&&r(t)}off(e){this.callbacks[e]&&delete this.callbacks[e]}clearAllEvents(){this.callbacks={}}cleaEvents(e){e.forEach(t=>{this.off(t)})}};function x(s){return s.toString(16).padStart(2,"0")}function u(s){var e=new Uint8Array((s||40)/2);return window.crypto.getRandomValues(e),Array.from(e,x).join("")}var p=(s,e)=>Object.prototype.toString.call(s)==="[object "+e+"]",h=class{#e;#t;constructor(e){this.#e=0,this.#t=new DataView(e)}getU8(){let e=this.#t.getUint8(this.#e);return this.#e+=1,e}getFixedSeq(e){let t=this.#t.buffer.slice(this.#e,this.#e+e);return this.#e+=e,t}getSeq(){let e=this.getU32();return this.getFixedSeq(e)}getU32(){let e=this.#t.getUint32(this.#e,!0);return this.#e+=4,e}geti64(){let e=this.#t.getBigInt64(this.#e,!0);return this.#e+=8,e}getString(){let e=this.getSeq();return new TextDecoder().decode(e)}getRest(){return this.#t.buffer.slice(this.#e)}asString(e){return new TextDecoder().decode(e)}},b=s=>{try{let t=s.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(window.atob(t).split("").map(function(n){return"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(r)}catch(e){throw e}};var d=class{#e;#t;#r;constructor(e,t){this.#e=e,this.eventEmmiter=new c,this.#n(),this.#t=new TextEncoder,this.#r=new TextDecoder,this.userId=t,this.pq=new g,this.sm=new m}#n(){this.#e.binaryType="arraybuffer",this.#e.onmessage=e=>this.onMessage(e),this.#e.onerror=e=>this.onError(e),this.#e.onclose=e=>this.onClose(e),this.#e.onopen=()=>this.onOpen()}onOpen(){this.eventEmmiter.dispatch("transportReady",{})}waitOpen(){return new Promise((t,r)=>{let n="transportReady",o=setTimeout(()=>{this.eventEmmiter.off(n),r(new Error("ConnectionTimeout"))},1e4);this.eventEmmiter.on(n,()=>{this.eventEmmiter.off(n),clearTimeout(o),t(!0)})})}onClose(e){}onError(e){console.error("transport error",e)}onMessage(e){let t=e.data,r=new h(t),n=r.getU8(),o=r.getU8(),a=r.getSeq();if(n>=200){this.sm.run(n,a);return}let i=a;if(o===0||o===2){let l=this.#r.decode(a);i=JSON.parse(l)}this.pq.hasId(n)?this.pq.take(n,i):console.log("dropped message (no waiter)",n,i)}subscribe(e,t){this.sm.add(e,t)}disconnect(){return this.#e.close(),!0}send(e,t,r,n=!0){let o;if(p(r,"Uint8Array"))o=r;else{let i=JSON.stringify(r);o=this.#t.encode(i)}let a=0;return(typeof n=="function"||n===!0)&&(a=this.pq.getId()),this.#e.send(new Uint8Array([e,a,t,...o])),typeof n=="boolean"?n?this.pq.wait(a,1e3):new Promise((i,l)=>i(void 0)):this.pq.wait(a,1e3,n)}},y=d;var g=class{constructor(){this.cbs=new Map,this.id=0}add(e,t){this.cbs.set(e,t)}hasId(e){return this.cbs.has(e)}take(e,t){let r=this.cbs.get(e);r&&(r(t),this.cbs.delete(e))}wait(e,t,r){return new Promise((n,o)=>{let a=setTimeout(()=>{},0);t>0&&(a=setTimeout(()=>{o(new Error("Timeout"))},t)),this.add(e,i=>{if(clearTimeout(a),r){let l=r(i);return n(l)}return i.error?o(i):n(i)})})}getId(){return this.cbs.size===0?(this.id=0,0):(this.id+=1,this.id)}},m=class{#e;constructor(){this.#e=new Map}add(e,t){let r=this.#e.get(e);r?r.push(t):this.#e.set(e,[t])}run(e,t){let r=this.#e.get(e);return r?(r.forEach(n=>n(t)),!0):!1}};var w=async(s,e)=>{try{let t=b(e.token);if(!t.id)throw{message:"invalid token: no user id"};let r=await E(s,e.token,e.code_challenge),n=await T(s,r.token_string,e.code_verifier);return new y(n,t.id)}catch(t){throw console.error(t),t}},E=async(s,e,t)=>{let r=`https://${s}/authorize`;try{let o=await(await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",accept:"application/json"},body:JSON.stringify({token:e,code_challenge:t})})).json();if(o.error)throw o.error;return o}catch(n){throw{error:"AuthFail",code:"ERR_FETCH",message:n}}},T=async(s,e,t)=>{let r=`WSS://${s}/rt/?token=${e}&code_verifier=${t}`;try{return new WebSocket(r)}catch(n){throw{error:"ConnectFail",code:"ERR_WS",message:n}}};var f=class s{#e;#t;#r;constructor(e,t){if(this.appUrl=e,this.connected=!1,this.#e=new c,this.#t=null,this.#r={},t)for(let r of t){let n=r.pluginId();this.#r[n]=r}}static async#n(){let e=u(32),t=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(e)),r=new Uint8Array(t),n=window.btoa(String.fromCharCode.apply(null,r)).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");return{codeVerifier:e,codeChallenge:n}}async connect(e){try{if(typeof e=="string"){let r=await s.#n();e={token:e,code_verifier:r.codeVerifier,code_challenge:r.codeChallenge}}let t=await w(this.appUrl,e);return this.#t=t,await this.#t.waitOpen(),this.connected=!0,this}catch(t){throw console.error(t),"failed to connect"}}disconnect(){return this.#t?.disconnect(),this.connected=!1,this.#e.clearAllEvents(),!0}async colab(e){let t=this.#r.collab;if(t==null)throw"Colab is not added, use @cyxth/colab";if(!this.#t||!this.connected)throw"connect to cyxth first";return new t(this.#t,e).__loadWasm()}chat(){let e=this.#r.chats;if(e==null)throw"register Chat plugin from  @cyxth/chat";if(!this.#t||!this.connected)throw"connect to cyxth first";return new e(this.#t)}calls(){let e=this.#r.calls;if(e==null)throw"register Chat plugin from  @cyxth/calls_v2";if(!this.#t||!this.connected)throw"connect to cyxth first";return new e(this.#t)}on(e,t){this.#e.on(e,t)}};export{f as default};
