var Us=Object.create;var dr=Object.defineProperty;var Vs=Object.getOwnPropertyDescriptor;var Qs=Object.getOwnPropertyNames;var Gs=Object.getPrototypeOf,Hs=Object.prototype.hasOwnProperty;var w=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var Ks=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Qs(e))!Hs.call(r,n)&&n!==t&&dr(r,n,{get:()=>e[n],enumerable:!(s=Vs(e,n))||s.enumerable});return r};var Ws=(r,e,t)=>(t=r!=null?Us(Gs(r)):{},Ks(e||!r||!r.__esModule?dr(t,"default",{value:r,enumerable:!0}):t,r));var Pt=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var y=(r,e,t)=>(Pt(r,e,"read from private field"),t?t.call(r):e.get(r)),C=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},T=(r,e,t,s)=>(Pt(r,e,"write to private field"),s?s.call(r,t):e.set(r,t),t);var x=(r,e,t)=>(Pt(r,e,"access private method"),t);var ur=w((Ji,lr)=>{var fe=1e3,me=fe*60,ge=me*60,ee=ge*24,Js=ee*7,Zs=ee*365.25;lr.exports=function(r,e){e=e||{};var t=typeof r;if(t==="string"&&r.length>0)return Ys(r);if(t==="number"&&isFinite(r))return e.long?en(r):Xs(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function Ys(r){if(r=String(r),!(r.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(!!e){var t=parseFloat(e[1]),s=(e[2]||"ms").toLowerCase();switch(s){case"years":case"year":case"yrs":case"yr":case"y":return t*Zs;case"weeks":case"week":case"w":return t*Js;case"days":case"day":case"d":return t*ee;case"hours":case"hour":case"hrs":case"hr":case"h":return t*ge;case"minutes":case"minute":case"mins":case"min":case"m":return t*me;case"seconds":case"second":case"secs":case"sec":case"s":return t*fe;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function Xs(r){var e=Math.abs(r);return e>=ee?Math.round(r/ee)+"d":e>=ge?Math.round(r/ge)+"h":e>=me?Math.round(r/me)+"m":e>=fe?Math.round(r/fe)+"s":r+"ms"}function en(r){var e=Math.abs(r);return e>=ee?Ye(r,e,ee,"day"):e>=ge?Ye(r,e,ge,"hour"):e>=me?Ye(r,e,me,"minute"):e>=fe?Ye(r,e,fe,"second"):r+" ms"}function Ye(r,e,t,s){var n=e>=t*1.5;return Math.round(r/t)+" "+s+(n?"s":"")}});var hr=w((Zi,pr)=>{function tn(r){t.debug=t,t.default=t,t.coerce=c,t.disable=i,t.enable=n,t.enabled=a,t.humanize=ur(),t.destroy=l,Object.keys(r).forEach(d=>{t[d]=r[d]}),t.names=[],t.skips=[],t.formatters={};function e(d){let u=0;for(let p=0;p<d.length;p++)u=(u<<5)-u+d.charCodeAt(p),u|=0;return t.colors[Math.abs(u)%t.colors.length]}t.selectColor=e;function t(d){let u,p=null,h,g;function b(...f){if(!b.enabled)return;let S=b,O=Number(new Date),A=O-(u||O);S.diff=A,S.prev=u,S.curr=O,u=O,f[0]=t.coerce(f[0]),typeof f[0]!="string"&&f.unshift("%O");let X=0;f[0]=f[0].replace(/%([a-zA-Z%])/g,(pe,Ze)=>{if(pe==="%%")return"%";X++;let Me=t.formatters[Ze];if(typeof Me=="function"){let he=f[X];pe=Me.call(S,he),f.splice(X,1),X--}return pe}),t.formatArgs.call(S,f),(S.log||t.log).apply(S,f)}return b.namespace=d,b.useColors=t.useColors(),b.color=t.selectColor(d),b.extend=s,b.destroy=t.destroy,Object.defineProperty(b,"enabled",{enumerable:!0,configurable:!1,get:()=>p!==null?p:(h!==t.namespaces&&(h=t.namespaces,g=t.enabled(d)),g),set:f=>{p=f}}),typeof t.init=="function"&&t.init(b),b}function s(d,u){let p=t(this.namespace+(typeof u>"u"?":":u)+d);return p.log=this.log,p}function n(d){t.save(d),t.namespaces=d,t.names=[],t.skips=[];let u,p=(typeof d=="string"?d:"").split(/[\s,]+/),h=p.length;for(u=0;u<h;u++)!p[u]||(d=p[u].replace(/\*/g,".*?"),d[0]==="-"?t.skips.push(new RegExp("^"+d.slice(1)+"$")):t.names.push(new RegExp("^"+d+"$")))}function i(){let d=[...t.names.map(o),...t.skips.map(o).map(u=>"-"+u)].join(",");return t.enable(""),d}function a(d){if(d[d.length-1]==="*")return!0;let u,p;for(u=0,p=t.skips.length;u<p;u++)if(t.skips[u].test(d))return!1;for(u=0,p=t.names.length;u<p;u++)if(t.names[u].test(d))return!0;return!1}function o(d){return d.toString().substring(2,d.toString().length-2).replace(/\.\*\?$/,"*")}function c(d){return d instanceof Error?d.stack||d.message:d}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}pr.exports=tn});var xt=w((j,Xe)=>{j.formatArgs=sn;j.save=nn;j.load=an;j.useColors=rn;j.storage=on();j.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();j.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function rn(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function sn(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+Xe.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;r.splice(1,0,e,"color: inherit");let t=0,s=0;r[0].replace(/%[a-zA-Z%]/g,n=>{n!=="%%"&&(t++,n==="%c"&&(s=t))}),r.splice(s,0,e)}j.log=console.debug||console.log||(()=>{});function nn(r){try{r?j.storage.setItem("debug",r):j.storage.removeItem("debug")}catch{}}function an(){let r;try{r=j.storage.getItem("debug")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function on(){try{return localStorage}catch{}}Xe.exports=hr()(j);var{formatters:cn}=Xe.exports;cn.j=function(r){try{return JSON.stringify(r)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var $=w(ve=>{"use strict";var dn=ve&&ve.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(ve,"__esModule",{value:!0});ve.Logger=void 0;var _e=dn(xt()),ye="mediasoup-client",Rt=class{constructor(e){e?(this._debug=(0,_e.default)(`${ye}:${e}`),this._warn=(0,_e.default)(`${ye}:WARN:${e}`),this._error=(0,_e.default)(`${ye}:ERROR:${e}`)):(this._debug=(0,_e.default)(ye),this._warn=(0,_e.default)(`${ye}:WARN`),this._error=(0,_e.default)(`${ye}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};ve.Logger=Rt});var Sr=w((Xi,Ot)=>{"use strict";var be=typeof Reflect=="object"?Reflect:null,fr=be&&typeof be.apply=="function"?be.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)},et;be&&typeof be.ownKeys=="function"?et=be.ownKeys:Object.getOwnPropertySymbols?et=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:et=function(e){return Object.getOwnPropertyNames(e)};function ln(r){console&&console.warn&&console.warn(r)}var gr=Number.isNaN||function(e){return e!==e};function E(){E.init.call(this)}Ot.exports=E;Ot.exports.once=fn;E.EventEmitter=E;E.prototype._events=void 0;E.prototype._eventsCount=0;E.prototype._maxListeners=void 0;var mr=10;function tt(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(E,"defaultMaxListeners",{enumerable:!0,get:function(){return mr},set:function(r){if(typeof r!="number"||r<0||gr(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");mr=r}});E.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};E.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||gr(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function _r(r){return r._maxListeners===void 0?E.defaultMaxListeners:r._maxListeners}E.prototype.getMaxListeners=function(){return _r(this)};E.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var n=e==="error",i=this._events;if(i!==void 0)n=n&&i.error===void 0;else if(!n)return!1;if(n){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var c=i[e];if(c===void 0)return!1;if(typeof c=="function")fr(c,this,t);else for(var l=c.length,d=Cr(c,l),s=0;s<l;++s)fr(d[s],this,t);return!0};function yr(r,e,t,s){var n,i,a;if(tt(t),i=r._events,i===void 0?(i=r._events=Object.create(null),r._eventsCount=0):(i.newListener!==void 0&&(r.emit("newListener",e,t.listener?t.listener:t),i=r._events),a=i[e]),a===void 0)a=i[e]=t,++r._eventsCount;else if(typeof a=="function"?a=i[e]=s?[t,a]:[a,t]:s?a.unshift(t):a.push(t),n=_r(r),n>0&&a.length>n&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=r,o.type=e,o.count=a.length,ln(o)}return r}E.prototype.addListener=function(e,t){return yr(this,e,t,!1)};E.prototype.on=E.prototype.addListener;E.prototype.prependListener=function(e,t){return yr(this,e,t,!0)};function un(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function vr(r,e,t){var s={fired:!1,wrapFn:void 0,target:r,type:e,listener:t},n=un.bind(s);return n.listener=t,s.wrapFn=n,n}E.prototype.once=function(e,t){return tt(t),this.on(e,vr(this,e,t)),this};E.prototype.prependOnceListener=function(e,t){return tt(t),this.prependListener(e,vr(this,e,t)),this};E.prototype.removeListener=function(e,t){var s,n,i,a,o;if(tt(t),n=this._events,n===void 0)return this;if(s=n[e],s===void 0)return this;if(s===t||s.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,s.listener||t));else if(typeof s!="function"){for(i=-1,a=s.length-1;a>=0;a--)if(s[a]===t||s[a].listener===t){o=s[a].listener,i=a;break}if(i<0)return this;i===0?s.shift():pn(s,i),s.length===1&&(n[e]=s[0]),n.removeListener!==void 0&&this.emit("removeListener",e,o||t)}return this};E.prototype.off=E.prototype.removeListener;E.prototype.removeAllListeners=function(e){var t,s,n;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[e]),this;if(arguments.length===0){var i=Object.keys(s),a;for(n=0;n<i.length;++n)a=i[n],a!=="removeListener"&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=s[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this};function br(r,e,t){var s=r._events;if(s===void 0)return[];var n=s[e];return n===void 0?[]:typeof n=="function"?t?[n.listener||n]:[n]:t?hn(n):Cr(n,n.length)}E.prototype.listeners=function(e){return br(this,e,!0)};E.prototype.rawListeners=function(e){return br(this,e,!1)};E.listenerCount=function(r,e){return typeof r.listenerCount=="function"?r.listenerCount(e):wr.call(r,e)};E.prototype.listenerCount=wr;function wr(r){var e=this._events;if(e!==void 0){var t=e[r];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}E.prototype.eventNames=function(){return this._eventsCount>0?et(this._events):[]};function Cr(r,e){for(var t=new Array(e),s=0;s<e;++s)t[s]=r[s];return t}function pn(r,e){for(;e+1<r.length;e++)r[e]=r[e+1];r.pop()}function hn(r){for(var e=new Array(r.length),t=0;t<e.length;++t)e[t]=r[t].listener||r[t];return e}function fn(r,e){return new Promise(function(t,s){function n(a){r.removeListener(e,i),s(a)}function i(){typeof r.removeListener=="function"&&r.removeListener("error",n),t([].slice.call(arguments))}Er(r,e,i,{once:!0}),e!=="error"&&mn(r,n,{once:!0})})}function mn(r,e,t){typeof r.on=="function"&&Er(r,"error",e,t)}function Er(r,e,t,s){if(typeof r.on=="function")s.once?r.once(e,t):r.on(e,t);else if(typeof r.addEventListener=="function")r.addEventListener(e,function n(i){s.once&&r.removeEventListener(e,n),t(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}});var Z=w(rt=>{"use strict";Object.defineProperty(rt,"__esModule",{value:!0});rt.EnhancedEventEmitter=void 0;var gn=Sr(),_n=$(),yn=new _n.Logger("EnhancedEventEmitter"),kt=class extends gn.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}emit(e,...t){return super.emit(e,...t)}safeEmit(e,...t){let s=super.listenerCount(e);try{return super.emit(e,...t)}catch(n){return yn.error("safeEmit() | event listener threw an error [eventName:%s]:%o",e,n),Boolean(s)}}on(e,t){return super.on(e,t),this}off(e,t){return super.off(e,t),this}addListener(e,t){return super.on(e,t),this}prependListener(e,t){return super.prependListener(e,t),this}once(e,t){return super.once(e,t),this}prependOnceListener(e,t){return super.prependOnceListener(e,t),this}removeListener(e,t){return super.off(e,t),this}removeAllListeners(e){return super.removeAllListeners(e),this}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}rawListeners(e){return super.rawListeners(e)}};rt.EnhancedEventEmitter=kt});var Ce=w(we=>{"use strict";Object.defineProperty(we,"__esModule",{value:!0});we.InvalidStateError=we.UnsupportedError=void 0;var Ie=class extends Error{constructor(e){super(e),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,Ie):this.stack=new Error(e).stack}};we.UnsupportedError=Ie;var Fe=class extends Error{constructor(e){super(e),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,Fe):this.stack=new Error(e).stack}};we.InvalidStateError=Fe});var Se=w(Ee=>{"use strict";Object.defineProperty(Ee,"__esModule",{value:!0});Ee.generateRandomNumber=Ee.clone=void 0;function vn(r,e){return typeof r>"u"?e:JSON.parse(JSON.stringify(r))}Ee.clone=vn;function bn(){return Math.round(Math.random()*1e7)}Ee.generateRandomNumber=bn});var Br=w(v=>{var re=xt()("h264-profile-level-id");re.log=console.info.bind(console);var te=1,Ae=2,st=3,Dt=4,jt=5;v.ProfileConstrainedBaseline=te;v.ProfileBaseline=Ae;v.ProfileMain=st;v.ProfileConstrainedHigh=Dt;v.ProfileHigh=jt;var Te=0,nt=10,Lt=11,xr=12,Rr=13,Or=20,kr=21,Lr=22,Dr=30,Mt=31,jr=32,Mr=40,Ir=41,Fr=42,Ar=50,$r=51,Nr=52;v.Level1_b=Te;v.Level1=nt;v.Level1_1=Lt;v.Level1_2=xr;v.Level1_3=Rr;v.Level2=Or;v.Level2_1=kr;v.Level2_2=Lr;v.Level3=Dr;v.Level3_1=Mt;v.Level3_2=jr;v.Level4=Mr;v.Level4_1=Ir;v.Level4_2=Fr;v.Level5=Ar;v.Level5_1=$r;v.Level5_2=Nr;var Pe=class{constructor(e,t){this.profile=e,this.level=t}};v.ProfileLevelId=Pe;var wn=new Pe(te,Mt),Cn=16,N=class{constructor(e){this._mask=~Tr("x",e),this._maskedValue=Tr("1",e)}isMatch(e){return this._maskedValue===(e&this._mask)}},B=class{constructor(e,t,s){this.profile_idc=e,this.profile_iop=t,this.profile=s}},En=[new B(66,new N("x1xx0000"),te),new B(77,new N("1xxx0000"),te),new B(88,new N("11xx0000"),te),new B(66,new N("x0xx0000"),Ae),new B(88,new N("10xx0000"),Ae),new B(77,new N("0x0x0000"),st),new B(100,new N("00000000"),jt),new B(100,new N("00001100"),Dt)];v.parseProfileLevelId=function(r){if(typeof r!="string"||r.length!==6)return null;let e=parseInt(r,16);if(e===0)return null;let t=e&255,s=e>>8&255,n=e>>16&255,i;switch(t){case Lt:{i=(s&Cn)!==0?Te:Lt;break}case nt:case xr:case Rr:case Or:case kr:case Lr:case Dr:case Mt:case jr:case Mr:case Ir:case Fr:case Ar:case $r:case Nr:{i=t;break}default:return re("parseProfileLevelId() | unrecognized level_idc:%s",t),null}for(let a of En)if(n===a.profile_idc&&a.profile_iop.isMatch(s))return new Pe(a.profile,i);return re("parseProfileLevelId() | unrecognized profile_idc/profile_iop combination"),null};v.profileLevelIdToString=function(r){if(r.level==Te)switch(r.profile){case te:return"42f00b";case Ae:return"42100b";case st:return"4d100b";default:return re("profileLevelIdToString() | Level 1_b not is allowed for profile:%s",r.profile),null}let e;switch(r.profile){case te:{e="42e0";break}case Ae:{e="4200";break}case st:{e="4d00";break}case Dt:{e="640c";break}case jt:{e="6400";break}default:return re("profileLevelIdToString() | unrecognized profile:%s",r.profile),null}let t=r.level.toString(16);return t.length===1&&(t=`0${t}`),`${e}${t}`};v.parseSdpProfileLevelId=function(r={}){let e=r["profile-level-id"];return e?v.parseProfileLevelId(e):wn};v.isSameProfile=function(r={},e={}){let t=v.parseSdpProfileLevelId(r),s=v.parseSdpProfileLevelId(e);return Boolean(t&&s&&t.profile===s.profile)};v.generateProfileLevelIdForAnswer=function(r={},e={}){if(!r["profile-level-id"]&&!e["profile-level-id"])return re("generateProfileLevelIdForAnswer() | no profile-level-id in local and remote params"),null;let t=v.parseSdpProfileLevelId(r),s=v.parseSdpProfileLevelId(e);if(!t)throw new TypeError("invalid local_profile_level_id");if(!s)throw new TypeError("invalid remote_profile_level_id");if(t.profile!==s.profile)throw new TypeError("H264 Profile mismatch");let n=Pr(r)&&Pr(e),i=t.level,a=s.level,o=Tn(i,a),c=n?i:o;return re("generateProfileLevelIdForAnswer() | result: [profile:%s, level:%s]",t.profile,c),v.profileLevelIdToString(new Pe(t.profile,c))};function Tr(r,e){return(e[0]===r)<<7|(e[1]===r)<<6|(e[2]===r)<<5|(e[3]===r)<<4|(e[4]===r)<<3|(e[5]===r)<<2|(e[6]===r)<<1|(e[7]===r)<<0}function Sn(r,e){return r===Te?e!==nt&&e!==Te:e===Te?r!==nt:r<e}function Tn(r,e){return Sn(r,e)?r:e}function Pr(r={}){let e=r["level-asymmetry-allowed"];return e===1||e==="1"}});var it=w(m=>{"use strict";var Pn=m&&m.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var n=Object.getOwnPropertyDescriptor(e,t);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,n)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),xn=m&&m.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),zr=m&&m.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&Pn(e,r,t);return xn(e,r),e};Object.defineProperty(m,"__esModule",{value:!0});m.canReceive=m.canSend=m.generateProbatorRtpParameters=m.reduceCodecs=m.getSendingRemoteRtpParameters=m.getSendingRtpParameters=m.getRecvRtpCapabilities=m.getExtendedRtpCapabilities=m.validateSctpStreamParameters=m.validateSctpParameters=m.validateNumSctpStreams=m.validateSctpCapabilities=m.validateRtcpParameters=m.validateRtpEncodingParameters=m.validateRtpHeaderExtensionParameters=m.validateRtpCodecParameters=m.validateRtpParameters=m.validateRtpHeaderExtension=m.validateRtcpFeedback=m.validateRtpCodecCapability=m.validateRtpCapabilities=void 0;var qr=zr(Br()),Rn=zr(Se()),On="probator",kn=1234,Ln=127;function Dn(r){if(typeof r!="object")throw new TypeError("caps is not an object");if(r.codecs&&!Array.isArray(r.codecs))throw new TypeError("caps.codecs is not an array");r.codecs||(r.codecs=[]);for(let e of r.codecs)Ur(e);if(r.headerExtensions&&!Array.isArray(r.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");r.headerExtensions||(r.headerExtensions=[]);for(let e of r.headerExtensions)Vr(e)}m.validateRtpCapabilities=Dn;function Ur(r){let e=new RegExp("^(audio|video)/(.+)","i");if(typeof r!="object")throw new TypeError("codec is not an object");if(!r.mimeType||typeof r.mimeType!="string")throw new TypeError("missing codec.mimeType");let t=e.exec(r.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");if(r.kind=t[1].toLowerCase(),r.preferredPayloadType&&typeof r.preferredPayloadType!="number")throw new TypeError("invalid codec.preferredPayloadType");if(typeof r.clockRate!="number")throw new TypeError("missing codec.clockRate");r.kind==="audio"?typeof r.channels!="number"&&(r.channels=1):delete r.channels,(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(let s of Object.keys(r.parameters)){let n=r.parameters[s];if(n===void 0&&(r.parameters[s]="",n=""),typeof n!="string"&&typeof n!="number")throw new TypeError(`invalid codec parameter [key:${s}s, value:${n}]`);if(s==="apt"&&typeof n!="number")throw new TypeError("invalid codec apt parameter")}(!r.rtcpFeedback||!Array.isArray(r.rtcpFeedback))&&(r.rtcpFeedback=[]);for(let s of r.rtcpFeedback)It(s)}m.validateRtpCodecCapability=Ur;function It(r){if(typeof r!="object")throw new TypeError("fb is not an object");if(!r.type||typeof r.type!="string")throw new TypeError("missing fb.type");(!r.parameter||typeof r.parameter!="string")&&(r.parameter="")}m.validateRtcpFeedback=It;function Vr(r){if(typeof r!="object")throw new TypeError("ext is not an object");if(r.kind!=="audio"&&r.kind!=="video")throw new TypeError("invalid ext.kind");if(!r.uri||typeof r.uri!="string")throw new TypeError("missing ext.uri");if(typeof r.preferredId!="number")throw new TypeError("missing ext.preferredId");if(r.preferredEncrypt&&typeof r.preferredEncrypt!="boolean")throw new TypeError("invalid ext.preferredEncrypt");if(r.preferredEncrypt||(r.preferredEncrypt=!1),r.direction&&typeof r.direction!="string")throw new TypeError("invalid ext.direction");r.direction||(r.direction="sendrecv")}m.validateRtpHeaderExtension=Vr;function Ft(r){if(typeof r!="object")throw new TypeError("params is not an object");if(r.mid&&typeof r.mid!="string")throw new TypeError("params.mid is not a string");if(!Array.isArray(r.codecs))throw new TypeError("missing params.codecs");for(let e of r.codecs)Qr(e);if(r.headerExtensions&&!Array.isArray(r.headerExtensions))throw new TypeError("params.headerExtensions is not an array");r.headerExtensions||(r.headerExtensions=[]);for(let e of r.headerExtensions)Gr(e);if(r.encodings&&!Array.isArray(r.encodings))throw new TypeError("params.encodings is not an array");r.encodings||(r.encodings=[]);for(let e of r.encodings)Hr(e);if(r.rtcp&&typeof r.rtcp!="object")throw new TypeError("params.rtcp is not an object");r.rtcp||(r.rtcp={}),Kr(r.rtcp)}m.validateRtpParameters=Ft;function Qr(r){let e=new RegExp("^(audio|video)/(.+)","i");if(typeof r!="object")throw new TypeError("codec is not an object");if(!r.mimeType||typeof r.mimeType!="string")throw new TypeError("missing codec.mimeType");let t=e.exec(r.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");if(typeof r.payloadType!="number")throw new TypeError("missing codec.payloadType");if(typeof r.clockRate!="number")throw new TypeError("missing codec.clockRate");t[1].toLowerCase()==="audio"?typeof r.channels!="number"&&(r.channels=1):delete r.channels,(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(let n of Object.keys(r.parameters)){let i=r.parameters[n];if(i===void 0&&(r.parameters[n]="",i=""),typeof i!="string"&&typeof i!="number")throw new TypeError(`invalid codec parameter [key:${n}s, value:${i}]`);if(n==="apt"&&typeof i!="number")throw new TypeError("invalid codec apt parameter")}(!r.rtcpFeedback||!Array.isArray(r.rtcpFeedback))&&(r.rtcpFeedback=[]);for(let n of r.rtcpFeedback)It(n)}m.validateRtpCodecParameters=Qr;function Gr(r){if(typeof r!="object")throw new TypeError("ext is not an object");if(!r.uri||typeof r.uri!="string")throw new TypeError("missing ext.uri");if(typeof r.id!="number")throw new TypeError("missing ext.id");if(r.encrypt&&typeof r.encrypt!="boolean")throw new TypeError("invalid ext.encrypt");r.encrypt||(r.encrypt=!1),(!r.parameters||typeof r.parameters!="object")&&(r.parameters={});for(let e of Object.keys(r.parameters)){let t=r.parameters[e];if(t===void 0&&(r.parameters[e]="",t=""),typeof t!="string"&&typeof t!="number")throw new TypeError("invalid header extension parameter")}}m.validateRtpHeaderExtensionParameters=Gr;function Hr(r){if(typeof r!="object")throw new TypeError("encoding is not an object");if(r.ssrc&&typeof r.ssrc!="number")throw new TypeError("invalid encoding.ssrc");if(r.rid&&typeof r.rid!="string")throw new TypeError("invalid encoding.rid");if(r.rtx&&typeof r.rtx!="object")throw new TypeError("invalid encoding.rtx");if(r.rtx&&typeof r.rtx.ssrc!="number")throw new TypeError("missing encoding.rtx.ssrc");if((!r.dtx||typeof r.dtx!="boolean")&&(r.dtx=!1),r.scalabilityMode&&typeof r.scalabilityMode!="string")throw new TypeError("invalid encoding.scalabilityMode")}m.validateRtpEncodingParameters=Hr;function Kr(r){if(typeof r!="object")throw new TypeError("rtcp is not an object");if(r.cname&&typeof r.cname!="string")throw new TypeError("invalid rtcp.cname");(!r.reducedSize||typeof r.reducedSize!="boolean")&&(r.reducedSize=!0)}m.validateRtcpParameters=Kr;function jn(r){if(typeof r!="object")throw new TypeError("caps is not an object");if(!r.numStreams||typeof r.numStreams!="object")throw new TypeError("missing caps.numStreams");Wr(r.numStreams)}m.validateSctpCapabilities=jn;function Wr(r){if(typeof r!="object")throw new TypeError("numStreams is not an object");if(typeof r.OS!="number")throw new TypeError("missing numStreams.OS");if(typeof r.MIS!="number")throw new TypeError("missing numStreams.MIS")}m.validateNumSctpStreams=Wr;function Mn(r){if(typeof r!="object")throw new TypeError("params is not an object");if(typeof r.port!="number")throw new TypeError("missing params.port");if(typeof r.OS!="number")throw new TypeError("missing params.OS");if(typeof r.MIS!="number")throw new TypeError("missing params.MIS");if(typeof r.maxMessageSize!="number")throw new TypeError("missing params.maxMessageSize")}m.validateSctpParameters=Mn;function In(r){if(typeof r!="object")throw new TypeError("params is not an object");if(typeof r.streamId!="number")throw new TypeError("missing params.streamId");let e=!1;if(typeof r.ordered=="boolean"?e=!0:r.ordered=!0,r.maxPacketLifeTime&&typeof r.maxPacketLifeTime!="number")throw new TypeError("invalid params.maxPacketLifeTime");if(r.maxRetransmits&&typeof r.maxRetransmits!="number")throw new TypeError("invalid params.maxRetransmits");if(r.maxPacketLifeTime&&r.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(e&&r.ordered&&(r.maxPacketLifeTime||r.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(!e&&(r.maxPacketLifeTime||r.maxRetransmits)&&(r.ordered=!1),r.label&&typeof r.label!="string")throw new TypeError("invalid params.label");if(r.protocol&&typeof r.protocol!="string")throw new TypeError("invalid params.protocol")}m.validateSctpStreamParameters=In;function Fn(r,e){let t={codecs:[],headerExtensions:[]};for(let s of e.codecs||[]){if($e(s))continue;let n=(r.codecs||[]).find(a=>Jr(a,s,{strict:!0,modify:!0}));if(!n)continue;let i={mimeType:n.mimeType,kind:n.kind,clockRate:n.clockRate,channels:n.channels,localPayloadType:n.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:s.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:n.parameters,remoteParameters:s.parameters,rtcpFeedback:Qn(n,s)};t.codecs.push(i)}for(let s of t.codecs){let n=r.codecs.find(a=>$e(a)&&a.parameters.apt===s.localPayloadType),i=e.codecs.find(a=>$e(a)&&a.parameters.apt===s.remotePayloadType);n&&i&&(s.localRtxPayloadType=n.preferredPayloadType,s.remoteRtxPayloadType=i.preferredPayloadType)}for(let s of e.headerExtensions){let n=r.headerExtensions.find(a=>Vn(a,s));if(!n)continue;let i={kind:s.kind,uri:s.uri,sendId:n.preferredId,recvId:s.preferredId,encrypt:n.preferredEncrypt,direction:"sendrecv"};switch(s.direction){case"sendrecv":i.direction="sendrecv";break;case"recvonly":i.direction="sendonly";break;case"sendonly":i.direction="recvonly";break;case"inactive":i.direction="inactive";break}t.headerExtensions.push(i)}return t}m.getExtendedRtpCapabilities=Fn;function An(r){let e={codecs:[],headerExtensions:[]};for(let t of r.codecs){let s={mimeType:t.mimeType,kind:t.kind,preferredPayloadType:t.remotePayloadType,clockRate:t.clockRate,channels:t.channels,parameters:t.localParameters,rtcpFeedback:t.rtcpFeedback};if(e.codecs.push(s),!t.remoteRtxPayloadType)continue;let n={mimeType:`${t.kind}/rtx`,kind:t.kind,preferredPayloadType:t.remoteRtxPayloadType,clockRate:t.clockRate,parameters:{apt:t.remotePayloadType},rtcpFeedback:[]};e.codecs.push(n)}for(let t of r.headerExtensions){if(t.direction!=="sendrecv"&&t.direction!=="recvonly")continue;let s={kind:t.kind,uri:t.uri,preferredId:t.recvId,preferredEncrypt:t.encrypt,direction:t.direction};e.headerExtensions.push(s)}return e}m.getRecvRtpCapabilities=An;function $n(r,e){let t={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(let s of e.codecs){if(s.kind!==r)continue;let n={mimeType:s.mimeType,payloadType:s.localPayloadType,clockRate:s.clockRate,channels:s.channels,parameters:s.localParameters,rtcpFeedback:s.rtcpFeedback};if(t.codecs.push(n),s.localRtxPayloadType){let i={mimeType:`${s.kind}/rtx`,payloadType:s.localRtxPayloadType,clockRate:s.clockRate,parameters:{apt:s.localPayloadType},rtcpFeedback:[]};t.codecs.push(i)}}for(let s of e.headerExtensions){if(s.kind&&s.kind!==r||s.direction!=="sendrecv"&&s.direction!=="sendonly")continue;let n={uri:s.uri,id:s.sendId,encrypt:s.encrypt,parameters:{}};t.headerExtensions.push(n)}return t}m.getSendingRtpParameters=$n;function Nn(r,e){let t={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(let s of e.codecs){if(s.kind!==r)continue;let n={mimeType:s.mimeType,payloadType:s.localPayloadType,clockRate:s.clockRate,channels:s.channels,parameters:s.remoteParameters,rtcpFeedback:s.rtcpFeedback};if(t.codecs.push(n),s.localRtxPayloadType){let i={mimeType:`${s.kind}/rtx`,payloadType:s.localRtxPayloadType,clockRate:s.clockRate,parameters:{apt:s.localPayloadType},rtcpFeedback:[]};t.codecs.push(i)}}for(let s of e.headerExtensions){if(s.kind&&s.kind!==r||s.direction!=="sendrecv"&&s.direction!=="sendonly")continue;let n={uri:s.uri,id:s.sendId,encrypt:s.encrypt,parameters:{}};t.headerExtensions.push(n)}if(t.headerExtensions.some(s=>s.uri==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"))for(let s of t.codecs)s.rtcpFeedback=(s.rtcpFeedback||[]).filter(n=>n.type!=="goog-remb");else if(t.headerExtensions.some(s=>s.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"))for(let s of t.codecs)s.rtcpFeedback=(s.rtcpFeedback||[]).filter(n=>n.type!=="transport-cc");else for(let s of t.codecs)s.rtcpFeedback=(s.rtcpFeedback||[]).filter(n=>n.type!=="transport-cc"&&n.type!=="goog-remb");return t}m.getSendingRemoteRtpParameters=Nn;function Bn(r,e){let t=[];if(!e)t.push(r[0]),$e(r[1])&&t.push(r[1]);else{for(let s=0;s<r.length;++s)if(Jr(r[s],e)){t.push(r[s]),$e(r[s+1])&&t.push(r[s+1]);break}if(t.length===0)throw new TypeError("no matching codec found")}return t}m.reduceCodecs=Bn;function qn(r){r=Rn.clone(r,{}),Ft(r);let e={mid:On,codecs:[],headerExtensions:[],encodings:[{ssrc:kn}],rtcp:{cname:"probator"}};return e.codecs.push(r.codecs[0]),e.codecs[0].payloadType=Ln,e.headerExtensions=r.headerExtensions,e}m.generateProbatorRtpParameters=qn;function zn(r,e){return e.codecs.some(t=>t.kind===r)}m.canSend=zn;function Un(r,e){if(Ft(r),r.codecs.length===0)return!1;let t=r.codecs[0];return e.codecs.some(s=>s.remotePayloadType===t.payloadType)}m.canReceive=Un;function $e(r){return r?/.+\/rtx$/i.test(r.mimeType):!1}function Jr(r,e,{strict:t=!1,modify:s=!1}={}){let n=r.mimeType.toLowerCase(),i=e.mimeType.toLowerCase();if(n!==i||r.clockRate!==e.clockRate||r.channels!==e.channels)return!1;switch(n){case"video/h264":{if(t){let a=r.parameters["packetization-mode"]||0,o=e.parameters["packetization-mode"]||0;if(a!==o||!qr.isSameProfile(r.parameters,e.parameters))return!1;let c;try{c=qr.generateProfileLevelIdForAnswer(r.parameters,e.parameters)}catch{return!1}s&&(c?(r.parameters["profile-level-id"]=c,e.parameters["profile-level-id"]=c):(delete r.parameters["profile-level-id"],delete e.parameters["profile-level-id"]))}break}case"video/vp9":{if(t){let a=r.parameters["profile-id"]||0,o=e.parameters["profile-id"]||0;if(a!==o)return!1}break}}return!0}function Vn(r,e){return!(r.kind&&e.kind&&r.kind!==e.kind||r.uri!==e.uri)}function Qn(r,e){let t=[];for(let s of r.rtcpFeedback||[]){let n=(e.rtcpFeedback||[]).find(i=>i.type===s.type&&(i.parameter===s.parameter||!i.parameter&&!s.parameter));n&&t.push(n)}return t}});var Zr=w(Ne=>{"use strict";var At=Ne&&Ne.__awaiter||function(r,e,t,s){function n(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(d){try{l(s.next(d))}catch(u){a(u)}}function c(d){try{l(s.throw(d))}catch(u){a(u)}}function l(d){d.done?i(d.value):n(d.value).then(o,c)}l((s=s.apply(r,e||[])).next())})};Object.defineProperty(Ne,"__esModule",{value:!0});var $t=class{constructor({ClosedErrorClass:e=Error,StoppedErrorClass:t=Error,RemovedTaskErrorClass:s=Error}={ClosedErrorClass:Error,StoppedErrorClass:Error,RemovedTaskErrorClass:Error}){this.closed=!1,this.pendingTasks=[],this.ClosedErrorClass=Error,this.StoppedErrorClass=Error,this.RemovedTaskErrorClass=Error,this.ClosedErrorClass=e,this.StoppedErrorClass=t,this.RemovedTaskErrorClass=s}get size(){return this.pendingTasks.length}close(){if(!this.closed){this.closed=!0;for(let e of this.pendingTasks)e.stopped=!0,e.reject(new this.ClosedErrorClass("AwaitQueue closed"));this.pendingTasks.length=0}}push(e,t){return At(this,void 0,void 0,function*(){if(this.closed)throw new this.ClosedErrorClass("AwaitQueue closed");if(typeof e!="function")throw new TypeError("given task is not a function");if(!e.name&&t)try{Object.defineProperty(e,"name",{value:t})}catch{}return new Promise((s,n)=>{let i={task:e,name:t,resolve:s,reject:n,stopped:!1,enqueuedAt:new Date,executedAt:void 0};this.pendingTasks.push(i),this.pendingTasks.length===1&&this.next()})})}removeTask(e){if(e===0)throw new TypeError("cannot remove task with index 0");let t=this.pendingTasks[e];!t||(this.pendingTasks.splice(e,1),t.reject(new this.RemovedTaskErrorClass("task removed from the queue")))}stop(){if(!this.closed){for(let e of this.pendingTasks)e.stopped=!0,e.reject(new this.StoppedErrorClass("AwaitQueue stopped"));this.pendingTasks.length=0}}dump(){let e=new Date,t=0;return this.pendingTasks.map(s=>({idx:t++,task:s.task,name:s.name,enqueuedTime:s.executedAt?s.executedAt.getTime()-s.enqueuedAt.getTime():e.getTime()-s.enqueuedAt.getTime(),executingTime:s.executedAt?e.getTime()-s.executedAt.getTime():0}))}next(){return At(this,void 0,void 0,function*(){let e=this.pendingTasks[0];!e||(yield this.executeTask(e),this.pendingTasks.shift(),this.next())})}executeTask(e){return At(this,void 0,void 0,function*(){if(!e.stopped){e.executedAt=new Date;try{let t=yield e.task();if(e.stopped)return;e.resolve(t)}catch(t){if(e.stopped)return;e.reject(t)}}})}};Ne.AwaitQueue=$t});var Xr=w(at=>{"use strict";Object.defineProperty(at,"__esModule",{value:!0});at.Producer=void 0;var Gn=$(),Yr=Z(),xe=Ce(),q=new Gn.Logger("Producer"),Nt=class extends Yr.EnhancedEventEmitter{constructor({id:e,localId:t,rtpSender:s,track:n,rtpParameters:i,stopTracks:a,disableTrackOnPause:o,zeroRtpOnPause:c,appData:l}){super(),this._closed=!1,this._observer=new Yr.EnhancedEventEmitter,q.debug("constructor()"),this._id=e,this._localId=t,this._rtpSender=s,this._track=n,this._kind=n.kind,this._rtpParameters=i,this._paused=o?!n.enabled:!1,this._maxSpatialLayer=void 0,this._stopTracks=a,this._disableTrackOnPause=o,this._zeroRtpOnPause=c,this._appData=l||{},this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(q.debug("close()"),this._closed=!0,this._destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(q.debug("transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new xe.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(q.debug("pause()"),this._closed){q.error("pause() | Producer closed");return}this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@pause",e,t)}).catch(()=>{}),this._observer.safeEmit("pause")}resume(){if(q.debug("resume()"),this._closed){q.error("resume() | Producer closed");return}this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@resume",e,t)}).catch(()=>{}),this._observer.safeEmit("resume")}async replaceTrack({track:e}){if(q.debug("replaceTrack() [track:%o]",e),this._closed){if(e&&this._stopTracks)try{e.stop()}catch{}throw new xe.InvalidStateError("closed")}else if(e&&e.readyState==="ended")throw new xe.InvalidStateError("track ended");if(e===this._track){q.debug("replaceTrack() | same track, ignored");return}await new Promise((t,s)=>{this.safeEmit("@replacetrack",e,t,s)}),this._destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this._handleTrack()}async setMaxSpatialLayer(e){if(this._closed)throw new xe.InvalidStateError("closed");if(this._kind!=="video")throw new xe.UnsupportedError("not a video Producer");if(typeof e!="number")throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(await new Promise((t,s)=>{this.safeEmit("@setmaxspatiallayer",e,t,s)}).catch(()=>{}),this._maxSpatialLayer=e)}async setRtpEncodingParameters(e){if(this._closed)throw new xe.InvalidStateError("closed");if(typeof e!="object")throw new TypeError("invalid params");await new Promise((t,s)=>{this.safeEmit("@setrtpencodingparameters",e,t,s)})}_onTrackEnded(){q.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){!this._track||this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){if(!!this._track)try{this._track.removeEventListener("ended",this._onTrackEnded),this._stopTracks&&this._track.stop()}catch{}}};at.Producer=Nt});var ts=w(ot=>{"use strict";Object.defineProperty(ot,"__esModule",{value:!0});ot.Consumer=void 0;var Hn=$(),es=Z(),Kn=Ce(),z=new Hn.Logger("Consumer"),Bt=class extends es.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:s,rtpReceiver:n,track:i,rtpParameters:a,appData:o}){super(),this._closed=!1,this._observer=new es.EnhancedEventEmitter,z.debug("constructor()"),this._id=e,this._localId=t,this._producerId=s,this._rtpReceiver=n,this._track=i,this._rtpParameters=a,this._paused=!i.enabled,this._appData=o||{},this._onTrackEnded=this._onTrackEnded.bind(this),this._handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(z.debug("close()"),this._closed=!0,this._destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(z.debug("transportClosed()"),this._closed=!0,this._destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new Kn.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(z.debug("pause()"),this._closed){z.error("pause() | Consumer closed");return}if(this._paused){z.debug("pause() | Consumer is already paused");return}this._paused=!0,this._track.enabled=!1,this.emit("@pause"),this._observer.safeEmit("pause")}resume(){if(z.debug("resume()"),this._closed){z.error("resume() | Consumer closed");return}if(!this._paused){z.debug("resume() | Consumer is already resumed");return}this._paused=!1,this._track.enabled=!0,this.emit("@resume"),this._observer.safeEmit("resume")}_onTrackEnded(){z.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}_handleTrack(){this._track.addEventListener("ended",this._onTrackEnded)}_destroyTrack(){try{this._track.removeEventListener("ended",this._onTrackEnded),this._track.stop()}catch{}}};ot.Consumer=Bt});var ss=w(ct=>{"use strict";Object.defineProperty(ct,"__esModule",{value:!0});ct.DataProducer=void 0;var Wn=$(),rs=Z(),Jn=Ce(),K=new Wn.Logger("DataProducer"),qt=class extends rs.EnhancedEventEmitter{constructor({id:e,dataChannel:t,sctpStreamParameters:s,appData:n}){super(),this._closed=!1,this._observer=new rs.EnhancedEventEmitter,K.debug("constructor()"),this._id=e,this._dataChannel=t,this._sctpStreamParameters=s,this._appData=n||{},this._handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(e){this._dataChannel.bufferedAmountLowThreshold=e}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(K.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(K.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}send(e){if(K.debug("send()"),this._closed)throw new Jn.InvalidStateError("closed");this._dataChannel.send(e)}_handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(K.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?K.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):K.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(K.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"))}),this._dataChannel.addEventListener("message",()=>{this._closed||K.warn('DataChannel "message" event in a DataProducer, message discarded')}),this._dataChannel.addEventListener("bufferedamountlow",()=>{this._closed||this.safeEmit("bufferedamountlow")})}};ct.DataProducer=qt});var is=w(dt=>{"use strict";Object.defineProperty(dt,"__esModule",{value:!0});dt.DataConsumer=void 0;var Zn=$(),ns=Z(),se=new Zn.Logger("DataConsumer"),zt=class extends ns.EnhancedEventEmitter{constructor({id:e,dataProducerId:t,dataChannel:s,sctpStreamParameters:n,appData:i}){super(),this._closed=!1,this._observer=new ns.EnhancedEventEmitter,se.debug("constructor()"),this._id=e,this._dataProducerId=t,this._dataChannel=s,this._sctpStreamParameters=n,this._appData=i||{},this._handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(e){this._dataChannel.binaryType=e}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){this._closed||(se.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(se.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}_handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(se.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?se.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):se.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(se.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"))}),this._dataChannel.addEventListener("message",e=>{this._closed||this.safeEmit("message",e.data)})}};dt.DataConsumer=zt});var cs=w(U=>{"use strict";var Yn=U&&U.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var n=Object.getOwnPropertyDescriptor(e,t);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,n)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),Xn=U&&U.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),os=U&&U.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&Yn(e,r,t);return Xn(e,r),e};Object.defineProperty(U,"__esModule",{value:!0});U.Transport=void 0;var ei=Zr(),ti=$(),as=Z(),R=Ce(),Ut=os(Se()),Be=os(it()),ri=Xr(),si=ts(),ni=ss(),ii=is(),P=new ti.Logger("Transport"),Vt=class{constructor(e){this.consumerOptions=e,this.promise=new Promise((t,s)=>{this.resolve=t,this.reject=s})}},Qt=class extends as.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:s,iceCandidates:n,dtlsParameters:i,sctpParameters:a,iceServers:o,iceTransportPolicy:c,additionalSettings:l,proprietaryConstraints:d,appData:u,handlerFactory:p,extendedRtpCapabilities:h,canProduceByKind:g}){super(),this._closed=!1,this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._dataProducers=new Map,this._dataConsumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new ei.AwaitQueue({ClosedErrorClass:R.InvalidStateError}),this._pendingConsumerTasks=[],this._consumerCreationInProgress=!1,this._pendingPauseConsumers=new Map,this._consumerPauseInProgress=!1,this._pendingResumeConsumers=new Map,this._consumerResumeInProgress=!1,this._pendingCloseConsumers=new Map,this._consumerCloseInProgress=!1,this._observer=new as.EnhancedEventEmitter,P.debug("constructor() [id:%s, direction:%s]",t,e),this._id=t,this._direction=e,this._extendedRtpCapabilities=h,this._canProduceByKind=g,this._maxSctpMessageSize=a?a.maxMessageSize:null,l=Ut.clone(l,{}),delete l.iceServers,delete l.iceTransportPolicy,delete l.bundlePolicy,delete l.rtcpMuxPolicy,delete l.sdpSemantics,this._handler=p(),this._handler.run({direction:e,iceParameters:s,iceCandidates:n,dtlsParameters:i,sctpParameters:a,iceServers:o,iceTransportPolicy:c,additionalSettings:l,proprietaryConstraints:d,extendedRtpCapabilities:h}),this._appData=u||{},this._handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){throw new Error("cannot override appData object")}get observer(){return this._observer}close(){if(!this._closed){P.debug("close()"),this._closed=!0,this._awaitQueue.close(),this._handler.close();for(let e of this._producers.values())e.transportClosed();this._producers.clear();for(let e of this._consumers.values())e.transportClosed();this._consumers.clear();for(let e of this._dataProducers.values())e.transportClosed();this._dataProducers.clear();for(let e of this._dataConsumers.values())e.transportClosed();this._dataConsumers.clear(),this._observer.safeEmit("close")}}async getStats(){if(this._closed)throw new R.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:e}){if(P.debug("restartIce()"),this._closed)throw new R.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>this._handler.restartIce(e),"transport.restartIce()")}async updateIceServers({iceServers:e}={}){if(P.debug("updateIceServers()"),this._closed)throw new R.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._awaitQueue.push(async()=>this._handler.updateIceServers(e),"transport.updateIceServers()")}async produce({track:e,encodings:t,codecOptions:s,codec:n,stopTracks:i=!0,disableTrackOnPause:a=!0,zeroRtpOnPause:o=!1,appData:c={}}={}){if(P.debug("produce() [track:%o]",e),e){if(this._direction!=="send")throw new R.UnsupportedError("not a sending Transport");if(this._canProduceByKind[e.kind]){if(e.readyState==="ended")throw new R.InvalidStateError("track ended");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(c&&typeof c!="object")throw new TypeError("if given, appData must be an object")}else throw new R.UnsupportedError(`cannot produce ${e.kind}`)}else throw new TypeError("missing track");return this._awaitQueue.push(async()=>{let l;if(t&&!Array.isArray(t))throw TypeError("encodings must be an array");t&&t.length===0?l=void 0:t&&(l=t.map(h=>{let g={active:!0};return h.active===!1&&(g.active=!1),typeof h.dtx=="boolean"&&(g.dtx=h.dtx),typeof h.scalabilityMode=="string"&&(g.scalabilityMode=h.scalabilityMode),typeof h.scaleResolutionDownBy=="number"&&(g.scaleResolutionDownBy=h.scaleResolutionDownBy),typeof h.maxBitrate=="number"&&(g.maxBitrate=h.maxBitrate),typeof h.maxFramerate=="number"&&(g.maxFramerate=h.maxFramerate),typeof h.adaptivePtime=="boolean"&&(g.adaptivePtime=h.adaptivePtime),typeof h.priority=="string"&&(g.priority=h.priority),typeof h.networkPriority=="string"&&(g.networkPriority=h.networkPriority),g}));let{localId:d,rtpParameters:u,rtpSender:p}=await this._handler.send({track:e,encodings:l,codecOptions:s,codec:n});try{Be.validateRtpParameters(u);let{id:h}=await new Promise((b,f)=>{this.safeEmit("produce",{kind:e.kind,rtpParameters:u,appData:c},b,f)}),g=new ri.Producer({id:h,localId:d,rtpSender:p,track:e,rtpParameters:u,stopTracks:i,disableTrackOnPause:a,zeroRtpOnPause:o,appData:c});return this._producers.set(g.id,g),this._handleProducer(g),this._observer.safeEmit("newproducer",g),g}catch(h){throw this._handler.stopSending(d).catch(()=>{}),h}},"transport.produce()").catch(l=>{if(i)try{e.stop()}catch{}throw l})}async consume({id:e,producerId:t,kind:s,rtpParameters:n,appData:i={}}){if(P.debug("consume()"),n=Ut.clone(n,void 0),this._closed)throw new R.InvalidStateError("closed");if(this._direction!=="recv")throw new R.UnsupportedError("not a receiving Transport");if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing producerId");if(s!=="audio"&&s!=="video")throw new TypeError(`invalid kind '${s}'`);if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(i&&typeof i!="object")throw new TypeError("if given, appData must be an object");if(!Be.canReceive(n,this._extendedRtpCapabilities))throw new R.UnsupportedError("cannot consume this Producer");let o=new Vt({id:e,producerId:t,kind:s,rtpParameters:n,appData:i});return this._pendingConsumerTasks.push(o),this._consumerCreationInProgress===!1&&this._createPendingConsumers(),o.promise}async produceData({ordered:e=!0,maxPacketLifeTime:t,maxRetransmits:s,label:n="",protocol:i="",appData:a={}}={}){if(P.debug("produceData()"),this._direction!=="send")throw new R.UnsupportedError("not a sending Transport");if(this._maxSctpMessageSize){if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("producedata")===0)throw new TypeError('no "producedata" listener set into this transport');if(a&&typeof a!="object")throw new TypeError("if given, appData must be an object")}else throw new R.UnsupportedError("SCTP not enabled by remote Transport");return(t||s)&&(e=!1),this._awaitQueue.push(async()=>{let{dataChannel:o,sctpStreamParameters:c}=await this._handler.sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:n,protocol:i});Be.validateSctpStreamParameters(c);let{id:l}=await new Promise((u,p)=>{this.safeEmit("producedata",{sctpStreamParameters:c,label:n,protocol:i,appData:a},u,p)}),d=new ni.DataProducer({id:l,dataChannel:o,sctpStreamParameters:c,appData:a});return this._dataProducers.set(d.id,d),this._handleDataProducer(d),this._observer.safeEmit("newdataproducer",d),d},"transport.produceData()")}async consumeData({id:e,dataProducerId:t,sctpStreamParameters:s,label:n="",protocol:i="",appData:a={}}){if(P.debug("consumeData()"),s=Ut.clone(s,void 0),this._closed)throw new R.InvalidStateError("closed");if(this._direction!=="recv")throw new R.UnsupportedError("not a receiving Transport");if(this._maxSctpMessageSize){if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing dataProducerId");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(a&&typeof a!="object")throw new TypeError("if given, appData must be an object")}else throw new R.UnsupportedError("SCTP not enabled by remote Transport");return Be.validateSctpStreamParameters(s),this._awaitQueue.push(async()=>{let{dataChannel:o}=await this._handler.receiveDataChannel({sctpStreamParameters:s,label:n,protocol:i}),c=new ii.DataConsumer({id:e,dataProducerId:t,dataChannel:o,sctpStreamParameters:s,appData:a});return this._dataConsumers.set(c.id,c),this._handleDataConsumer(c),this._observer.safeEmit("newdataconsumer",c),c},"transport.consumeData()")}async _createPendingConsumers(){this._consumerCreationInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingConsumerTasks.length===0){P.debug("_createPendingConsumers() | there is no Consumer to be created");return}let e=[...this._pendingConsumerTasks];this._pendingConsumerTasks=[];let t,s=[];for(let n of e){let{id:i,kind:a,rtpParameters:o}=n.consumerOptions;s.push({trackId:i,kind:a,rtpParameters:o})}try{let n=await this._handler.receive(s);for(let i=0;i<n.length;i++){let a=e[i],o=n[i],{id:c,producerId:l,kind:d,rtpParameters:u,appData:p}=a.consumerOptions,{localId:h,rtpReceiver:g,track:b}=o,f=new si.Consumer({id:c,localId:h,producerId:l,rtpReceiver:g,track:b,rtpParameters:u,appData:p});this._consumers.set(f.id,f),this._handleConsumer(f),!this._probatorConsumerCreated&&!t&&d==="video"&&(t=f),this._observer.safeEmit("newconsumer",f),a.resolve(f)}}catch(n){for(let i of e)i.reject(n)}if(t)try{let n=Be.generateProbatorRtpParameters(t.rtpParameters);await this._handler.receive([{trackId:"probator",kind:"video",rtpParameters:n}]),P.debug("_createPendingConsumers() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(n){P.error("_createPendingConsumers() | failed to create Consumer for RTP probation:%o",n)}},"transport._createPendingConsumers()").then(()=>{this._consumerCreationInProgress=!1,this._pendingConsumerTasks.length>0&&this._createPendingConsumers()}).catch(()=>{})}_pausePendingConsumers(){this._consumerPauseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingPauseConsumers.size===0){P.debug("_pausePendingConsumers() | there is no Consumer to be paused");return}let e=Array.from(this._pendingPauseConsumers.values());this._pendingPauseConsumers.clear();try{let t=e.map(s=>s.localId);await this._handler.pauseReceiving(t)}catch(t){P.error("_pausePendingConsumers() | failed to pause Consumers:",t)}},"transport._pausePendingConsumers").then(()=>{this._consumerPauseInProgress=!1,this._pendingPauseConsumers.size>0&&this._pausePendingConsumers()}).catch(()=>{})}_resumePendingConsumers(){this._consumerResumeInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingResumeConsumers.size===0){P.debug("_resumePendingConsumers() | there is no Consumer to be resumed");return}let e=Array.from(this._pendingResumeConsumers.values());this._pendingResumeConsumers.clear();try{let t=e.map(s=>s.localId);await this._handler.resumeReceiving(t)}catch(t){P.error("_resumePendingConsumers() | failed to resume Consumers:",t)}},"transport._resumePendingConsumers").then(()=>{this._consumerResumeInProgress=!1,this._pendingResumeConsumers.size>0&&this._resumePendingConsumers()}).catch(()=>{})}_closePendingConsumers(){this._consumerCloseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingCloseConsumers.size===0){P.debug("_closePendingConsumers() | there is no Consumer to be closed");return}let e=Array.from(this._pendingCloseConsumers.values());this._pendingCloseConsumers.clear();try{await this._handler.stopReceiving(e.map(t=>t.localId))}catch(t){P.error("_closePendingConsumers() | failed to close Consumers:",t)}},"transport._closePendingConsumers").then(()=>{this._consumerCloseInProgress=!1,this._pendingCloseConsumers.size>0&&this._closePendingConsumers()}).catch(()=>{})}_handleHandler(){let e=this._handler;e.on("@connect",({dtlsParameters:t},s,n)=>{if(this._closed){n(new R.InvalidStateError("closed"));return}this.safeEmit("connect",{dtlsParameters:t},s,n)}),e.on("@connectionstatechange",t=>{t!==this._connectionState&&(P.debug("connection state changed to %s",t),this._connectionState=t,this._closed||this.safeEmit("connectionstatechange",t))})}_handleProducer(e){e.on("@close",()=>{this._producers.delete(e.id),!this._closed&&this._awaitQueue.push(async()=>this._handler.stopSending(e.localId),"producer @close event").catch(t=>P.warn("producer.close() failed:%o",t))}),e.on("@pause",(t,s)=>{this._awaitQueue.push(async()=>this._handler.pauseSending(e.localId),"producer @pause event").then(t).catch(s)}),e.on("@resume",(t,s)=>{this._awaitQueue.push(async()=>this._handler.resumeSending(e.localId),"producer @resume event").then(t).catch(s)}),e.on("@replacetrack",(t,s,n)=>{this._awaitQueue.push(async()=>this._handler.replaceTrack(e.localId,t),"producer @replacetrack event").then(s).catch(n)}),e.on("@setmaxspatiallayer",(t,s,n)=>{this._awaitQueue.push(async()=>this._handler.setMaxSpatialLayer(e.localId,t),"producer @setmaxspatiallayer event").then(s).catch(n)}),e.on("@setrtpencodingparameters",(t,s,n)=>{this._awaitQueue.push(async()=>this._handler.setRtpEncodingParameters(e.localId,t),"producer @setrtpencodingparameters event").then(s).catch(n)}),e.on("@getstats",(t,s)=>{if(this._closed)return s(new R.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(s)})}_handleConsumer(e){e.on("@close",()=>{this._consumers.delete(e.id),this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.delete(e.id),!this._closed&&(this._pendingCloseConsumers.set(e.id,e),this._consumerCloseInProgress===!1&&this._closePendingConsumers())}),e.on("@pause",()=>{this._pendingResumeConsumers.has(e.id)&&this._pendingResumeConsumers.delete(e.id),this._pendingPauseConsumers.set(e.id,e),this._consumerPauseInProgress===!1&&this._pausePendingConsumers()}),e.on("@resume",()=>{this._pendingPauseConsumers.has(e.id)&&this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.set(e.id,e),this._consumerResumeInProgress===!1&&this._resumePendingConsumers()}),e.on("@getstats",(t,s)=>{if(this._closed)return s(new R.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(s)})}_handleDataProducer(e){e.on("@close",()=>{this._dataProducers.delete(e.id)})}_handleDataConsumer(e){e.on("@close",()=>{this._dataConsumers.delete(e.id)})}};U.Transport=Qt});var Gt=w((ua,ls)=>{var ds=ls.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(r){return r.encoding?"rtpmap:%d %s/%s/%s":r.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(r){return r.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(r){return r.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(r){return"extmap:%d"+(r.direction?"/%s":"%v")+(r["encrypt-uri"]?" %s":"%v")+" %s"+(r.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(r){return r.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(r){var e="candidate:%s %d %s %d %s %d typ %s";return e+=r.raddr!=null?" raddr %s rport %d":"%v%v",e+=r.tcptype!=null?" tcptype %s":"%v",r.generation!=null&&(e+=" generation %d"),e+=r["network-id"]!=null?" network-id %d":"%v",e+=r["network-cost"]!=null?" network-cost %d":"%v",e}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(r){var e="ssrc:%d";return r.attribute!=null&&(e+=" %s",r.value!=null&&(e+=":%s")),e}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(r){return r.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(r){return r.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(r){return"imageattr:%s %s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(r){return"simulcast:%s %s"+(r.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(r){return"ts-refclk:%s"+(r.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(r){var e="mediaclk:";return e+=r.id!=null?"id=%s %s":"%v%s",e+=r.mediaClockValue!=null?"=%s":"",e+=r.rateNumerator!=null?" rate=%s":"",e+=r.rateDenominator!=null?"/%s":"",e}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(ds).forEach(function(r){var e=ds[r];e.forEach(function(t){t.reg||(t.reg=/(.*)/),t.format||(t.format="%s")})})});var hs=w(W=>{var Re=function(r){return String(Number(r))===r?Number(r):r},ai=function(r,e,t,s){if(s&&!t)e[s]=Re(r[1]);else for(var n=0;n<t.length;n+=1)r[n+1]!=null&&(e[t[n]]=Re(r[n+1]))},oi=function(r,e,t){var s=r.name&&r.names;r.push&&!e[r.push]?e[r.push]=[]:s&&!e[r.name]&&(e[r.name]={});var n=r.push?{}:s?e[r.name]:e;ai(t.match(r.reg),n,r.names,r.name),r.push&&e[r.push].push(n)},us=Gt(),ci=RegExp.prototype.test.bind(/^([a-z])=(.*)/);W.parse=function(r){var e={},t=[],s=e;return r.split(/(\r\n|\r|\n)/).filter(ci).forEach(function(n){var i=n[0],a=n.slice(2);i==="m"&&(t.push({rtp:[],fmtp:[]}),s=t[t.length-1]);for(var o=0;o<(us[i]||[]).length;o+=1){var c=us[i][o];if(c.reg.test(a))return oi(c,s,a)}}),e.media=t,e};var ps=function(r,e){var t=e.split(/=(.+)/,2);return t.length===2?r[t[0]]=Re(t[1]):t.length===1&&e.length>1&&(r[t[0]]=void 0),r};W.parseParams=function(r){return r.split(/;\s?/).reduce(ps,{})};W.parseFmtpConfig=W.parseParams;W.parsePayloads=function(r){return r.toString().split(" ").map(Number)};W.parseRemoteCandidates=function(r){for(var e=[],t=r.split(" ").map(Re),s=0;s<t.length;s+=3)e.push({component:t[s],ip:t[s+1],port:t[s+2]});return e};W.parseImageAttributes=function(r){return r.split(" ").map(function(e){return e.substring(1,e.length-1).split(",").reduce(ps,{})})};W.parseSimulcastStreamList=function(r){return r.split(";").map(function(e){return e.split(",").map(function(t){var s,n=!1;return t[0]!=="~"?s=Re(t):(s=Re(t.substring(1,t.length)),n=!0),{scid:s,paused:n}})})}});var ms=w((ha,fs)=>{var Ht=Gt(),di=/%[sdv%]/g,li=function(r){var e=1,t=arguments,s=t.length;return r.replace(di,function(n){if(e>=s)return n;var i=t[e];switch(e+=1,n){case"%%":return"%";case"%s":return String(i);case"%d":return Number(i);case"%v":return""}})},qe=function(r,e,t){var s=e.format instanceof Function?e.format(e.push?t:t[e.name]):e.format,n=[r+"="+s];if(e.names)for(var i=0;i<e.names.length;i+=1){var a=e.names[i];e.name?n.push(t[e.name][a]):n.push(t[e.names[i]])}else n.push(t[e.name]);return li.apply(null,n)},ui=["v","o","s","i","u","e","p","c","b","t","r","z","a"],pi=["i","c","b","a"];fs.exports=function(r,e){e=e||{},r.version==null&&(r.version=0),r.name==null&&(r.name=" "),r.media.forEach(function(i){i.payloads==null&&(i.payloads="")});var t=e.outerOrder||ui,s=e.innerOrder||pi,n=[];return t.forEach(function(i){Ht[i].forEach(function(a){a.name in r&&r[a.name]!=null?n.push(qe(i,a,r)):a.push in r&&r[a.push]!=null&&r[a.push].forEach(function(o){n.push(qe(i,a,o))})})}),r.media.forEach(function(i){n.push(qe("m",Ht.m[0],i)),s.forEach(function(a){Ht[a].forEach(function(o){o.name in i&&i[o.name]!=null?n.push(qe(a,o,i)):o.push in i&&i[o.push]!=null&&i[o.push].forEach(function(c){n.push(qe(a,o,c))})})})}),n.join(`\r
`)+`\r
`}});var lt=w(J=>{var ne=hs(),hi=ms();J.write=hi;J.parse=ne.parse;J.parseParams=ne.parseParams;J.parseFmtpConfig=ne.parseFmtpConfig;J.parsePayloads=ne.parsePayloads;J.parseRemoteCandidates=ne.parseRemoteCandidates;J.parseImageAttributes=ne.parseImageAttributes;J.parseSimulcastStreamList=ne.parseSimulcastStreamList});var _s=w(k=>{"use strict";var fi=k&&k.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var n=Object.getOwnPropertyDescriptor(e,t);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,n)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),mi=k&&k.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),gi=k&&k.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&fi(e,r,t);return mi(e,r),e};Object.defineProperty(k,"__esModule",{value:!0});k.applyCodecParameters=k.getCname=k.extractDtlsParameters=k.extractRtpCapabilities=void 0;var gs=gi(lt());function _i({sdpObject:r}){let e=new Map,t=[],s=!1,n=!1;for(let a of r.media){let o=a.type;switch(o){case"audio":{if(s)continue;s=!0;break}case"video":{if(n)continue;n=!0;break}default:continue}for(let c of a.rtp){let l={kind:o,mimeType:`${o}/${c.codec}`,preferredPayloadType:c.payload,clockRate:c.rate,channels:c.encoding,parameters:{},rtcpFeedback:[]};e.set(l.preferredPayloadType,l)}for(let c of a.fmtp||[]){let l=gs.parseParams(c.config),d=e.get(c.payload);!d||(l&&l.hasOwnProperty("profile-level-id")&&(l["profile-level-id"]=String(l["profile-level-id"])),d.parameters=l)}for(let c of a.rtcpFb||[]){let l=e.get(c.payload);if(!l)continue;let d={type:c.type,parameter:c.subtype};d.parameter||delete d.parameter,l.rtcpFeedback.push(d)}for(let c of a.ext||[]){if(c["encrypt-uri"])continue;let l={kind:o,uri:c.uri,preferredId:c.value};t.push(l)}}return{codecs:Array.from(e.values()),headerExtensions:t}}k.extractRtpCapabilities=_i;function yi({sdpObject:r}){let e=(r.media||[]).find(i=>i.iceUfrag&&i.port!==0);if(!e)throw new Error("no active media section found");let t=e.fingerprint||r.fingerprint,s;switch(e.setup){case"active":s="client";break;case"passive":s="server";break;case"actpass":s="auto";break}return{role:s,fingerprints:[{algorithm:t.type,value:t.hash}]}}k.extractDtlsParameters=yi;function vi({offerMediaObject:r}){let e=(r.ssrcs||[]).find(t=>t.attribute==="cname");return e?e.value:""}k.getCname=vi;function bi({offerRtpParameters:r,answerMediaObject:e}){for(let t of r.codecs){let s=t.mimeType.toLowerCase();if(s!=="audio/opus"||!(e.rtp||[]).find(o=>o.payload===t.payloadType))continue;e.fmtp=e.fmtp||[];let i=e.fmtp.find(o=>o.payload===t.payloadType);i||(i={payload:t.payloadType,config:""},e.fmtp.push(i));let a=gs.parseParams(i.config);switch(s){case"audio/opus":{let o=t.parameters["sprop-stereo"];o!==void 0&&(a.stereo=o?1:0);break}}i.config="";for(let o of Object.keys(a))i.config&&(i.config+=";"),i.config+=`${o}=${a[o]}`}}k.applyCodecParameters=bi});var ys=w(Oe=>{"use strict";Object.defineProperty(Oe,"__esModule",{value:!0});Oe.addLegacySimulcast=Oe.getRtpEncodings=void 0;function wi({offerMediaObject:r}){let e=new Set;for(let n of r.ssrcs||[]){let i=n.id;e.add(i)}if(e.size===0)throw new Error("no a=ssrc lines found");let t=new Map;for(let n of r.ssrcGroups||[]){if(n.semantics!=="FID")continue;let[i,a]=n.ssrcs.split(/\s+/);i=Number(i),a=Number(a),e.has(i)&&(e.delete(i),e.delete(a),t.set(i,a))}for(let n of e)t.set(n,null);let s=[];for(let[n,i]of t){let a={ssrc:n};i&&(a.rtx={ssrc:i}),s.push(a)}return s}Oe.getRtpEncodings=wi;function Ci({offerMediaObject:r,numStreams:e}){if(e<=1)throw new TypeError("numStreams must be greater than 1");let t=(r.ssrcs||[]).find(u=>u.attribute==="msid");if(!t)throw new Error("a=ssrc line with msid information not found");let[s,n]=t.value.split(" "),i=t.id,a;(r.ssrcGroups||[]).some(u=>{if(u.semantics!=="FID")return!1;let p=u.ssrcs.split(/\s+/);return Number(p[0])===i?(a=Number(p[1]),!0):!1});let o=r.ssrcs.find(u=>u.attribute==="cname");if(!o)throw new Error("a=ssrc line with cname information not found");let c=o.value,l=[],d=[];for(let u=0;u<e;++u)l.push(i+u),a&&d.push(a+u);r.ssrcGroups=[],r.ssrcs=[],r.ssrcGroups.push({semantics:"SIM",ssrcs:l.join(" ")});for(let u=0;u<l.length;++u){let p=l[u];r.ssrcs.push({id:p,attribute:"cname",value:c}),r.ssrcs.push({id:p,attribute:"msid",value:`${s} ${n}`})}for(let u=0;u<d.length;++u){let p=l[u],h=d[u];r.ssrcs.push({id:h,attribute:"cname",value:c}),r.ssrcs.push({id:h,attribute:"msid",value:`${s} ${n}`}),r.ssrcGroups.push({semantics:"FID",ssrcs:`${p} ${h}`})}}Oe.addLegacySimulcast=Ci});var vs=w(ut=>{"use strict";Object.defineProperty(ut,"__esModule",{value:!0});ut.HandlerInterface=void 0;var Ei=Z(),Kt=class extends Ei.EnhancedEventEmitter{constructor(){super()}};ut.HandlerInterface=Kt});var bs=w(D=>{"use strict";var Si=D&&D.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var n=Object.getOwnPropertyDescriptor(e,t);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,n)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),Ti=D&&D.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),Pi=D&&D.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&Si(e,r,t);return Ti(e,r),e};Object.defineProperty(D,"__esModule",{value:!0});D.OfferMediaSection=D.AnswerMediaSection=D.MediaSection=void 0;var xi=Pi(Se()),ze=class{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,planB:n=!1}){if(this._mediaObject={},this._planB=n,e&&this.setIceParameters(e),t){this._mediaObject.candidates=[];for(let i of t){let a={};a.component=1,a.foundation=i.foundation,a.ip=i.ip,a.port=i.port,a.priority=i.priority,a.transport=i.protocol,a.type=i.type,i.tcpType&&(a.tcptype=i.tcpType),this._mediaObject.candidates.push(a)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}s&&this.setDtlsRole(s.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return this._mediaObject.port===0}getObject(){return this._mediaObject}setIceParameters(e){this._mediaObject.iceUfrag=e.usernameFragment,this._mediaObject.icePwd=e.password}pause(){this._mediaObject.direction="inactive"}disable(){this.pause(),delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}close(){this.disable(),this._mediaObject.port=0}};D.MediaSection=ze;var Wt=class extends ze{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,sctpParameters:n,plainRtpParameters:i,planB:a=!1,offerMediaObject:o,offerRtpParameters:c,answerRtpParameters:l,codecOptions:d,extmapAllowMixed:u=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:s,planB:a}),this._mediaObject.mid=String(o.mid),this._mediaObject.type=o.type,this._mediaObject.protocol=o.protocol,i?(this._mediaObject.connection={ip:i.ip,version:i.ipVersion},this._mediaObject.port=i.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),o.type){case"audio":case"video":{this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(let p of l.codecs){let h={payload:p.payloadType,codec:Zt(p),rate:p.clockRate};p.channels>1&&(h.encoding=p.channels),this._mediaObject.rtp.push(h);let g=xi.clone(p.parameters,{});if(d){let{opusStereo:f,opusFec:S,opusDtx:O,opusMaxPlaybackRate:A,opusMaxAverageBitrate:X,opusPtime:Je,videoGoogleStartBitrate:pe,videoGoogleMaxBitrate:Ze,videoGoogleMinBitrate:Me}=d,he=c.codecs.find(zs=>zs.payloadType===p.payloadType);switch(p.mimeType.toLowerCase()){case"audio/opus":{f!==void 0&&(he.parameters["sprop-stereo"]=f?1:0,g.stereo=f?1:0),S!==void 0&&(he.parameters.useinbandfec=S?1:0,g.useinbandfec=S?1:0),O!==void 0&&(he.parameters.usedtx=O?1:0,g.usedtx=O?1:0),A!==void 0&&(g.maxplaybackrate=A),X!==void 0&&(g.maxaveragebitrate=X),Je!==void 0&&(he.parameters.ptime=Je,g.ptime=Je);break}case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":{pe!==void 0&&(g["x-google-start-bitrate"]=pe),Ze!==void 0&&(g["x-google-max-bitrate"]=Ze),Me!==void 0&&(g["x-google-min-bitrate"]=Me);break}}}let b={payload:p.payloadType,config:""};for(let f of Object.keys(g))b.config&&(b.config+=";"),b.config+=`${f}=${g[f]}`;b.config&&this._mediaObject.fmtp.push(b);for(let f of p.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:p.payloadType,type:f.type,subtype:f.parameter})}this._mediaObject.payloads=l.codecs.map(p=>p.payloadType).join(" "),this._mediaObject.ext=[];for(let p of l.headerExtensions)!(o.ext||[]).some(g=>g.uri===p.uri)||this._mediaObject.ext.push({uri:p.uri,value:p.id});if(u&&o.extmapAllowMixed==="extmap-allow-mixed"&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),o.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:o.simulcast.list1},this._mediaObject.rids=[];for(let p of o.rids||[])p.direction==="send"&&this._mediaObject.rids.push({id:p.id,direction:"recv"})}else if(o.simulcast_03){this._mediaObject.simulcast_03={value:o.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(let p of o.rids||[])p.direction==="send"&&this._mediaObject.rids.push({id:p.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&this._mediaObject.type==="video"&&(this._mediaObject.xGoogleFlag="conference");break}case"application":{typeof o.sctpPort=="number"?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=n.port,this._mediaObject.maxMessageSize=n.maxMessageSize):o.sctpmap&&(this._mediaObject.payloads=n.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:n.port,maxMessageSize:n.maxMessageSize});break}}}setDtlsRole(e){switch(e){case"client":this._mediaObject.setup="active";break;case"server":this._mediaObject.setup="passive";break;case"auto":this._mediaObject.setup="actpass";break}}resume(){this._mediaObject.direction="recvonly"}};D.AnswerMediaSection=Wt;var Jt=class extends ze{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,sctpParameters:n,plainRtpParameters:i,planB:a=!1,mid:o,kind:c,offerRtpParameters:l,streamId:d,trackId:u,oldDataChannelSpec:p=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:s,planB:a}),this._mediaObject.mid=String(o),this._mediaObject.type=c,i?(this._mediaObject.connection={ip:i.ip,version:i.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=i.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},n?this._mediaObject.protocol="UDP/DTLS/SCTP":this._mediaObject.protocol="UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),c){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${d||"-"} ${u}`);for(let f of l.codecs){let S={payload:f.payloadType,codec:Zt(f),rate:f.clockRate};f.channels>1&&(S.encoding=f.channels),this._mediaObject.rtp.push(S);let O={payload:f.payloadType,config:""};for(let A of Object.keys(f.parameters))O.config&&(O.config+=";"),O.config+=`${A}=${f.parameters[A]}`;O.config&&this._mediaObject.fmtp.push(O);for(let A of f.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:f.payloadType,type:A.type,subtype:A.parameter})}this._mediaObject.payloads=l.codecs.map(f=>f.payloadType).join(" "),this._mediaObject.ext=[];for(let f of l.headerExtensions)this._mediaObject.ext.push({uri:f.uri,value:f.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";let h=l.encodings[0],g=h.ssrc,b=h.rtx&&h.rtx.ssrc?h.rtx.ssrc:void 0;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],l.rtcp.cname&&this._mediaObject.ssrcs.push({id:g,attribute:"cname",value:l.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:g,attribute:"msid",value:`${d||"-"} ${u}`}),b&&(l.rtcp.cname&&this._mediaObject.ssrcs.push({id:b,attribute:"cname",value:l.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:b,attribute:"msid",value:`${d||"-"} ${u}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${g} ${b}`}));break}case"application":{p?(this._mediaObject.payloads=n.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:n.port,maxMessageSize:n.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=n.port,this._mediaObject.maxMessageSize=n.maxMessageSize);break}}}setDtlsRole(e){this._mediaObject.setup="actpass"}resume(){this._mediaObject.direction="sendonly"}planBReceive({offerRtpParameters:e,streamId:t,trackId:s}){let n=e.encodings[0],i=n.ssrc,a=n.rtx&&n.rtx.ssrc?n.rtx.ssrc:void 0,o=this._mediaObject.payloads.split(" ");for(let c of e.codecs){if(o.includes(String(c.payloadType)))continue;let l={payload:c.payloadType,codec:Zt(c),rate:c.clockRate};c.channels>1&&(l.encoding=c.channels),this._mediaObject.rtp.push(l);let d={payload:c.payloadType,config:""};for(let u of Object.keys(c.parameters))d.config&&(d.config+=";"),d.config+=`${u}=${c.parameters[u]}`;d.config&&this._mediaObject.fmtp.push(d);for(let u of c.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:c.payloadType,type:u.type,subtype:u.parameter})}this._mediaObject.payloads+=` ${e.codecs.filter(c=>!this._mediaObject.payloads.includes(c.payloadType)).map(c=>c.payloadType).join(" ")}`,this._mediaObject.payloads=this._mediaObject.payloads.trim(),e.rtcp.cname&&this._mediaObject.ssrcs.push({id:i,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:i,attribute:"msid",value:`${t||"-"} ${s}`}),a&&(e.rtcp.cname&&this._mediaObject.ssrcs.push({id:a,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:a,attribute:"msid",value:`${t||"-"} ${s}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${i} ${a}`}))}planBStopReceiving({offerRtpParameters:e}){let t=e.encodings[0],s=t.ssrc,n=t.rtx&&t.rtx.ssrc?t.rtx.ssrc:void 0;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter(i=>i.id!==s&&i.id!==n),n&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter(i=>i.ssrcs!==`${s} ${n}`))}};D.OfferMediaSection=Jt;function Zt(r){let t=new RegExp("^(audio|video)/(.+)","i").exec(r.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");return t[2]}});var ws=w(V=>{"use strict";var Ri=V&&V.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var n=Object.getOwnPropertyDescriptor(e,t);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,n)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),Oi=V&&V.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),ki=V&&V.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&Ri(e,r,t);return Oi(e,r),e};Object.defineProperty(V,"__esModule",{value:!0});V.RemoteSdp=void 0;var Li=ki(lt()),Di=$(),pt=bs(),Yt=new Di.Logger("RemoteSdp"),Xt=class{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:s,sctpParameters:n,plainRtpParameters:i,planB:a=!1}){if(this._mediaSections=[],this._midToIndex=new Map,this._iceParameters=e,this._iceCandidates=t,this._dtlsParameters=s,this._sctpParameters=n,this._plainRtpParameters=i,this._planB=a,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},e&&e.iceLite&&(this._sdpObject.icelite="ice-lite"),s){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};let o=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:s.fingerprints[o-1].algorithm,hash:s.fingerprints[o-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}i&&(this._sdpObject.origin.address=i.ip,this._sdpObject.origin.ipVer=i.ipVersion)}updateIceParameters(e){Yt.debug("updateIceParameters() [iceParameters:%o]",e),this._iceParameters=e,this._sdpObject.icelite=e.iceLite?"ice-lite":void 0;for(let t of this._mediaSections)t.setIceParameters(e)}updateDtlsRole(e){Yt.debug("updateDtlsRole() [role:%s]",e),this._dtlsParameters.role=e;for(let t of this._mediaSections)t.setDtlsRole(e)}getNextMediaSectionIdx(){for(let e=0;e<this._mediaSections.length;++e){let t=this._mediaSections[e];if(t.closed)return{idx:e,reuseMid:t.mid}}return{idx:this._mediaSections.length}}send({offerMediaObject:e,reuseMid:t,offerRtpParameters:s,answerRtpParameters:n,codecOptions:i,extmapAllowMixed:a=!1}){let o=new pt.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:e,offerRtpParameters:s,answerRtpParameters:n,codecOptions:i,extmapAllowMixed:a});t?this._replaceMediaSection(o,t):this._midToIndex.has(o.mid)?this._replaceMediaSection(o):this._addMediaSection(o)}receive({mid:e,kind:t,offerRtpParameters:s,streamId:n,trackId:i}){let a=this._midToIndex.get(e),o;if(a!==void 0&&(o=this._mediaSections[a]),o)o.planBReceive({offerRtpParameters:s,streamId:n,trackId:i}),this._replaceMediaSection(o);else{o=new pt.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:s,streamId:n,trackId:i});let c=this._mediaSections.find(l=>l.closed);c?this._replaceMediaSection(o,c.mid):this._addMediaSection(o)}}pauseMediaSection(e){this._findMediaSection(e).pause()}resumeSendingMediaSection(e){this._findMediaSection(e).resume()}resumeReceivingMediaSection(e){this._findMediaSection(e).resume()}disableMediaSection(e){this._findMediaSection(e).disable()}closeMediaSection(e){let t=this._findMediaSection(e);if(e===this._firstMid){Yt.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",e),this.disableMediaSection(e);return}t.close(),this._regenerateBundleMids()}planBStopReceiving({mid:e,offerRtpParameters:t}){let s=this._midToIndex.get(e);if(s===void 0)throw new Error(`no media section found with mid '${e}'`);let n=this._mediaSections[s];n.planBStopReceiving({offerRtpParameters:t}),this._replaceMediaSection(n)}sendSctpAssociation({offerMediaObject:e}){let t=new pt.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:e});this._addMediaSection(t)}receiveSctpAssociation({oldDataChannelSpec:e=!1}={}){let t=new pt.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:e});this._addMediaSection(t)}getSdp(){return this._sdpObject.origin.sessionVersion++,Li.write(this._sdpObject)}_addMediaSection(e){this._firstMid||(this._firstMid=e.mid),this._mediaSections.push(e),this._midToIndex.set(e.mid,this._mediaSections.length-1),this._sdpObject.media.push(e.getObject()),this._regenerateBundleMids()}_replaceMediaSection(e,t){if(typeof t=="string"){let s=this._midToIndex.get(t);if(s===void 0)throw new Error(`no media section found for reuseMid '${t}'`);let n=this._mediaSections[s];this._mediaSections[s]=e,this._midToIndex.delete(n.mid),this._midToIndex.set(e.mid,s),this._sdpObject.media[s]=e.getObject(),this._regenerateBundleMids()}else{let s=this._midToIndex.get(e.mid);if(s===void 0)throw new Error(`no media section found with mid '${e.mid}'`);this._mediaSections[s]=e,this._sdpObject.media[s]=e.getObject()}}_findMediaSection(e){let t=this._midToIndex.get(e);if(t===void 0)throw new Error(`no media section found with mid '${e}'`);return this._mediaSections[t]}_regenerateBundleMids(){!this._dtlsParameters||(this._sdpObject.groups[0].mids=this._mediaSections.filter(e=>!e.closed).map(e=>e.mid).join(" "))}};V.RemoteSdp=Xt});var Cs=w(ht=>{"use strict";Object.defineProperty(ht,"__esModule",{value:!0});ht.parse=void 0;var ji=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");function Mi(r){let e=ji.exec(r||"");return e?{spatialLayers:Number(e[1]),temporalLayers:Number(e[2])}:{spatialLayers:1,temporalLayers:1}}ht.parse=Mi});var Ts=w(G=>{"use strict";var Ii=G&&G.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var n=Object.getOwnPropertyDescriptor(e,t);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,n)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),Fi=G&&G.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),Ve=G&&G.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&Ii(e,r,t);return Fi(e,r),e};Object.defineProperty(G,"__esModule",{value:!0});G.Cyxth0=void 0;var Q=Ve(lt()),Ai=$(),Es=Ve(Se()),ke=Ve(it()),ft=Ve(_s()),er=Ve(ys()),$i=vs(),Ni=ws(),Bi=Cs(),_=new Ai.Logger("Cyxth0"),Ss={OS:1024,MIS:1024},Ue=class extends $i.HandlerInterface{static createFactory(){return()=>new Ue}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Cyxth0"}close(){if(_.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){_.debug("getNativeRtpCapabilities()");let e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");let t=await e.createOffer();try{e.close()}catch{}let s=Q.parse(t.sdp);return ft.extractRtpCapabilities({sdpObject:s})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return _.debug("getNativeSctpCapabilities()"),{numStreams:Ss}}run({direction:e,iceParameters:t,iceCandidates:s,dtlsParameters:n,sctpParameters:i,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:l,extendedRtpCapabilities:d}){_.debug("run()"),this._direction=e,this._remoteSdp=new Ni.RemoteSdp({iceParameters:t,iceCandidates:s,dtlsParameters:n,sctpParameters:i}),this._sendingRtpParametersByKind={audio:ke.getSendingRtpParameters("audio",d),video:ke.getSendingRtpParameters("video",d)},this._sendingRemoteRtpParametersByKind={audio:ke.getSendingRemoteRtpParameters("audio",d),video:ke.getSendingRemoteRtpParameters("video",d)},n.role&&n.role!=="auto"&&(this._forcedLocalDtlsRole=n.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:a||[],iceTransportPolicy:o||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...c},l),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":this.emit("@connectionstatechange","connecting");break;case"connected":case"completed":this.emit("@connectionstatechange","connected");break;case"failed":this.emit("@connectionstatechange","failed");break;case"disconnected":this.emit("@connectionstatechange","disconnected");break;case"closed":this.emit("@connectionstatechange","closed");break}})}async updateIceServers(e){_.debug("updateIceServers()");let t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(_.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){let t=await this._pc.createOffer({iceRestart:!0});_.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);let s={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",s),await this._pc.setRemoteDescription(s)}else{let t={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let s=await this._pc.createAnswer();_.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:s,codec:n}){var i;this._assertSendDirection(),_.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((S,O)=>{S.rid=`r${O}`});let a=Es.clone(this._sendingRtpParametersByKind[e.kind],{});a.codecs=ke.reduceCodecs(a.codecs,n);let o=Es.clone(this._sendingRemoteRtpParametersByKind[e.kind],{});o.codecs=ke.reduceCodecs(o.codecs,n);let c=this._remoteSdp.getNextMediaSectionIdx(),l=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t}),d=await this._pc.createOffer(),u=Q.parse(d.sdp),p;this._transportReady||await this._setupTransport({localDtlsRole:(i=this._forcedLocalDtlsRole)!==null&&i!==void 0?i:"client",localSdpObject:u});let h=!1,g=(0,Bi.parse)((t||[{}])[0].scalabilityMode);t&&t.length===1&&g.spatialLayers>1&&a.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(_.debug("send() | enabling legacy simulcast for VP9 SVC"),h=!0,u=Q.parse(d.sdp),p=u.media[c.idx],er.addLegacySimulcast({offerMediaObject:p,numStreams:g.spatialLayers}),d={type:"offer",sdp:Q.write(u)}),_.debug("send() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d);let b=l.mid;if(a.mid=b,u=Q.parse(this._pc.localDescription.sdp),p=u.media[c.idx],a.rtcp.cname=ft.getCname({offerMediaObject:p}),!t)a.encodings=er.getRtpEncodings({offerMediaObject:p});else if(t.length===1){let S=er.getRtpEncodings({offerMediaObject:p});Object.assign(S[0],t[0]),h&&(S=[S[0]]),a.encodings=S}else a.encodings=t;if(a.encodings.length>1&&(a.codecs[0].mimeType.toLowerCase()==="video/vp8"||a.codecs[0].mimeType.toLowerCase()==="video/h264"))for(let S of a.encodings)S.scalabilityMode="S1T3";this._remoteSdp.send({offerMediaObject:p,reuseMid:c.reuseMid,offerRtpParameters:a,answerRtpParameters:o,codecOptions:s,extmapAllowMixed:!0});let f={type:"answer",sdp:this._remoteSdp.getSdp()};return _.debug("send() | calling pc.setRemoteDescription() [answer:%o]",f),await this._pc.setRemoteDescription(f),this._mapMidTransceiver.set(b,l),{localId:b,rtpParameters:a,rtpSender:l.sender}}async stopSending(e){this._assertSendDirection(),_.debug("stopSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.sender.replaceTrack(null);try{t.stop()}catch{}this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid);let s=await this._pc.createOffer();_.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);let n={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this._assertSendDirection(),_.debug("pauseSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);let s=await this._pc.createOffer();_.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);let n={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async resumeSending(e){this._assertSendDirection(),_.debug("resumeSending() [localId:%s]",e);let t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";let s=await this._pc.createOffer();_.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",s),await this._pc.setLocalDescription(s);let n={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n)}async replaceTrack(e,t){this._assertSendDirection(),t?_.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):_.debug("replaceTrack() [localId:%s, no track]",e);let s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");await s.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this._assertSendDirection(),_.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);let s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");let n=s.sender.getParameters();n.encodings.forEach((i,a)=>{a<=t?i.active=!0:i.active=!1}),await s.sender.setParameters(n)}async setRtpEncodingParameters(e,t){this._assertSendDirection(),_.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);let s=this._mapMidTransceiver.get(e);if(!s)throw new Error("associated RTCRtpTransceiver not found");let n=s.sender.getParameters();n.encodings.forEach((i,a)=>{n.encodings[a]={...i,...t}}),await s.sender.setParameters(n)}async getSenderStats(e){this._assertSendDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:s,label:n,protocol:i}){var a;this._assertSendDirection();let o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:s,protocol:i};_.debug("sendDataChannel() [options:%o]",o);let c=this._pc.createDataChannel(n,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Ss.MIS,!this._hasDataChannelMediaSection){let d=await this._pc.createOffer(),u=Q.parse(d.sdp),p=u.media.find(g=>g.type==="application");this._transportReady||await this._setupTransport({localDtlsRole:(a=this._forcedLocalDtlsRole)!==null&&a!==void 0?a:"client",localSdpObject:u}),_.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",d),await this._pc.setLocalDescription(d),this._remoteSdp.sendSctpAssociation({offerMediaObject:p});let h={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setRemoteDescription(h),this._hasDataChannelMediaSection=!0}let l={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:c,sctpStreamParameters:l}}async receive(e){var t;this._assertRecvDirection();let s=[],n=new Map;for(let c of e){let{trackId:l,kind:d,rtpParameters:u}=c;_.debug("receive() [trackId:%s, kind:%s]",l,d);let p=u.mid||String(this._mapMidTransceiver.size);n.set(l,p),this._remoteSdp.receive({mid:p,kind:d,offerRtpParameters:u,streamId:u.rtcp.cname,trackId:l})}let i={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let a=await this._pc.createAnswer(),o=Q.parse(a.sdp);for(let c of e){let{trackId:l,rtpParameters:d}=c,u=n.get(l),p=o.media.find(h=>String(h.mid)===u);ft.applyCodecParameters({offerRtpParameters:d,answerMediaObject:p})}a={type:"answer",sdp:Q.write(o)},this._transportReady||await this._setupTransport({localDtlsRole:(t=this._forcedLocalDtlsRole)!==null&&t!==void 0?t:"client",localSdpObject:o}),_.debug("receive() | calling pc.setLocalDescription() [answer:%o]",a),await this._pc.setLocalDescription(a);for(let c of e){let{trackId:l}=c,d=n.get(l),u=this._pc.getTransceivers().find(p=>p.mid===d);if(u)this._mapMidTransceiver.set(d,u),s.push({localId:d,track:u.receiver.track,rtpReceiver:u.receiver});else throw new Error("new RTCRtpTransceiver not found")}return s}async stopReceiving(e){this._assertRecvDirection();for(let n of e){_.debug("stopReceiving() [localId:%s]",n);let i=this._mapMidTransceiver.get(n);if(!i)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(i.mid)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let s=await this._pc.createAnswer();_.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s);for(let n of e)this._mapMidTransceiver.delete(n)}async pauseReceiving(e){this._assertRecvDirection();for(let n of e){_.debug("pauseReceiving() [localId:%s]",n);let i=this._mapMidTransceiver.get(n);if(!i)throw new Error("associated RTCRtpTransceiver not found");i.direction="inactive",this._remoteSdp.pauseMediaSection(n)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let s=await this._pc.createAnswer();_.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async resumeReceiving(e){this._assertRecvDirection();for(let n of e){_.debug("resumeReceiving() [localId:%s]",n);let i=this._mapMidTransceiver.get(n);if(!i)throw new Error("associated RTCRtpTransceiver not found");i.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(n)}let t={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);let s=await this._pc.createAnswer();_.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",s),await this._pc.setLocalDescription(s)}async getReceiverStats(e){this._assertRecvDirection();let t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:s}){var n;this._assertRecvDirection();let{streamId:i,ordered:a,maxPacketLifeTime:o,maxRetransmits:c}=e,l={negotiated:!0,id:i,ordered:a,maxPacketLifeTime:o,maxRetransmits:c,protocol:s};_.debug("receiveDataChannel() [options:%o]",l);let d=this._pc.createDataChannel(t,l);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();let u={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",u),await this._pc.setRemoteDescription(u);let p=await this._pc.createAnswer();if(!this._transportReady){let h=Q.parse(p.sdp);await this._setupTransport({localDtlsRole:(n=this._forcedLocalDtlsRole)!==null&&n!==void 0?n:"client",localSdpObject:h})}_.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",p),await this._pc.setLocalDescription(p),this._hasDataChannelMediaSection=!0}return{dataChannel:d}}async _setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Q.parse(this._pc.localDescription.sdp));let s=ft.extractDtlsParameters({sdpObject:t});s.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((n,i)=>{this.safeEmit("@connect",{dtlsParameters:s},n,i)}),this._transportReady=!0}_assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}_assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};G.Cyxth0=Ue});var Rs=w(I=>{"use strict";var qi=I&&I.__createBinding||(Object.create?function(r,e,t,s){s===void 0&&(s=t);var n=Object.getOwnPropertyDescriptor(e,t);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,n)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]}),zi=I&&I.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),Ps=I&&I.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&qi(e,r,t);return zi(e,r),e};Object.defineProperty(I,"__esModule",{value:!0});I.Device=I.detectDevice=void 0;var Ui=$(),Vi=Z(),Le=Ce(),Qi=Ps(Se()),Y=Ps(it()),Gi=cs(),Hi=Ts(),M=new Ui.Logger("Device");function xs(){if(typeof navigator=="object"&&typeof navigator.userAgent=="string")return"Cyxth0";M.warn("this._detectDevice() | browser not supported")}I.detectDevice=xs;var tr=class{constructor({handlerName:e,handlerFactory:t,Handler:s}={}){if(this._loaded=!1,this._observer=new Vi.EnhancedEventEmitter,M.debug("constructor()"),s)if(M.warn("constructor() | Handler option is DEPRECATED, use handlerName or handlerFactory instead"),typeof s=="string")e=s;else throw new TypeError("non string Handler option no longer supported, use handlerFactory instead");if(e&&t)throw new TypeError("just one of handlerName or handlerInterface can be given");if(t)this._handlerFactory=t;else{if(e)M.debug("constructor() | handler given: %s",e);else if(e=xs(),e)M.debug("constructor() | detected handler: %s",e);else throw new Le.UnsupportedError("device not supported");this._handlerFactory=Hi.Cyxth0.createFactory()}let n=this._handlerFactory();this._handlerName=n.name,n.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new Le.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new Le.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:e}){M.debug("load() [routerRtpCapabilities:%o]",e),e=Qi.clone(e,void 0);let t;try{if(this._loaded)throw new Le.InvalidStateError("already loaded");Y.validateRtpCapabilities(e),t=this._handlerFactory();let s=await t.getNativeRtpCapabilities();M.debug("load() | got native RTP capabilities:%o",s),Y.validateRtpCapabilities(s),this._extendedRtpCapabilities=Y.getExtendedRtpCapabilities(s,e),M.debug("load() | got extended RTP capabilities:%o",this._extendedRtpCapabilities),this._canProduceByKind.audio=Y.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=Y.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=Y.getRecvRtpCapabilities(this._extendedRtpCapabilities),Y.validateRtpCapabilities(this._recvRtpCapabilities),M.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._sctpCapabilities=await t.getNativeSctpCapabilities(),M.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),Y.validateSctpCapabilities(this._sctpCapabilities),M.debug("load() succeeded"),this._loaded=!0,t.close()}catch(s){throw t&&t.close(),s}}canProduce(e){if(this._loaded){if(e!=="audio"&&e!=="video")throw new TypeError(`invalid kind "${e}"`)}else throw new Le.InvalidStateError("not loaded");return this._canProduceByKind[e]}createSendTransport({id:e,iceParameters:t,iceCandidates:s,dtlsParameters:n,sctpParameters:i,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:l,appData:d}){return M.debug("createSendTransport()"),this._createTransport({direction:"send",id:e,iceParameters:t,iceCandidates:s,dtlsParameters:n,sctpParameters:i,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:l,appData:d})}createRecvTransport({id:e,iceParameters:t,iceCandidates:s,dtlsParameters:n,sctpParameters:i,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:l,appData:d}){return M.debug("createRecvTransport()"),this._createTransport({direction:"recv",id:e,iceParameters:t,iceCandidates:s,dtlsParameters:n,sctpParameters:i,iceServers:a,iceTransportPolicy:o,additionalSettings:c,proprietaryConstraints:l,appData:d})}_createTransport({direction:e,id:t,iceParameters:s,iceCandidates:n,dtlsParameters:i,sctpParameters:a,iceServers:o,iceTransportPolicy:c,additionalSettings:l,proprietaryConstraints:d,appData:u}){if(this._loaded){if(typeof t!="string")throw new TypeError("missing id");if(typeof s!="object")throw new TypeError("missing iceParameters");if(Array.isArray(n)){if(typeof i!="object")throw new TypeError("missing dtlsParameters");if(a&&typeof a!="object")throw new TypeError("wrong sctpParameters");if(u&&typeof u!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing iceCandidates")}else throw new Le.InvalidStateError("not loaded");let p=new Gi.Transport({direction:e,id:t,iceParameters:s,iceCandidates:n,dtlsParameters:i,sctpParameters:a,iceServers:o,iceTransportPolicy:c,additionalSettings:l,proprietaryConstraints:d,appData:u,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",p),p}};I.Device=tr});var H=class{constructor(){this.callbacks={}}on(e,t){this.callbacks[e]=t}dispatch(e,t){let s=this.callbacks[e];s&&s(t)}drop(e){this.callbacks[e]&&delete this.callbacks[e]}};var Os=Ws(Rs(),1);var ie,ae,oe,De,ce,de,je,Qe,rr,_t,ks,yt,Ls,vt,Ds,bt,js,wt,Ms,Ge,sr,Ct,Is,mt=class{constructor(e,t){C(this,Qe);C(this,_t);C(this,yt);C(this,vt);C(this,bt);C(this,wt);C(this,Ge);C(this,Ct);C(this,ie,void 0);C(this,ae,void 0);C(this,oe,void 0);C(this,De,void 0);C(this,ce,void 0);C(this,de,void 0);C(this,je,void 0);this.transport=e,this.channel=t,this.eventEmitter=new H,T(this,De,[]),T(this,ce,[]),T(this,ae,{}),T(this,oe,new Os.Device),T(this,ie,{encodings:[{rid:"r0",maxBitrate:1e5,scalabilityMode:"S1T3"},{rid:"r1",maxBitrate:3e5,scalabilityMode:"S1T3"},{rid:"r2",maxBitrate:9e5,scalabilityMode:"S1T3"}],codecOptions:{videoGoogleStartBitrate:1e3}}),this.transport.eventEmmiter.on("call:adduser:1",s=>{console.log("add new user to call"),y(this,ce).push(JSON.parse(s));let{producer_id:n}=JSON.parse(s);x(this,Ge,sr).call(this,n)}),this.transport.eventEmmiter.on("call:removeuser:1",s=>{console.log("remove user with id from call"),console.log(s)})}start(){this.transport.cend("call:init",{channel:this.channel},1).then(e=>{x(this,Qe,rr).call(this)}).catch(e=>{})}join(){x(this,Qe,rr).call(this)}on(e,t){this.eventEmitter.on(e,t)}endCall(){}};ie=new WeakMap,ae=new WeakMap,oe=new WeakMap,De=new WeakMap,ce=new WeakMap,de=new WeakMap,je=new WeakMap,Qe=new WeakSet,rr=function(){navigator.mediaDevices.getUserMedia({audio:!1,video:{width:{min:640,max:1920},height:{min:400,max:1080}}}).then(e=>x(this,_t,ks).call(this,e)).catch(e=>{console.error(e.message)})},_t=new WeakSet,ks=function(e){let t=e.getVideoTracks()[0];this.eventEmitter.dispatch("localStream",{stream:e}),T(this,ie,{track:t,...y(this,ie)}),x(this,yt,Ls).call(this)},yt=new WeakSet,Ls=function(){this.transport.cend("call:start",{channel:this.channel},1).then(e=>{T(this,ae,e.rtp_capabilites),x(this,vt,Ds).call(this)}).catch(e=>console.error(e))},vt=new WeakSet,Ds=async function(){try{await y(this,oe).load({routerRtpCapabilities:y(this,ae)}),x(this,bt,js).call(this)}catch(e){console.log(e)}},bt=new WeakSet,js=function(){this.transport.cend("call:createtransport",{channel:this.channel,data:{action:"CreateWebrtcTransport",consumer:!1}},1).then(e=>{if(e.error){console.error(e.error);return}T(this,de,y(this,oe).createSendTransport(e.params)),y(this,de)?.on("connect",({dtlsParameters:t},s,n)=>{this.transport.cend("call:transportconnect",{channel:this.channel,data:{action:"TransportConnect",dtlsParameters:t}},1).then(()=>s()).catch(n)}),y(this,de)?.on("produce",(t,s,n)=>{this.transport.cend("call:transportproduce",{channel:this.channel,data:{action:"TransportProduce",kind:t.kind,rtpParameters:t.rtpParameters}},1).then(({id:i,producers:a})=>{T(this,ce,a),a.forEach((o,c)=>{setTimeout(()=>{x(this,Ge,sr).call(this,o.producer_id)},c*100)}),s(i)}).catch(i=>n(i))}),x(this,wt,Ms).call(this)}).catch(e=>console.error(e))},wt=new WeakSet,Ms=async function(){T(this,je,await y(this,de)?.produce(y(this,ie))),y(this,je)?.on("trackended",()=>{console.error("track endended")}),y(this,je)?.on("transportclose",()=>{console.error("track endended")})},Ge=new WeakSet,sr=function(e){this.transport.cend("call:createtransport",{channel:this.channel,data:{action:"CreateWebrtcTransport",consumer:!0}},1).then(({params:t})=>{if(t.error){console.error(t.error);return}let s;try{s=y(this,oe).createRecvTransport(t)}catch(n){console.log("error creating consumer transport",n);return}s?.on("connect",({dtlsParameters:n},i,a)=>{console.log("consumer transport connected"),this.transport.cend("call:transport-recv-connect",{channel:this.channel,data:{action:"TransportRecvConnect",dtlsParameters:n,transportId:t.id}},1).then(()=>i()).catch(o=>a(o))}),x(this,Ct,Is).call(this,s,e,t.id)}).catch(t=>console.error(t))},Ct=new WeakSet,Is=function(e,t,s){this.transport.cend("call:consume",{channel:this.channel,data:{action:"Consume",rtpCapabilites:y(this,ae),producerId:t,transportId:s}},1).then(async n=>{if(n.error){console.error("could not consume",n.error);return}let i=await e.consume({id:n.id,producerId:n.producerId,kind:n.kind,rtpParameters:n.rtpParameters});T(this,De,[...y(this,De),{consumerTransport:e,consumerId:n.id,producerId:t,consumer:i}]);let a=y(this,ce).filter(l=>l.producer_id===t)[0];a=a?.user_id;let{track:o}=i,c=new MediaStream([o]);this.eventEmitter.dispatch("remoteStream",{stream:c,user_id:a}),this.transport.cend("call:consumeresume",{channel:this.channel,data:{action:"ConsumeResume",consumerId:n.id}},1).then(()=>{}).catch(l=>console.log(l))})};var He,Ke,gt=class{constructor(e,t){C(this,He,void 0);C(this,Ke,void 0);T(this,He,e),T(this,Ke,t)}accept(){return new Promise((t,s)=>{let n=new mt(y(this,He),y(this,Ke));n.join(),t(n)})}reject(){console.log("call rejected")}};He=new WeakMap,Ke=new WeakMap;var Fs=mt;var nr=(r=21)=>{let e="1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",t=e.length,s=[];for(let n=0;n<r;n++)s.push(e[Math.round(Math.random()*100)%t]);return s.join("")},As=(r,e)=>{let t=r.reduce((s,n)=>s.set(n[e],[...s.get(n[e])||[],n]),new Map);return Object.fromEntries(t)};var F,le,Et,$s,ir=class{constructor(e){C(this,Et);C(this,F,void 0);C(this,le,void 0);T(this,F,e),this.eventEmmiter=new H,T(this,le,[]),x(this,Et,$s).call(this)}onOpen(){for(this.eventEmmiter.dispatch("transportReady",{});y(this,le).length>0;)this.send(y(this,le).pop())}waitOpen(){return new Promise((t,s)=>{let n="transportReady",i=setTimeout(()=>{this.eventEmmiter.drop(n),s(new Error("CommandTimeout"))},1e3);this.eventEmmiter.on(n,()=>{this.eventEmmiter.drop(n),clearTimeout(i),t(!0)})})}onClose(){}onError(e){console.error("transport disconected")}onMessage(e){let t=new ar(e.data).parse();if(t?.type==="message")this.eventEmmiter.dispatch("message",t.data);else if(t?.type==="reply"){if(t.reply){let{channel_trail:s,data_back:n}=t.reply;this.eventEmmiter.dispatch(`reply:${s}`,n)}}else{let{command:s,data:n}=t.data;this.eventEmmiter.dispatch(s,n)}}send(e){let s=new TextEncoder().encode(e);y(this,F).readyState!==1?(console.log("[info] message queued while connecting"),y(this,le).push(s)):y(this,F).send(s)}cend(e,t,s){let n=JSON.stringify(t),i=nr(12);s&&(i=s);let a=`#${e}\r
@${i}\r
$${n.length}\r
${n}\r
`;return this.send(a),this.sendPromise(`${e}:${i}`,1e4)}sendm(e,t){let s=nr(12),n=this.replaceEmoji(t.text);t.media&&(n+=`\r	${JSON.stringify(t.media)}`);let i=`>${e}\r
@${s}\r
$${n.length}\r
${n}\r
`;return this.send(i),this.sendPromise(`reply:${e}:${s}`,1e4)}replaceEmoji(e){let t=/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/g;return e.replace(t,function(s,n,i){return`:u+${i.codePointAt(n).toString(16)}`})}sendPromise(e,t=0){return new Promise((n,i)=>{let a=setTimeout(()=>{},0);t>0&&(a=setTimeout(()=>{this.eventEmmiter.drop(e),i(new Error("Timeout"))},t)),this.eventEmmiter.on(e,o=>{this.eventEmmiter.drop(e),clearTimeout(a);let c=JSON.parse(o);c.error&&i(new Error(c.error)),n(c)})})}on(e,t){this.eventEmmiter.on(e,t)}};F=new WeakMap,le=new WeakMap,Et=new WeakSet,$s=function(){y(this,F).binaryType="arraybuffer",y(this,F).onmessage=e=>this.onMessage(e),y(this,F).onerror=e=>this.onError(e),y(this,F).onclose=()=>this.onClose(),y(this,F).onopen=()=>this.onOpen()};var ar=class{constructor(e){this.raw=e,this.data=new DataView(e),this.position=0,this.len=this.data.byteLength,this.remaining=this.data.byteLength}parse(){switch(this.getU8()){case">":{let t={},n=this.getLine().split(":");if(n.length!=2||(t.channel=n[0],t.sender=n[1],this.getU8()!=="@"))return null;let a=this.getLine();t.message_id=a;let o=this.parse();if(o?.data)typeof o.data=="string"&&(t.text=o.data);else return null;return{type:"message",data:t}}case"#":{let t={},s=this.getLine();t.command=s;let n=this.parse();if(n?.data)t.data=n.data;else return null;return{type:"command",data:t}}case"<":{let t={},s=this.getLine();t.channel_trail=s;let n=this.parse();if(n?.data)typeof n.data=="string"&&(t.data_back=n.data);else return null;return{type:"reply",reply:t}}case"$":{let t=parseInt(this.getLine());if(isNaN(t))return null;let s=t+2;return this.remaining<s?null:{data:this.getLine()}}}return null}getU8(){if(!this.len)return 0;let e=this.data.getUint8(this.position);return this.position+=1,String.fromCodePoint(e)}getLine(){let e=this.position,t=this.len-1,s="";for(let n=e;n<=t;n++){let i=a=>String.fromCodePoint(this.data.getUint8(a));if(s+=String.fromCodePoint(this.data.getUint8(n)),i(n)==="\r"&&i(n+1)===`
`)return this.position=n+2,s.substring(0,s.length-1)}return s}},Ns=ir;var ue,L,St,Bs,Tt,qs,We,cr,or=class{constructor(e){C(this,St);C(this,Tt);C(this,We);C(this,ue,void 0);C(this,L,void 0);this.appUrl=e,this.connected=!1,T(this,ue,new H),T(this,L,null)}async connect(e){let{token:t,code_challenge:s,code_verifier:n}=e,i=await x(this,St,Bs).call(this,t,s),a=`ws://${this.appUrl}/chat/?token=${i.token_string}&code_verifier=${n}`,o;try{o=new WebSocket(a)}catch{throw new Error("CONNECTION")}return T(this,L,new Ns(o)),y(this,L).on("message",c=>{let l=this.parseContent(c.text),d=x(this,We,cr).call(this,c.message_id),u={channel_id:c.channel,sender_id:c.sender,text:l.text,date:d.time,rdate:d.date,id:c.message_id};l.media&&(u.media=l.media),y(this,ue).dispatch("message",u)}),y(this,L).on("newcall",c=>{let l=JSON.parse(c);y(this,L)&&y(this,ue).dispatch("call",{channel:l.channel,request:new gt(y(this,L),l.channel)})}),this.connected=!0,y(this,L).waitOpen()}on(e,t){y(this,ue).on(e,t)}sendMessage(e,t,s){return y(this,L)?.sendm(e,t)}startCall(e,t){return new Promise((n,i)=>{if(y(this,L)){let a=new Fs(y(this,L),e);a.start(),n(a)}else i("NOTCONNECTED")})}async getAllUpdates(e,t,s){return new Promise((i,a)=>{this.connected||a("DISCONNECTED"),y(this,L)?.cend("channel:state",{channels:e,date:t,duration:s}).then(o=>{o.updates||a(o);let c=o.updates;return c=c.map(l=>{let d=this.parseContent(l.content),u=x(this,We,cr).call(this,l.message_id),p={sender_id:l.sender_id,text:d.text,date:u.time,rdate:u.date,channel_id:l.channel_id,id:l.message_id};return d.media&&(p.media=d.media),p}),i(As(c,"channel_id"))}).catch(o=>{a(o)})})}updateString(e){let t=/(?::u\+)\w+/g;return e.replace(t,function(s,n,i){let a=parseInt(e.substring(n+3,n+8),16);return isNaN(a)?e.substring(n,n+8):String.fromCodePoint(a)})}async getDialogs(){return y(this,L)?.cend("channel:get",{})}parseContent(e){e=this.updateString(e);let t={},s=e.split("\r	");if(t.text=s[0],s[1]){let n=x(this,Tt,qs).call(this,s[1]);n&&(t.media=n)}return s[2]&&(t.meta=s[2]),t}};ue=new WeakMap,L=new WeakMap,St=new WeakSet,Bs=async function(e,t){let s=`http://${this.appUrl}/authorize`;return await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",accept:"application/json"},body:JSON.stringify({token:e,code_challenge:t})}).then(i=>i.json()).then(i=>i).catch(i=>i)},Tt=new WeakSet,qs=function(e){try{return JSON.parse(e)}catch{return null}},We=new WeakSet,cr=function(e){let t={hour:"numeric",minute:"numeric"},s=new Date(Number(BigInt(e)>>22n));return{date:s,time:s.toLocaleTimeString("en-US",t)}};var Aa=or;export{Aa as default};
