var S=class{constructor(){this.callbacks={}}on(e,t){this.callbacks[e]=t}dispatch(e,t){let n=this.callbacks[e];n&&n(t)}off(e){this.callbacks[e]&&delete this.callbacks[e]}clearAllEvents(){this.callbacks={}}cleaEvents(e){e.forEach(t=>{this.off(t)})}};var J=(i,e=!0)=>{let t=[255&i>>24,255&i>>16,255&i>>8,255&i];return e&&t.reverse(),t},C=(i,e)=>Object.prototype.toString.call(i)==="[object "+e+"]",T=class{#t;#e;constructor(e){this.#t=0,this.#e=new DataView(e)}getU8(){let e=this.#e.getUint8(this.#t);return this.#t+=1,e}getFixedSeq(e){let t=this.#e.buffer.slice(this.#t,this.#t+e);return this.#t+=e,t}getSeq(){let e=this.getU32();return this.getFixedSeq(e)}getU32(){let e=this.#e.getUint32(this.#t,!0);return this.#t+=4,e}geti64(){let e=this.#e.getBigInt64(this.#t,!0);return this.#t+=8,e}getString(){let e=this.getSeq();return new TextDecoder().decode(e)}getRest(){return this.#e.buffer.slice(this.#t)}asString(e){return new TextDecoder().decode(e)}};var a,v=new Array(128).fill(void 0);v.push(void 0,null,!0,!1);var L=v.length;function g(i){L===v.length&&v.push(v.length+1);let e=L;return L=v[e],v[e]=i,e}var V=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&V.decode();var E=null;function W(){return(E===null||E.byteLength===0)&&(E=new Uint8Array(a.memory.buffer)),E}function H(i,e){return i=i>>>0,V.decode(W().subarray(i,i+e))}function h(i){return v[i]}var m=0,B=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},ee=typeof B.encodeInto=="function"?function(i,e){return B.encodeInto(i,e)}:function(i,e){let t=B.encode(i);return e.set(t),{read:i.length,written:t.length}};function x(i,e,t){if(t===void 0){let l=B.encode(i),c=e(l.length,1)>>>0;return W().subarray(c,c+l.length).set(l),m=l.length,c}let n=i.length,r=e(n,1)>>>0,s=W(),o=0;for(;o<n;o++){let l=i.charCodeAt(o);if(l>127)break;s[r+o]=l}if(o!==n){o!==0&&(i=i.slice(o)),r=t(r,n,n=o+i.length*3,1)>>>0;let l=W().subarray(r+o,r+n),c=ee(i,l);o+=c.written,r=t(r,n,o,1)>>>0}return m=o,r}function M(i){return i==null}var P=null;function u(){return(P===null||P.byteLength===0)&&(P=new Int32Array(a.memory.buffer)),P}var D=null;function G(){return(D===null||D.byteLength===0)&&(D=new Float64Array(a.memory.buffer)),D}function te(i){i<132||(v[i]=L,L=i)}function _(i){let e=h(i);return te(i),e}function ne(i,e){try{return i.apply(this,e)}catch(t){a.__wbindgen_exn_store(g(t))}}var re=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(i=>a.__wbg_client_free(i>>>0)),R=class{__destroy_into_raw(){let e=this.__wbg_ptr;return this.__wbg_ptr=0,re.unregister(this),e}free(){let e=this.__destroy_into_raw();a.__wbg_client_free(e)}constructor(e){let t=a.client_new(e);return this.__wbg_ptr=t>>>0,this}update(e,t){try{let o=a.__wbindgen_add_to_stack_pointer(-16);a.client_update(o,this.__wbg_ptr,g(e),g(t));var n=u()[o/4+0],r=u()[o/4+1],s=u()[o/4+2];if(s)throw _(r);return _(n)}finally{a.__wbindgen_add_to_stack_pointer(16)}}delete(e){try{let s=a.__wbindgen_add_to_stack_pointer(-16);a.client_delete(s,this.__wbg_ptr,g(e));var t=u()[s/4+0],n=u()[s/4+1],r=u()[s/4+2];if(r)throw _(n);return _(t)}finally{a.__wbindgen_add_to_stack_pointer(16)}}text_insert(e,t,n){try{let l=a.__wbindgen_add_to_stack_pointer(-16),c=x(e,a.__wbindgen_malloc,a.__wbindgen_realloc),d=m,w=x(n,a.__wbindgen_malloc,a.__wbindgen_realloc),f=m;a.client_text_insert(l,this.__wbg_ptr,c,d,t,w,f);var r=u()[l/4+0],s=u()[l/4+1],o=u()[l/4+2];if(o)throw _(s);return _(r)}finally{a.__wbindgen_add_to_stack_pointer(16)}}text_delete(e,t,n){try{let l=a.__wbindgen_add_to_stack_pointer(-16),c=x(e,a.__wbindgen_malloc,a.__wbindgen_realloc),d=m;a.client_text_delete(l,this.__wbg_ptr,c,d,t,n);var r=u()[l/4+0],s=u()[l/4+1],o=u()[l/4+2];if(o)throw _(s);return _(r)}finally{a.__wbindgen_add_to_stack_pointer(16)}}text_replace(e,t,n,r){try{let c=a.__wbindgen_add_to_stack_pointer(-16),d=x(e,a.__wbindgen_malloc,a.__wbindgen_realloc),w=m,f=x(n,a.__wbindgen_malloc,a.__wbindgen_realloc),y=m;a.client_text_replace(c,this.__wbg_ptr,d,w,t,f,y,r);var s=u()[c/4+0],o=u()[c/4+1],l=u()[c/4+2];if(l)throw _(o);return _(s)}finally{a.__wbindgen_add_to_stack_pointer(16)}}counter_update(e,t){try{let o=a.__wbindgen_add_to_stack_pointer(-16),l=x(e,a.__wbindgen_malloc,a.__wbindgen_realloc),c=m;a.client_counter_update(o,this.__wbg_ptr,l,c,t);var n=u()[o/4+0],r=u()[o/4+1],s=u()[o/4+2];if(s)throw _(r);return _(n)}finally{a.__wbindgen_add_to_stack_pointer(16)}}apply(e,t,n){try{let l=a.__wbindgen_add_to_stack_pointer(-16);a.client_apply(l,this.__wbg_ptr,e,t,g(n));var r=u()[l/4+0],s=u()[l/4+1],o=u()[l/4+2];if(o)throw _(s);return _(r)}finally{a.__wbindgen_add_to_stack_pointer(16)}}patch(e,t){try{let o=a.__wbindgen_add_to_stack_pointer(-16);a.client_patch(o,this.__wbg_ptr,e,g(t));var n=u()[o/4+0],r=u()[o/4+1],s=u()[o/4+2];if(s)throw _(r);return _(n)}finally{a.__wbindgen_add_to_stack_pointer(16)}}query(e){try{let s=a.__wbindgen_add_to_stack_pointer(-16);a.client_query(s,this.__wbg_ptr,g(e));var t=u()[s/4+0],n=u()[s/4+1],r=u()[s/4+2];if(r)throw _(n);return _(t)}finally{a.__wbindgen_add_to_stack_pointer(16)}}query_length(e){try{let s=a.__wbindgen_add_to_stack_pointer(-16);a.client_query_length(s,this.__wbg_ptr,g(e));var t=u()[s/4+0],n=u()[s/4+1],r=u()[s/4+2];if(r)throw _(n);return _(t)}finally{a.__wbindgen_add_to_stack_pointer(16)}}query_text(e){try{let r=a.__wbindgen_add_to_stack_pointer(-16),s=x(e,a.__wbindgen_malloc,a.__wbindgen_realloc),o=m;a.client_query_text(r,this.__wbg_ptr,s,o);var t=u()[r/4+0],n=u()[r/4+1];let l;return t!==0&&(l=H(t,n).slice(),a.__wbindgen_free(t,n*1,1)),l}finally{a.__wbindgen_add_to_stack_pointer(16)}}query_counter(e){try{let r=a.__wbindgen_add_to_stack_pointer(-16),s=x(e,a.__wbindgen_malloc,a.__wbindgen_realloc),o=m;a.client_query_counter(r,this.__wbg_ptr,s,o);var t=u()[r/4+0],n=G()[r/8+1];return t===0?void 0:n}finally{a.__wbindgen_add_to_stack_pointer(16)}}value(){let e=a.client_value(this.__wbg_ptr);return _(e)}load(e){try{let r=a.__wbindgen_add_to_stack_pointer(-16);a.client_load(r,this.__wbg_ptr,g(e));var t=u()[r/4+0],n=u()[r/4+1];if(n)throw _(t)}finally{a.__wbindgen_add_to_stack_pointer(16)}}is_offline(){return a.client_is_offline(this.__wbg_ptr)!==0}toggle_offline(e){try{let s=a.__wbindgen_add_to_stack_pointer(-16);a.client_toggle_offline(s,this.__wbg_ptr,e);var t=u()[s/4+0],n=u()[s/4+1],r=u()[s/4+2];if(r)throw _(n);return _(t)}finally{a.__wbindgen_add_to_stack_pointer(16)}}consume(e){try{let r=a.__wbindgen_add_to_stack_pointer(-16);a.client_consume(r,this.__wbg_ptr,g(e));var t=u()[r/4+0],n=u()[r/4+1];if(n)throw _(t)}finally{a.__wbindgen_add_to_stack_pointer(16)}}consume_batch(e){try{let s=a.__wbindgen_add_to_stack_pointer(-16);a.client_consume_batch(s,this.__wbg_ptr,g(e));var t=u()[s/4+0],n=u()[s/4+1],r=u()[s/4+2];if(r)throw _(n);return _(t)}finally{a.__wbindgen_add_to_stack_pointer(16)}}};async function ie(i,e){if(typeof Response=="function"&&i instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(i,e)}catch(n){if(i.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",n);else throw n}let t=await i.arrayBuffer();return await WebAssembly.instantiate(t,e)}else{let t=await WebAssembly.instantiate(i,e);return t instanceof WebAssembly.Instance?{instance:t,module:i}:t}}function se(){let i={};return i.wbg={},i.wbg.__wbindgen_number_new=function(e){return g(e)},i.wbg.__wbindgen_string_new=function(e,t){let n=H(e,t);return g(n)},i.wbg.__wbindgen_is_string=function(e){return typeof h(e)=="string"},i.wbg.__wbindgen_string_get=function(e,t){let n=h(t),r=typeof n=="string"?n:void 0;var s=M(r)?0:x(r,a.__wbindgen_malloc,a.__wbindgen_realloc),o=m;u()[e/4+1]=o,u()[e/4+0]=s},i.wbg.__wbindgen_number_get=function(e,t){let n=h(t),r=typeof n=="number"?n:void 0;G()[e/8+1]=M(r)?0:r,u()[e/4+0]=!M(r)},i.wbg.__wbindgen_object_drop_ref=function(e){_(e)},i.wbg.__wbindgen_is_array=function(e){return Array.isArray(h(e))},i.wbg.__wbindgen_is_object=function(e){let t=h(e);return typeof t=="object"&&t!==null},i.wbg.__wbindgen_is_null=function(e){return h(e)===null},i.wbg.__wbindgen_boolean_get=function(e){let t=h(e);return typeof t=="boolean"?t?1:0:2},i.wbg.__wbg_get_bd8e338fbd5f5cc8=function(e,t){let n=h(e)[t>>>0];return g(n)},i.wbg.__wbg_length_cd7af8117672b8b8=function(e){return h(e).length},i.wbg.__wbg_new_16b304a2cfa7ff4a=function(){let e=new Array;return g(e)},i.wbg.__wbg_new_72fb9a18b5ae2624=function(){let e=new Object;return g(e)},i.wbg.__wbg_from_89e3fc3ba5e6fb48=function(e){let t=Array.from(h(e));return g(t)},i.wbg.__wbg_push_a5b05aedc7234f9f=function(e,t){return h(e).push(h(t))},i.wbg.__wbg_entries_95cc2c823b285a09=function(e){let t=Object.entries(h(e));return g(t)},i.wbg.__wbg_buffer_12d079cc21e14bdb=function(e){let t=h(e).buffer;return g(t)},i.wbg.__wbg_newwithbyteoffsetandlength_aa4a17c33a06e5cb=function(e,t,n){let r=new Uint8Array(h(e),t>>>0,n>>>0);return g(r)},i.wbg.__wbg_new_63b92bc8671ed464=function(e){let t=new Uint8Array(h(e));return g(t)},i.wbg.__wbg_set_a47bac70306a19a7=function(e,t,n){h(e).set(h(t),n>>>0)},i.wbg.__wbg_length_c20a40f15020d68a=function(e){return h(e).length},i.wbg.__wbg_set_1f9b04f170055d33=function(){return ne(function(e,t,n){return Reflect.set(h(e),h(t),h(n))},arguments)},i.wbg.__wbindgen_throw=function(e,t){throw new Error(H(e,t))},i.wbg.__wbindgen_memory=function(){let e=a.memory;return g(e)},i}function oe(i,e){return a=i.exports,Q.__wbindgen_wasm_module=e,D=null,P=null,E=null,a}async function Q(i){if(a!==void 0)return a;typeof i>"u"&&(i=new URL("colab_client_bg.wasm",import.meta.url));let e=se();(typeof i=="string"||typeof Request=="function"&&i instanceof Request||typeof URL=="function"&&i instanceof URL)&&(i=fetch(i));let{instance:t,module:n}=await ie(await i,e);return oe(t,n)}var X=Q;var K=Symbol("PARAM"),q=Symbol("LAST"),Y=Symbol("TERM"),j=class{#t;#e;#n;#i;#s;constructor(e,t){this.key=t,this.defaultHandlers={insert:void 0,update:void 0,delete:void 0},this.#t=e,this.#e=e.getClient(),this.#n={},this.#i=[{},{},{}],this.#s=void 0,this.#t._handlers[2][this.key]=this.#a}get state(){return ae(this,[])}setActions(e){let t=le(e);return this.#n={...this.#n,...structuredClone(t)},this.#o(),new Proxy(this.#n,this.#c())}setHandlers(e){this.#s=e}value(){return this.__getVal([])}_chain(){return z(this,[])}#c(){let e=this;return{get(t,n){let r=t[n];if(!r)throw"invalid action";return function(){if(arguments.length<r.args.length)throw`${n}: takes ~${r.args.length} but got ${arguments.length}`;let s=[...r.path],o,l=r.action;if(r.args.forEach((c,d)=>{c!==null&&c.forEach(w=>{w==="_val"?o=arguments[d]:s[w]=arguments[d]})}),r.dyn)try{let c=e.__getIdx(s);if(l===0)c=c===void 0?-2:-c-2,l=1;else if(l===2)if(c!==void 0&&c>0)c-=1;else throw"empty list";else throw"invalid action";s.push(c)}catch(c){throw console.error("failed to get last index",c),c}return e.__route({action:l,path:s,value:o}),!0}}}}#o(){let e=this.#i;Object.entries(this.#n).forEach(([t,n])=>{let r=e[n.action],s=r,o=[...n.path];n.dyn&&o.push(q);let l=o.length-1,c=0;for(let d of o)d===null&&(d=K),r[d]===void 0&&(r[d]={}),c===l&&(r[d][Y]=t),r=r[d],c+=1;r=s}),this.#i=e}#u(e,t){let n=this.#i[e],r,s;for(let o of t){if(o<0&&n[q]){s=o,n=n[q];break}if(n[o])n=n[o];else if(n[K])n=n[K];else if(n[q])n=n[q],s=o;else return}if(r=n[Y],r!==void 0)return{name:r,lastIdx:s}}#a(e,t){if(e[e.length-1]===void 0){let o=e.slice(0,e.length-1);this.__notify({action:2,path:o},{userId:t});return}let n=e[e.length-1],r=e.slice(0,e.length-1),s={userId:t};n[1]!==null&&(s.hasConcurrent=!0,s.concurrent=n[1]),this.__notify({action:1,path:r,value:n[0]},s)}__getIdx(e){return e.unshift(this.key),this.#e.query_length(e)}__getVal(e){e.unshift(this.key);let t=this.#e.query(e);if(!t)return;let n={value:t[0]};return t[1]!==null&&(n.concurrent=t[1]),n}__route(e){let{action:t,path:n,value:r}=e;n.unshift(this.key),this.__notify({action:t,value:r,path:[...n]},{isLocal:!0});let s;if(t===1)s=this.#e.update(n,r);else if(t===2)s=this.#e.delete(n);else{console.info("unhandled tree action",t);return}this.#t.innerSend(s)}__notify(e,t){let{action:n,path:r,value:s}=e;if(r[0]!==this.key)return;r.shift();let o=r[r.length-1],l=n;typeof o=="number"&&o<0&&(l=0);let c=this.#u(l,r);if(c!==void 0&&this.#s[c.name]){let d=c.name,w=this.#s[d],f=this.#n[d],y=f.args.map(p=>{let I=p[0];return I==="_val"?s:r[I]});f.dyn&&c.lastIdx&&(n===1&&(t.pushIndex=-c.lastIdx-2),n===2&&(t.popIndex=c.lastIdx)),w(...y,t);return}if(n===1){let d=r[r.length-1];if(typeof d=="number"&&d<0){r[r.length-1]=-d-2,this.defaultHandlers.insert?.(r,s,t);return}this.defaultHandlers.update?.(r,s,t)}else n===2&&this.defaultHandlers.delete?.(r,t)}};function Z(i,e){return{insert(t,n){return e.push(-t-2),i.__route({action:1,path:e,value:n}),e=[],!0},update(t){return i.__route({action:1,path:e,value:t}),e=[],!0},delete(){return i.__route({action:2,path:[...e]}),e=[],!0},push(t){try{let n=i.__getIdx(e);return n=n===void 0?-2:-n-2,e.push(n),this.update(t)}catch(n){throw console.error("failed to get last index",n),n}},pop(){try{let t=i.__getIdx(e);if(t!==void 0&&t>0){let n=t-1;return e.push(n),this.delete()}throw"list is empty"}catch(t){throw console.error("failed to get last index",t),t}},length(){try{let t=i.__getIdx(e);return e=[],t}catch(t){throw console.error("failed to get last index",t),t}},value(){let t=i.__getVal(e);return e=[],t}}}function ae(i,e){let t=o=>{let l=parseInt(o);return isNaN(l)?o:l},n=Z(i,e),r=()=>({get(o,l){let c=o[l];if(c===void 0)return e.push(t(l)),s;if(typeof c=="function")return Reflect.get(o,l)},set(o,l,c){return e.push(t(l)),n.update(c)}});var s=new Proxy(n,r());return s}function z(i,e){let t=Z(i,e);return{update:n=>t.update(n),delete:()=>t.delete(),value:()=>t.value(),keypath(n){return e.push(...n),z(i,e)},list(n){return n&&e.push(...n),{push:r=>t.push(r),pop:()=>t.pop(),insert:(r,s)=>t.insert(r,s),value:()=>t.value(),length:()=>t.length(),update:(r,s)=>(e.push(r),t.update(s)),delete:r=>(e.push(r),t.delete()),index:r=>(e.push(r),z(i,e))}}}}function le(i){let e=[],t={},n=Symbol("_bt"),r=!1,s={insert(f,y){t={action:0,path:[...e,f],value:y}},push(f){t={action:0,dyn:!0,path:e,value:f}},update(f){t={action:1,path:e,value:f}},delete(){t={action:2,path:e}},pop(){t={action:2,dyn:!0,path:e}}},o=f=>{if(typeof f=="symbol")return f;let y=parseInt(f);return isNaN(y)?f:y},l={get(f,y){e[e.length-2]===n&&e.splice(e.length-2,1);let p=f[y];if(p===void 0)return e.push(o(y)),c;if(typeof p=="function")return r===!0?(r=!1,Reflect.get(f,y)):(e.push(n),e.push(y),c);throw"an unknown error occured"},set(f,y,p){return t={action:1,path:[...e,o(y)],value:p},!0}},c=new Proxy(s,l),d={},w=i(c);for(let[f,y]of Object.entries(w)){let p={};for(let b=0;b<y.length;b++)p[Symbol(b)]=b;let I=Reflect.ownKeys(p);try{y(...I)}catch{if(e[e.length-2]===n){r=!0;try{e=[],y(...I)}catch(k){throw console.log(e,k),"failed to set actions in here"}}else throw"failed to set actions"}let A=Array(I.length).fill(null),U=0;for(let b of t.path){if(typeof b!="symbol"){U+=1;continue}let k=p[b];if(k===void 0){U+=1;continue}A[k]===null?A[k]=[U]:A[k].push(U),U+=1}if(typeof t.value=="symbol"&&p[t.value]!==void 0){let b=p[t.value];A[b]===null?A[b]=["_val"]:A[b].push("_val"),t.value=null}t.path=t.path.map(b=>typeof b=="symbol"?null:b),d[f]={...t,args:A},e=[],r=!1,t={}}return d}var F=class{#t;#e;constructor(e,t){this.key=t,this.#t=e,this.#e=e.getClient(),this.handlers={insert:void 0,delete:void 0,replace:void 0},this.#t._handlers[0][t]=this}insert(e,t){this.handlers.insert?.(e,t,{isLocal:!0});try{let n=this.#e.text_insert(this.key,e,t);this.#n(n)}catch(n){console.error("insert failed silently",n)}}replace(e,t,n=0){if(this.handlers.replace?.([{index:e,length:n}],e,t,{isLocal:!0}),!(t.length===0&&n===0))try{let r=this.#e.text_replace(this.key,e,t,n);this.#n(r)}catch(r){console.error("replace failed with",r)}}delete(e,t){this.handlers.delete?.([{index:e,length:t}],{isLocal:!0});try{let n=this.#e.text_delete(this.key,e,t);this.#n(n)}catch{console.error("delete failed silently")}}value(){return this.#e.query_text(this.key)}#n(e){this.#t.innerSend(e)}__remotes(e,t){if(e[0]===0)this.handlers.insert?.(e[2],e[3],{userId:t});else if(e[0]===1){let n=[];for(let r=2;r<e.length;r+=2)n.push({index:e[r],length:e[r+1]});this.handlers.delete?.(n,{userId:t})}else if(e[0]===3){let n=e[2],r=e[3],s=[];for(let o=4;o<e.length;o+=2)s.push({index:e[o],length:e[o+1]});this.handlers.replace?this.handlers.replace(s,n,r,{userId:t}):(this.handlers.delete?.(s,{userId:t}),this.handlers.insert?.(n,r,{userId:t}))}}};var N=class{#t;#e;#n;constructor(e,t){this.key=t,this.#t=e,this.#e=e.getClient(),this.handlers={update:void 0},this.#n=0,this.value(),this.#t._handlers[1][t]=this.#s}increment(){this.#n+=1,this.handlers.update?.(this.#n,{isLocal:!0});try{let e=this.#e.counter_update(this.key,1);this.#i(e)}catch(e){console.error("failed to update counter silently",e)}}decrement(){this.#n-=1,this.handlers.update?.(this.#n,{isLocal:!0});try{let e=this.#e.counter_update(this.key,-1);this.#i(e)}catch(e){console.error("failed to update counter silently",e)}}value(){let e=this.#e.query_counter(this.key);return this.#n=e??0,e}#i(e){this.#t.innerSend(e)}#s(e,t){let n=e[2];n!==void 0&&(this.#n=n,this.handlers.update?.(n,{userId:t}))}};var O=class{#t;constructor(e){this.#t=e}text(e){return new F(this.#t,e)}counter(e){return new N(this.#t,e)}tree(e){return new j(this.#t,e)}};var ce=221,$=class{#t;#e;#n;constructor(e,t){this.#t=e,this.#n=new S,this.wasmUrl=t,this.offline=!1,this._handlers=[{},{},{}]}changeContext(){return new O(this)}async __loadWasm(){this.wasmUrl||console.log("wasm url is not set using default `colab.wasm`, ensure you serve it");try{return await X(this.wasmUrl||"colab.wasm"),this}catch(e){throw{err:e,ctx:"error loading wasm binary"}}}async createOrJoin(e,t){try{await this.create(e,t)}catch(n){if(n.error==="Exists")await this.join(e);else throw n}return{status:!0}}async load(e){this.stateId=e;try{let t=await this.#r(3);return this.#i(t),{status:!0}}catch(t){throw t}}presence(e){this.#r(4,e,!1)}on(e,t){this.#n.on(e,t)}getClient(){return this.#e}async innerSend(e){if(e)try{let t=await this.#r(1,e);this.#e?.consume(new Uint8Array(t))}catch(t){console.error("fail to send change",t)}}async toggleOffline(){try{let e=this.#e?.is_offline(),t;if(e?(this.offline=!1,t=this.#e?.toggle_offline(!1)):(this.offline=!0,t=this.#e?.toggle_offline(!0)),t){let n=await this.#r(7,t,!0),r=this.#e?.consume_batch(new Uint8Array(n));if(!r)return;this.#l(r,"sync")}}catch(e){console.log("error processing batch offline updates",e)}}#i(e){let t=new DataView(e.slice(0,4)).getUint32(0,!0);this.#e=new R(t);let n=new Uint8Array(e.slice(4));this.#e.load(n),this.#o()}async#s(e){try{let t=await this.#r(5,e);if(t.status)return t.status;throw t}catch(t){throw t}}#c(e){let t=new T(e),n=t.geti64(),r=t.getU32(),s=t.getU8(),o=t.getFixedSeq(s),l=t.asString(o),c=t.getRest();return{eventId:n,seq:r,sender:l,payload:c}}#o(){this.#t.subscribe(ce,async e=>{let t=new T(e);t.getString()===this.stateId&&await this.#u(t)})}async#u(e){if(!this.#e)return;let t=e.getU8(),n=e.getSeq();if(t===1){if(this.#e.is_offline()){console.log("colab is offline");return}let r=this.#c(n),{eventId:s,seq:o,payload:l,sender:c}=r;try{let d=this.#e.apply(o,s,new Uint8Array(l));this.#d(d,c)}catch(d){console.error("failed to apply a remote event",d)}}else if(t===2){let r=new TextDecoder().decode(n);r=JSON.parse(r);let s;try{let o=JSON.parse(r.data);s={userId:r.userId,data:o,type:"object"}}catch{s={userId:r.userId,data:n,type:"binary"}}this.#n.dispatch("presence",s)}else if(t===0){let r=new TextDecoder().decode(n);r=JSON.parse(r);let s={users:r.users,sender:r.sender},o=`user:${r.action}`;this.#n.dispatch(o,s)}else if(t===4){let r=new TextDecoder().decode(n);r=JSON.parse(r),this.#n.dispatch("cnl:delete",r)}else if(t===3){let r=new TextDecoder().decode(n);r=JSON.parse(r),this.#n.dispatch("cnl:config",r)}}#a(e,t){this.#r(6,e).then(n=>{if(!this.#e)return;let r=this.#e.patch(t,new Uint8Array(n.slice(4)));this.#d(r,"_")}).catch(n=>{console.error("failed to pull missing events, retry after 1s...",n)})}_emit_local_change(e){this.#n.dispatch("change",{...e,userId:"__local"})}#d(e,t){let n=e[0];if(n!==0){if(n===1){let r=e[1];r&&this.#l([r],t)}else if(n===2){let r=e[1];this.#a(r,e[2])}else if(n===3){let r=e[1];this.#l(r,t);let s=e[2];s&&this.#a(s,e[3])}else if(n!==4){if(n===5){let r=e[1];this.#l(r,t)}}}}static pluginId(){return"collab"}async#r(e,t,n=!0){if(!this.stateId)throw{error:"INVALID_STATE_ID",message:"ensure state is initialiazed correctly"};let r;if(C(t,"Undefined"))r=new Uint8Array;else if(C(t,"Boolean"))r=new Uint8Array([Number(t)]);else if(C(t,"String"))r=new TextEncoder().encode(t);else if(C(t,"Uint8Array"))r=t;else{let o=JSON.stringify(t);r=new TextEncoder().encode(o)}let s=new Uint8Array([...J(this.stateId.length),...new TextEncoder().encode(this.stateId),...J(r.byteLength),...r]);return this.#t.send(3,e,s,n)}#l(e,t){for(let n of e){let r,s,o=n[0];typeof o=="number"?(r=n[1],s=o===2?1:0):(r=o,s=2);let l=this._handlers[s];l&&(l=l[r],l&&l.__remotes&&l.__remotes(n,t))}}async create(e,t){this.stateId=e;try{let{cid:n}=await this.#r(0);return this.#e=new R(n),t&&this.configure(t),this.#o(),{status:!0}}catch(n){throw n}}async join(e){this.stateId=e;try{let t=await this.#r(2);return this.#i(t),{status:!0}}catch(t){throw t}}async leave(){try{return await this.#r(11),{status:!0}}catch(e){throw e}}delete(e){return this.#r(9,e)}async addUsers(e){if(!e.length)return{status:!1};let t={ty:"add",data:{users:e}};try{return{status:await this.#s(t)}}catch(n){throw n}}async delUsers(e){if(!e.length)return{status:!1};let t={ty:"remove",data:{users:e}};try{return{status:await this.#s(t)}}catch(n){throw n}}async modUsers(e){if(!e.length)return{status:!1};let t={ty:"moderate",data:{mode:e[0].mode,users:e}};try{return{status:await this.#s(t)}}catch(n){throw n}}async getUsers(){try{return(await this.#r(8,!0)).map(t=>t)}catch(e){throw e}}async configure(e){if(!e.defaultPermission)return{status:!1};try{return await this.#r(10,{default_mode:e.defaultPermission,user_events:[],add:!1}),{status:!0}}catch(t){throw t}}};export{$ as default};
