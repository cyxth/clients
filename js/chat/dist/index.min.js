var N=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var c=(r,e,t)=>(N(r,e,"read from private field"),t?t.call(r):e.get(r)),f=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},g=(r,e,t,n)=>(N(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t);var _=(r,e,t)=>(N(r,e,"access private method"),t);var b=class{constructor(){this.callbacks={}}on(e,t){this.callbacks[e]=t}dispatch(e,t){let n=this.callbacks[e];n&&n(t)}off(e){this.callbacks[e]&&delete this.callbacks[e]}clearAllEvents(){this.callbacks={}}cleaEvents(e){e.forEach(t=>{this.off(t)})}};var j=(r=21)=>{let e="1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",t=e.length,n=[];for(let s=0;s<r;s++)n.push(e[Math.round(Math.random()*100)%t]);return n.join("")},F=(r,e)=>{let t=r.reduce((n,s)=>n.set(s[e],[...n.get(s[e])||[],s]),new Map);return Object.fromEntries(t)},U=r=>{try{return JSON.parse(r)}catch{return null}},E=r=>{let e={hour:"numeric",minute:"numeric"},t=new Date(Number(BigInt(r)>>22n));return{date:t,time:t.toLocaleTimeString("en-US",e)}};var p,x,O,Y,R=class{constructor(e){f(this,O);f(this,p,void 0);f(this,x,void 0);g(this,p,e),this.eventEmmiter=new b,g(this,x,[]),_(this,O,Y).call(this)}onOpen(){for(this.eventEmmiter.dispatch("transportReady",{});c(this,x).length>0;){let e=c(this,x).pop();e&&c(this,p).send(e)}}waitOpen(){return new Promise((t,n)=>{let s="transportReady",i=setTimeout(()=>{this.eventEmmiter.off(s),n(new Error("ConnectionTimeout"))},1e4);this.eventEmmiter.on(s,()=>{this.eventEmmiter.off(s),clearTimeout(i),t(!0)})})}onClose(){}onError(e){console.error("transport disconected")}onMessage(e){let t=new A(e.data).parse();if(t?.type==="message")this.eventEmmiter.dispatch("message",t.data);else if(t?.type==="reply"){if(t.reply){let{channel_trail:n,data_back:s}=t.reply;this.eventEmmiter.dispatch(`reply:${n}`,s)}}else if(t?.type==="error"){let{command:n,data:s}=t.data;this.eventEmmiter.dispatch(n,s)}else{let{command:n,data:s}=t.data;this.eventEmmiter.dispatch(n,s)}}send(e){let n=new TextEncoder().encode(e);c(this,p).readyState!==1?(console.log("[info] message queued while connecting"),c(this,x).push(n)):c(this,p).send(n)}cend(e,t){let n=JSON.stringify(t),s=j(12),i=`#${e}\r
@${s}\r
$${n.length}\r
${n}\r
`;return this.send(i),this.sendPromise(`${e}:${s}`,1e4)}sendm(e,t){let n=j(12),s=this.replaceEmoji(t.text);t.media&&(s+=`\r	${JSON.stringify(t.media)}`);let i=`>${e}\r
@${n}\r
$${s.length}\r
${s}\r
`;return this.send(i),this.sendPromise(`reply:${e}:${n}`,1e4)}replaceEmoji(e){let t=/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/g;return e.replace(t,function(n,s,i){return`:u+${i.codePointAt(s).toString(16)}`})}sendPromise(e,t=0){return new Promise((s,i)=>{let o=setTimeout(()=>{},0);t>0&&(o=setTimeout(()=>{this.eventEmmiter.off(e),i(new Error("Timeout"))},t)),this.eventEmmiter.on(e,l=>{this.eventEmmiter.off(e),clearTimeout(o);let a=JSON.parse(l);a.error&&i(new Error(a.error)),s(a)})})}on(e,t){this.eventEmmiter.on(e,t)}disconnect(){c(this,p).close()}};p=new WeakMap,x=new WeakMap,O=new WeakSet,Y=function(){c(this,p).binaryType="arraybuffer",c(this,p).onmessage=e=>this.onMessage(e),c(this,p).onerror=e=>this.onError(e),c(this,p).onclose=()=>this.onClose(),c(this,p).onopen=()=>this.onOpen()};var A=class{constructor(e){this.raw=e,this.data=new DataView(e),this.position=0,this.len=this.data.byteLength,this.remaining=this.data.byteLength}parse(){switch(this.getU8()){case"-":{let t={},n=this.getLine(),s=this.parse();if(s?.data)t.data={info:JSON.parse(s.data)};else return null;return{type:"error",data:t}}case">":{let t={},s=this.getLine().split(":");if(s.length!=2||(t.channel=s[0],t.sender=s[1],this.getU8()!=="@"))return null;let o=this.getLine();t.message_id=o;let l=this.parse();if(l?.data)typeof l.data=="string"&&(t.text=l.data);else return null;return{type:"message",data:t}}case"#":{let t={},n=this.getLine();t.command=n;let s=this.parse();if(s?.data)t.data=s.data;else return null;return{type:"command",data:t}}case"<":{let t={},n=this.getLine();t.channel_trail=n;let s=this.parse();if(s?.data)typeof s.data=="string"&&(t.data_back=s.data);else return null;return{type:"reply",reply:t}}case"$":{let t=parseInt(this.getLine());if(isNaN(t))return null;let n=t+2;return this.remaining<n?null:{data:this.getLine()}}}return null}getU8(){if(!this.len)return 0;let e=this.data.getUint8(this.position);return this.position+=1,String.fromCodePoint(e)}getLine(){let e=this.position,t=this.len-1,n="";for(let s=e;s<=t;s++){let i=o=>String.fromCodePoint(this.data.getUint8(o));if(n+=String.fromCodePoint(this.data.getUint8(s)),i(s)==="\r"&&i(s+1)===`
`)return this.position=s+2,n.substring(0,n.length-1)}return n}},V=R;var D=class{static enqueue(e){return new Promise((t,n)=>{this.queue.push({promise:e,resolve:t,reject:n}),this.dequeue()})}static dequeue(){if(this.workingOnPromise)return!1;if(this.stop){this.queue=[],this.stop=!1;return}let e=this.queue.shift();if(!e)return!1;try{this.workingOnPromise=!0,e.promise().then(t=>{this.workingOnPromise=!1,e.resolve(t),this.dequeue()}).catch(t=>{this.workingOnPromise=!1,e.reject(t),this.dequeue()})}catch(t){this.workingOnPromise=!1,e.reject(t),this.dequeue()}return!0}};D.queue=[],D.pendingPromise=!1,D.stop=!1;var le=(r,e)=>e.some(t=>r instanceof t),Z,ee;function de(){return Z||(Z=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function ue(){return ee||(ee=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var te=new WeakMap,W=new WeakMap,ne=new WeakMap,J=new WeakMap,z=new WeakMap;function he(r){let e=new Promise((t,n)=>{let s=()=>{r.removeEventListener("success",i),r.removeEventListener("error",o)},i=()=>{t(y(r.result)),s()},o=()=>{n(r.error),s()};r.addEventListener("success",i),r.addEventListener("error",o)});return e.then(t=>{t instanceof IDBCursor&&te.set(t,r)}).catch(()=>{}),z.set(e,r),e}function me(r){if(W.has(r))return;let e=new Promise((t,n)=>{let s=()=>{r.removeEventListener("complete",i),r.removeEventListener("error",o),r.removeEventListener("abort",o)},i=()=>{t(),s()},o=()=>{n(r.error||new DOMException("AbortError","AbortError")),s()};r.addEventListener("complete",i),r.addEventListener("error",o),r.addEventListener("abort",o)});W.set(r,e)}var q={get(r,e,t){if(r instanceof IDBTransaction){if(e==="done")return W.get(r);if(e==="objectStoreNames")return r.objectStoreNames||ne.get(r);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return y(r[e])},set(r,e,t){return r[e]=t,!0},has(r,e){return r instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in r}};function re(r){q=r(q)}function fe(r){return r===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){let n=r.call(B(this),e,...t);return ne.set(n,e.sort?e.sort():[e]),y(n)}:ue().includes(r)?function(...e){return r.apply(B(this),e),y(te.get(this))}:function(...e){return y(r.apply(B(this),e))}}function pe(r){return typeof r=="function"?fe(r):(r instanceof IDBTransaction&&me(r),le(r,de())?new Proxy(r,q):r)}function y(r){if(r instanceof IDBRequest)return he(r);if(J.has(r))return J.get(r);let e=pe(r);return e!==r&&(J.set(r,e),z.set(e,r)),e}var B=r=>z.get(r);function ie(r,e,{blocked:t,upgrade:n,blocking:s,terminated:i}={}){let o=indexedDB.open(r,e),l=y(o);return n&&o.addEventListener("upgradeneeded",a=>{n(y(o.result),a.oldVersion,a.newVersion,y(o.transaction),a)}),t&&o.addEventListener("blocked",a=>t(a.oldVersion,a.newVersion,a)),l.then(a=>{i&&a.addEventListener("close",()=>i()),s&&a.addEventListener("versionchange",u=>s(u.oldVersion,u.newVersion,u))}).catch(()=>{}),l}var ge=["get","getKey","getAll","getAllKeys","count"],ye=["put","add","delete","clear"],G=new Map;function se(r,e){if(!(r instanceof IDBDatabase&&!(e in r)&&typeof e=="string"))return;if(G.get(e))return G.get(e);let t=e.replace(/FromIndex$/,""),n=e!==t,s=ye.includes(t);if(!(t in(n?IDBIndex:IDBObjectStore).prototype)||!(s||ge.includes(t)))return;let i=async function(o,...l){let a=this.transaction(o,s?"readwrite":"readonly"),u=a.store;return n&&(u=u.index(l.shift())),(await Promise.all([u[t](...l),s&&a.done]))[0]};return G.set(e,i),i}re(r=>({...r,get:(e,t,n)=>se(e,t)||r.get(e,t,n),has:(e,t)=>!!se(e,t)||r.has(e,t)}));var M=class{constructor(){this.initDb()}async initDb(){this.db=await ie("cyx_rt",1,{upgrade(e){let t=e.createObjectStore("messages",{keyPath:"id"});t.createIndex("id","id"),t.createIndex("channel_id","channel_id"),e.createObjectStore("__cyxth")}})}async add(e,t){await this.db?.add(e,t)}async addMany(e,t){let n=this.db?.transaction(e,"readwrite");t=t.map(s=>n?.store.add(s)),t.push(n?.done),await Promise.all(t)}};var oe=async(r,e,t)=>{let n=`https://${r}/authorize`;return new Promise((i,o)=>{fetch(n,{method:"POST",headers:{"Content-Type":"application/json",accept:"application/json"},body:JSON.stringify({token:e,code_challenge:t})}).then(l=>l.json()).then(l=>l.error?o(l):i(l)).catch(l=>o({error:"FetchError",code:"ERR_FETCH",message:l}))})},ae=async(r,e,t)=>{let n=`wss://${r}/rt/?token=${e}&code_verifier=${t}`;return new Promise((s,i)=>{try{let o=new WebSocket(n);s(o)}catch{i({error:"ConnectError",code:"ERR_WS_CONNECT",message:"error initiating a connection with cyxth"})}})};var w,d,C,v,T,L,ce,H=class{constructor(e,t={}){f(this,v);f(this,L);f(this,w,void 0);f(this,d,void 0);f(this,C,void 0);this.appUrl=e,this.connected=!1,g(this,w,new b),g(this,d,null),this.options=t,this.options.offline===!0&&g(this,C,new M)}async connect(e){return new Promise(async(n,s)=>{let{token:i,code_challenge:o,code_verifier:l}=e;try{let a=await oe(this.appUrl,i,o),u=await ae(this.appUrl,a.token_string,l);g(this,d,new V(u))}catch(a){return s(a)}return c(this,d).on("message",a=>{let u=_(this,v,T).call(this,a.text),h=E(a.message_id),P={channel_id:a.channel,sender_id:a.sender,text:u.text,date:h.time,rdate:h.date,id:a.message_id};u.media&&(P.media=u.media),c(this,w).dispatch("message",P),this.options.offline&&c(this,C).add("messages",P)}),c(this,d).on("newcall",a=>{if(!this.options.calls)return console.error("Got new call, but calls are not enabled."),"";let u=JSON.parse(a);c(this,d)&&c(this,w).dispatch("call",{channel:u.channel,request:new K(c(this,d),u.channel,this.options.calls)})}),c(this,d).on("notify",a=>{a=JSON.parse(a);let u=E(a.message_id);c(this,w).dispatch("activity",{channel_id:a.channel_id,id:a.message_id,date:u.time,rdate:u.date,info:a.info})}),this.connected=!0,n(c(this,d).waitOpen())})}disconnect(){return c(this,d)?.disconnect(),this.connected=!1,c(this,w).clearAllEvents(),!0}on(e,t){c(this,w).on(e,t)}async createChannel(e){return c(this,d)?.cend("channel:create",e)}async joinChannel(e){return c(this,d)?.cend("channel:join",e)}async leaveChannel(e){return c(this,d)?.cend("channel:leave",e)}async listChannels(e){return e||(e={}),c(this,d)?.cend("channel:list",e)}async getChannels(e){return e||(e={}),c(this,d)?.cend("channel:get",e)}async loadChannels(e,t){return new Promise((n,s)=>{c(this,d)?.cend("channel:state",{channel_ids:[],date:e.toISOString(),duration:t}).then(i=>{i.error&&s(i.error);let o=i.messages.map(l=>{let a=_(this,v,T).call(this,l.content),u=E(l.message_id),h={sender_id:l.sender_id,text:a.text,date:u.time,rdate:u.date,channel_id:l.channel_id,id:l.message_id};return a.media&&(h.media=a.media),h});this.options.offline&&c(this,C).addMany("messages",o),n(F(o,"channel_id"))}).catch(i=>{s(i)})})}async getChannel(e){return c(this,d)?.cend("channel:info",e)}async usersInChannel(e){return c(this,d)?.cend("channel:users",{channel:e})}async deleteChannel(e){return c(this,d)?.cend("channel:delete",e)}async updateChannel(e){return c(this,d)?.cend("channel:update",e)}async inviteUser(e,t){let n=[];return typeof t=="string"&&(t=[t]),n=[...t],c(this,d)?.cend("channel:add",{channel_id:e,user_ids:n})}async removeUser(e,t){let n=[];return typeof t=="string"&&(t=[t]),n=[...t],c(this,d)?.cend("channel:remove",{channel_id:e,user_ids:n})}async moderateUsers(e,t){let n=[];return typeof t.users=="string"?n=[t.users]:n=t.users,c(this,d)?.cend("channel:moderate",{channel_id:e,mode:t.mode,users:n})}async getMessages(e,t,n=100){return new Promise((s,i)=>{if(typeof t=="string")try{t=E(t).date}catch{i("invalid start id")}c(this,d)?.cend("channel:messages",{channel:e,start:t,limit:n}).then(o=>{o.error&&i(o.error);let l=o.messages.map(a=>{let u=_(this,v,T).call(this,a.content),h=E(a.message_id),P={sender_id:a.sender_id,text:u.text,date:h.time,rdate:h.date,channel_id:a.channel_id,id:a.message_id};return u.media&&(P.media=u.media),P});this.options.offline&&c(this,C).addMany("messages",l),l=l.filter(a=>a.sender_id!=="_"),s(l)}).catch(o=>{i(o)})})}async sendMessage(e,t,n){return new Promise(async(i,o)=>{if(t.media&&t.media.length){let a={};for(let m of t.media)a[m.name]=m;let u=Object.values(a).map(m=>({name:m.name,ftype:m.type,size:m.size})),h=await c(this,d)?.cend("files:urls",u).then(m=>m).catch(m=>({error:m}));if(h.error)return o(h);console.log(h);let P=n?.progressHandler,Q=[];for(let m of h.urls){let X=await be(a[m.original_name],m.upload_url,P).then($=>$).catch($=>({error:$}));if(X.error)return o(X);Q.push(`${h.root}${m.new_name}`)}t.media.images=Q}let l=await c(this,d)?.sendm(e,t).then(a=>a).catch(a=>({error:a}));return l.error?o(l):i(l)})}async editMessage(e,t,n){return c(this,d)?.cend("message:edit",{channel_id:e,id:t,content:n})}async deleteMessage(e,t,n=!0){let s="";return n&&(s="soft"),c(this,d)?.cend("message:delete",{channel_id:e,id:t,content:s})}startCall(e,t){return new Promise((s,i)=>{if(this.options.calls)if(c(this,d)){let o=this.options.calls,l=new o(c(this,d),e);l.start(t),s(l)}else i("cyxth transport disconnected");else i("enable calls in options to use this functions")})}};w=new WeakMap,d=new WeakMap,C=new WeakMap,v=new WeakSet,T=function(e){e=_(this,L,ce).call(this,e);let t={},n=e.split("\r	");if(t.text=n[0],n[1]){let s=U(n[1]);s&&(t.media=s)}return n[2]&&(t.meta=n[2]),t},L=new WeakSet,ce=function(e){let t=/(?::u\+)\w+/g;return e.replace(t,function(n,s,i){let o=parseInt(e.substring(s+3,s+8),16);return isNaN(o)?e.substring(s,s+8):String.fromCodePoint(o)})};var be=(r,e,t)=>{let n=new XMLHttpRequest;if(t){let i=new b;i.on("progress",t),n.upload.addEventListener("progress",o=>{i.dispatch("progress",{filename:"",progress:Math.round(o.loaded/o.total*100)})})}return new Promise((i,o)=>{n.open("PUT",e);let l=new FormData;l.append("file",r),n.send(l),n.addEventListener("abort",()=>{o({error:"arborted"})}),n.addEventListener("error",()=>{o({error:"errored"})}),n.addEventListener("load",()=>{i(n.response)})})},S,k,I,K=class{constructor(e,t,n){f(this,S,void 0);f(this,k,void 0);f(this,I,void 0);g(this,S,e),g(this,k,t),g(this,I,n)}accept(e){return new Promise((n,s)=>{let i=new(c(this,I))(c(this,S),c(this,k));i.join(e),n(i)})}reject(){console.log("call rejected")}};S=new WeakMap,k=new WeakMap,I=new WeakMap;export{H as default};
