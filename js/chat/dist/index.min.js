var N=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var a=(r,e,t)=>(N(r,e,"read from private field"),t?t.call(r):e.get(r)),m=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},p=(r,e,t,n)=>(N(r,e,"write to private field"),n?n.call(r,t):e.set(r,t),t);var w=(r,e,t)=>(N(r,e,"access private method"),t);var y=class{constructor(){this.callbacks={}}on(e,t){this.callbacks[e]=t}dispatch(e,t){let n=this.callbacks[e];n&&n(t)}off(e){this.callbacks[e]&&delete this.callbacks[e]}clearAllEvents(){this.callbacks={}}cleaEvents(e){e.forEach(t=>{this.off(t)})}};var j=(r=21)=>{let e="1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",t=e.length,n=[];for(let s=0;s<r;s++)n.push(e[Math.round(Math.random()*100)%t]);return n.join("")},F=(r,e)=>{let t=r.reduce((n,s)=>n.set(s[e],[...n.get(s[e])||[],s]),new Map);return Object.fromEntries(t)},R=r=>{try{return JSON.parse(r)}catch{return null}},_=r=>({date:new Date(Number(BigInt(r)>>22n))});var f,E,k,ee,U=class{constructor(e){m(this,k);m(this,f,void 0);m(this,E,void 0);p(this,f,e),this.eventEmmiter=new y,p(this,E,[]),w(this,k,ee).call(this)}onOpen(){for(this.eventEmmiter.dispatch("transportReady",{});a(this,E).length>0;){let e=a(this,E).pop();e&&a(this,f).send(e)}}waitOpen(){return new Promise((t,n)=>{let s="transportReady",i=setTimeout(()=>{this.eventEmmiter.off(s),n(new Error("ConnectionTimeout"))},1e4);this.eventEmmiter.on(s,()=>{this.eventEmmiter.off(s),clearTimeout(i),t(!0)})})}onClose(){}onError(e){console.error("transport disconected")}onMessage(e){let t=new A(e.data).parse();if(t?.type==="message")this.eventEmmiter.dispatch("message",t.data);else if(t?.type==="reply"){if(t.reply){let{channel_trail:n,data_back:s}=t.reply;this.eventEmmiter.dispatch(`reply:${n}`,s)}}else if(t?.type==="error"){let{command:n,data:s}=t.data;this.eventEmmiter.dispatch(n,s)}else{let{command:n,data:s}=t.data;this.eventEmmiter.dispatch(n,s)}}send(e){let n=new TextEncoder().encode(e);a(this,f).readyState!==1?(console.log("[info] message queued while connecting"),a(this,E).push(n)):a(this,f).send(n)}cend(e,t){let n=JSON.stringify(t),s=j(12),i=`#${e}\r
@${s}\r
$${n.length}\r
${n}\r
`;return this.send(i),this.sendPromise(`${e}:${s}`,1e4)}sendm(e,t){let n=j(12),s=this.replaceEmoji(t.text);t.media&&(s+=`\r	${JSON.stringify(t.media)}`);let i=`>${e}\r
@${n}\r
$${s.length}\r
${s}\r
`;return this.send(i),this.sendPromise(`reply:${e}:${n}`,1e4)}replaceEmoji(e){let t=/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/g;return e.replace(t,function(n,s,i){return`:u+${i.codePointAt(s).toString(16)}`})}sendPromise(e,t=0){return new Promise((s,i)=>{let o=setTimeout(()=>{},0);t>0&&(o=setTimeout(()=>{this.eventEmmiter.off(e),i(new Error("Timeout"))},t)),this.eventEmmiter.on(e,l=>{this.eventEmmiter.off(e),clearTimeout(o);let c=JSON.parse(l);c.error&&i(new Error(c.error)),s(c)})})}on(e,t){this.eventEmmiter.on(e,t)}disconnect(){a(this,f).close()}};f=new WeakMap,E=new WeakMap,k=new WeakSet,ee=function(){a(this,f).binaryType="arraybuffer",a(this,f).onmessage=e=>this.onMessage(e),a(this,f).onerror=e=>this.onError(e),a(this,f).onclose=()=>this.onClose(),a(this,f).onopen=()=>this.onOpen()};var A=class{constructor(e){this.raw=e,this.data=new DataView(e),this.position=0,this.len=this.data.byteLength,this.remaining=this.data.byteLength}parse(){switch(this.getU8()){case"-":{let t={},n=this.getLine(),s=this.parse();if(s?.data)t.data={info:JSON.parse(s.data)};else return null;return{type:"error",data:t}}case">":{let t={},s=this.getLine().split(":");if(s.length!=2||(t.channel=s[0],t.sender=s[1],this.getU8()!=="@"))return null;let o=this.getLine();t.message_id=o;let l=this.parse();if(l?.data)typeof l.data=="string"&&(t.text=l.data);else return null;return{type:"message",data:t}}case"#":{let t={},n=this.getLine();t.command=n;let s=this.parse();if(s?.data)t.data=s.data;else return null;return{type:"command",data:t}}case"<":{let t={},n=this.getLine();t.channel_trail=n;let s=this.parse();if(s?.data)typeof s.data=="string"&&(t.data_back=s.data);else return null;return{type:"reply",reply:t}}case"$":{let t=parseInt(this.getLine());if(isNaN(t))return null;let n=t+2;return this.remaining<n?null:{data:this.getLine()}}}return null}getU8(){if(!this.len)return 0;let e=this.data.getUint8(this.position);return this.position+=1,String.fromCodePoint(e)}getLine(){let e=this.position,t=this.len-1,n="";for(let s=e;s<=t;s++){let i=o=>String.fromCodePoint(this.data.getUint8(o));if(n+=String.fromCodePoint(this.data.getUint8(s)),i(s)==="\r"&&i(s+1)===`
`)return this.position=s+2,n.substring(0,n.length-1)}return n}},J=U;var C=class{static enqueue(e){return new Promise((t,n)=>{this.queue.push({promise:e,resolve:t,reject:n}),this.dequeue()})}static dequeue(){if(this.workingOnPromise)return!1;if(this.stop){this.queue=[],this.stop=!1;return}let e=this.queue.shift();if(!e)return!1;try{this.workingOnPromise=!0,e.promise().then(t=>{this.workingOnPromise=!1,e.resolve(t),this.dequeue()}).catch(t=>{this.workingOnPromise=!1,e.reject(t),this.dequeue()})}catch(t){this.workingOnPromise=!1,e.reject(t),this.dequeue()}return!0}};C.queue=[],C.pendingPromise=!1,C.stop=!1;var ue=(r,e)=>e.some(t=>r instanceof t),te,ne;function he(){return te||(te=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function me(){return ne||(ne=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var re=new WeakMap,W=new WeakMap,se=new WeakMap,V=new WeakMap,z=new WeakMap;function fe(r){let e=new Promise((t,n)=>{let s=()=>{r.removeEventListener("success",i),r.removeEventListener("error",o)},i=()=>{t(g(r.result)),s()},o=()=>{n(r.error),s()};r.addEventListener("success",i),r.addEventListener("error",o)});return e.then(t=>{t instanceof IDBCursor&&re.set(t,r)}).catch(()=>{}),z.set(e,r),e}function pe(r){if(W.has(r))return;let e=new Promise((t,n)=>{let s=()=>{r.removeEventListener("complete",i),r.removeEventListener("error",o),r.removeEventListener("abort",o)},i=()=>{t(),s()},o=()=>{n(r.error||new DOMException("AbortError","AbortError")),s()};r.addEventListener("complete",i),r.addEventListener("error",o),r.addEventListener("abort",o)});W.set(r,e)}var q={get(r,e,t){if(r instanceof IDBTransaction){if(e==="done")return W.get(r);if(e==="objectStoreNames")return r.objectStoreNames||se.get(r);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return g(r[e])},set(r,e,t){return r[e]=t,!0},has(r,e){return r instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in r}};function ie(r){q=r(q)}function ge(r){return r===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){let n=r.call(O(this),e,...t);return se.set(n,e.sort?e.sort():[e]),g(n)}:me().includes(r)?function(...e){return r.apply(O(this),e),g(re.get(this))}:function(...e){return g(r.apply(O(this),e))}}function ye(r){return typeof r=="function"?ge(r):(r instanceof IDBTransaction&&pe(r),ue(r,he())?new Proxy(r,q):r)}function g(r){if(r instanceof IDBRequest)return fe(r);if(V.has(r))return V.get(r);let e=ye(r);return e!==r&&(V.set(r,e),z.set(e,r)),e}var O=r=>z.get(r);function ae(r,e,{blocked:t,upgrade:n,blocking:s,terminated:i}={}){let o=indexedDB.open(r,e),l=g(o);return n&&o.addEventListener("upgradeneeded",c=>{n(g(o.result),c.oldVersion,c.newVersion,g(o.transaction),c)}),t&&o.addEventListener("blocked",c=>t(c.oldVersion,c.newVersion,c)),l.then(c=>{i&&c.addEventListener("close",()=>i()),s&&c.addEventListener("versionchange",u=>s(u.oldVersion,u.newVersion,u))}).catch(()=>{}),l}var be=["get","getKey","getAll","getAllKeys","count"],we=["put","add","delete","clear"],G=new Map;function oe(r,e){if(!(r instanceof IDBDatabase&&!(e in r)&&typeof e=="string"))return;if(G.get(e))return G.get(e);let t=e.replace(/FromIndex$/,""),n=e!==t,s=we.includes(t);if(!(t in(n?IDBIndex:IDBObjectStore).prototype)||!(s||be.includes(t)))return;let i=async function(o,...l){let c=this.transaction(o,s?"readwrite":"readonly"),u=c.store;return n&&(u=u.index(l.shift())),(await Promise.all([u[t](...l),s&&c.done]))[0]};return G.set(e,i),i}ie(r=>({...r,get:(e,t,n)=>oe(e,t)||r.get(e,t,n),has:(e,t)=>!!oe(e,t)||r.has(e,t)}));var v=class{constructor(){this.initDb()}async initDb(){this.db=await ae("cyx_rt",1,{upgrade(e){let t=e.createObjectStore("messages",{keyPath:"id"});t.createIndex("id","id"),t.createIndex("channel_id","channel_id"),e.createObjectStore("__cyxth")}})}async add(e,t){await this.db?.add(e,t)}async addMany(e,t){let n=this.db?.transaction(e,"readwrite");t=t.map(s=>n?.store.add(s)),t.push(n?.done),await Promise.all(t)}};var ce=async(r,e,t)=>{let n=`https://${r}/authorize`;return new Promise((i,o)=>{fetch(n,{method:"POST",headers:{"Content-Type":"application/json",accept:"application/json"},body:JSON.stringify({token:e,code_challenge:t})}).then(l=>l.json()).then(l=>l.error?o(l):i(l)).catch(l=>o({error:"FetchError",code:"ERR_FETCH",message:l}))})},le=async(r,e,t)=>{let n=`wss://${r}/rt/?token=${e}&code_verifier=${t}`;return new Promise((s,i)=>{try{let o=new WebSocket(n);s(o)}catch{i({error:"ConnectError",code:"ERR_WS_CONNECT",message:"error initiating a connection with cyxth"})}})};var b,d,B,D,K,x,Q,T,de,H=class{constructor(e,t={}){m(this,D);m(this,x);m(this,T);m(this,b,void 0);m(this,d,void 0);m(this,B,void 0);this.appUrl=e,this.connected=!1,p(this,b,new y),p(this,d,null),this.options=t,this.options.offline===!0&&p(this,B,new v)}async connect(e){return new Promise(async(n,s)=>{let{token:i,code_challenge:o,code_verifier:l}=e;try{let c=await ce(this.appUrl,i,o),u=await le(this.appUrl,c.token_string,l);p(this,d,new J(u))}catch(c){return s(c)}return a(this,d).on("message",c=>{let{date:u}=_(c.message_id),P=w(this,D,K).call(this,c.text),L={userId:c.sender,channelId:c.channel,messageId:c.message_id,content:P,timestamp:u,type:"message"};a(this,b).dispatch("message",L)}),a(this,d).on("newcall",c=>{if(!this.options.calls)return console.error("Got new call, but calls are not enabled."),"";let u=JSON.parse(c);a(this,d)&&a(this,b).dispatch("call",{channel:u.channel,request:new X(a(this,d),u.channel,this.options.calls)})}),a(this,d).on("notify",c=>{c=JSON.parse(c);let{date:u}=_(c.message_id);a(this,b).dispatch("activity",{channelId:c.channel_id,activityId:c.message_id,timestamp:u,info:c.info})}),this.connected=!0,n(a(this,d).waitOpen())})}disconnect(){return a(this,d)?.disconnect(),this.connected=!1,a(this,b).clearAllEvents(),!0}on(e,t){a(this,b).on(e,t)}async createChannel(e){return a(this,d)?.cend("channel:create",e)}async joinChannel(e){return a(this,d)?.cend("channel:join",e)}async leaveChannel(e){return a(this,d)?.cend("channel:leave",e)}async listChannels(e){return e||(e={}),a(this,d)?.cend("channel:list",e)}async getChannels(e){return e||(e={}),a(this,d)?.cend("channel:get",e)}async loadChannels(e,t){return new Promise((n,s)=>{a(this,d)?.cend("channel:state",{channel_ids:[],date:e.toISOString(),duration:t}).then(i=>{i.error&&s(i.error);let o=w(this,x,Q).call(this,i);n(F(o,"channelId"))}).catch(i=>{s(i)})})}async getChannel(e){return a(this,d)?.cend("channel:info",e)}async usersInChannel(e){return a(this,d)?.cend("channel:users",{channel:e})}async deleteChannel(e){return a(this,d)?.cend("channel:delete",e)}async updateChannel(e){return a(this,d)?.cend("channel:update",e)}async inviteUser(e,t){let n=[];return typeof t=="string"&&(t=[t]),n=[...t],a(this,d)?.cend("channel:add",{channel_id:e,user_ids:n})}async removeUser(e,t){let n=[];return typeof t=="string"&&(t=[t]),n=[...t],a(this,d)?.cend("channel:remove",{channel_id:e,user_ids:n})}async moderateUsers(e,t){let n=[];return typeof t.users=="string"?n=[t.users]:n=t.users,a(this,d)?.cend("channel:moderate",{channel_id:e,mode:t.mode,users:n})}async getMessages(e,t,n=100){return new Promise((s,i)=>{if(typeof t=="string")try{t=_(t).date}catch{i("invalid start id")}a(this,d)?.cend("channel:messages",{channel:e,start:t,limit:n}).then(o=>{o.error&&i(o.error);let l=w(this,x,Q).call(this,o);s(l)}).catch(o=>{i(o)})})}async send(e,t,n){return new Promise(async(i,o)=>{if(t.media&&t.media.length){let c={};for(let h of t.media)c[h.name]=h;let u=Object.values(c).map(h=>({name:h.name,ftype:h.type,size:h.size})),P=await a(this,d)?.cend("files:urls",u).then(h=>h).catch(h=>({error:h}));if(P.error)return o(P);console.log(P);let L=n?.progressHandler,Y=[];for(let h of P.urls){let Z=await Pe(c[h.original_name],h.upload_url,L).then($=>$).catch($=>({error:$}));if(Z.error)return o(Z);Y.push(`${P.root}${h.new_name}`)}t.media.images=Y}let l=await a(this,d)?.sendm(e,t).then(c=>c).catch(c=>({error:c}));return l.error?o(l):i(l)})}async editMessage(e,t,n){return a(this,d)?.cend("message:edit",{channel_id:e,id:t,content:n})}async deleteMessage(e,t,n=!0){let s="";return n&&(s="soft"),a(this,d)?.cend("message:delete",{channel_id:e,id:t,content:s})}startCall(e,t){return new Promise((s,i)=>{if(this.options.calls)if(a(this,d)){let o=this.options.calls,l=new o(a(this,d),e);l.start(t),s(l)}else i("cyxth transport disconnected");else i("enable calls in options to use this functions")})}};b=new WeakMap,d=new WeakMap,B=new WeakMap,D=new WeakSet,K=function(e){e=w(this,T,de).call(this,e);let t={},n=e.split("\r	");if(t.text=n[0],n[1]){let s=R(n[1]);s&&(t.media=s)}return n[2]&&(t.meta=n[2]),t},x=new WeakSet,Q=function(e){return e.messages.map(t=>{let n=w(this,D,K).call(this,t.content),{date:s}=_(t.message_id),i={userId:t.sender_id,channelId:t.channel_id,messageId:t.message_id,content:n,timestamp:s,type:"message"};return i.userId==="_"&&(i.type="activity",i.activity=JSON.parse(t.content),i.content={}),i})},T=new WeakSet,de=function(e){let t=/(?::u\+)\w+/g;return e.replace(t,function(n,s,i){let o=parseInt(e.substring(s+3,s+8),16);return isNaN(o)?e.substring(s,s+8):String.fromCodePoint(o)})};var Pe=(r,e,t)=>{let n=new XMLHttpRequest;if(t){let i=new y;i.on("progress",t),n.upload.addEventListener("progress",o=>{i.dispatch("progress",{filename:"",progress:Math.round(o.loaded/o.total*100)})})}return new Promise((i,o)=>{n.open("PUT",e);let l=new FormData;l.append("file",r),n.send(l),n.addEventListener("abort",()=>{o({error:"arborted"})}),n.addEventListener("error",()=>{o({error:"errored"})}),n.addEventListener("load",()=>{i(n.response)})})},I,S,M,X=class{constructor(e,t,n){m(this,I,void 0);m(this,S,void 0);m(this,M,void 0);p(this,I,e),p(this,S,t),p(this,M,n)}accept(e){return new Promise((n,s)=>{let i=new(a(this,M))(a(this,I),a(this,S));i.join(e),n(i)})}reject(){console.log("call rejected")}};I=new WeakMap,S=new WeakMap,M=new WeakMap;export{H as default};
